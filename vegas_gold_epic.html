<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Vegas Gold â€” Royal Edition</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-dark: #050505;
  --bg-panel: #0f1219;
  --gold-1: #bf953f;
  --gold-2: #fcf6ba;
  --gold-3: #b38728;
  --gold-4: #fbf5b7;
  --gold-5: #aa771c;
  --text-main: #f0f0f0;
  --text-muted: #a0a0a0;
  --danger: #ff4444;
  --success: #00C851;
  --accent-glow: rgba(191, 149, 63, 0.4);
  --font-heading: 'Cinzel', serif;
  --font-body: 'Lato', sans-serif;
}

* { box-sizing: border-box; }
html, body { height: 100%; overflow-x: hidden; }
body {
  margin: 0;
  background: var(--bg-dark);
  color: var(--text-main);
  font-family: var(--font-body);
}
a { color: inherit; text-decoration: none; transition: color 0.2s; }
a:hover { color: var(--gold-2); }
button { font: inherit; cursor: pointer; user-select: none; }
input, select { font: inherit; }

  /* --- CUSTOM SCROLLBAR --- */
  ::-webkit-scrollbar {
    width: 12px;
  }
  ::-webkit-scrollbar-track {
    background: #050505; 
    border-left: 1px solid #222;
    box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
  }
  ::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, var(--gold-3), var(--gold-1), var(--gold-3));
    border-radius: 6px;
    border: 2px solid #050505;
    box-shadow: inset 0 0 5px rgba(255,255,255,0.2);
  }
  ::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(180deg, var(--gold-2), var(--gold-4), var(--gold-2));
  }

  /* --- CUSTOM CLOSE BUTTON --- */
  .modal-close-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 36px;
    height: 36px;
    background: radial-gradient(circle, var(--gold-2), var(--gold-3));
    border: 2px solid var(--gold-5);
    border-radius: 50%;
    color: transparent;
    font-size: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    z-index: 100;
    padding: 0;
  }
  .modal-close-btn::before, .modal-close-btn::after {
    content: '';
    position: absolute;
    width: 18px;
    height: 3px;
    background-color: #2b1d00;
    border-radius: 2px;
    transition: background-color 0.3s;
  }
  .modal-close-btn::before {
    transform: rotate(45deg);
  }
  .modal-close-btn::after {
    transform: rotate(-45deg);
  }
  .modal-close-btn:hover {
    transform: rotate(90deg) scale(1.1);
    box-shadow: 0 0 20px rgba(191, 149, 63, 0.8);
    background: #fff;
    border-color: var(--gold-1);
  }
  .modal-close-btn:hover::before, .modal-close-btn:hover::after {
    background-color: #000;
  }
  .modal-close-btn:active {
    transform: scale(0.9);
  }

  /* --- BACKGROUND --- */
  #bg-canvas { 
    position: fixed; 
    top: 0; left: 0; 
    width: 100%; height: 100%; 
    z-index: -2; 
    pointer-events: none; 
    opacity: 0.8;
    filter: blur(8px);
  }
  
  /* --- LOADER --- */
  #loader {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 9999;
    /* Removed background image, simple dark background */
    background: #050505;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    transition: opacity 0.8s ease-out;
    perspective: 1000px;
    overflow: hidden;
  }
  
  /* Walk-in Animation */
  #loader.walk-in-active {
    animation: walk-into-casino 3.5s cubic-bezier(0.6, 0.05, 0.2, 1) forwards;
  }
  /* Optimize performance during animation */
  #loader.walk-in-active .loader-content {
    backdrop-filter: none;
    box-shadow: none;
  }
  
  @keyframes walk-into-casino {
    0% { transform: scale(1) translateZ(0); opacity: 1; }
    40% { transform: scale(1.2) translateZ(0); opacity: 1; }
    100% { transform: scale(8) translateZ(0); opacity: 0; }
  }

  /* Golden Lights / Flashed Effect - OPTIMIZED: Removed infinite loop for performance */
  .flash-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: #fff;
    opacity: 0;
    pointer-events: none;
    /* animation: camera-flash 5s infinite; REMOVED for lag */
    z-index: 10;
    mix-blend-mode: overlay;
    display: none; /* Hide by default */
  }

  /* BLACKJACK BUTTONS */
  .bj-action-btn {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    font-size: 20px;
    display: flex;
    justify-content: center;
    align-items: center;
    background: radial-gradient(circle, var(--gold-2) 0%, var(--gold-3) 100%);
    color: #2b1d00;
    border: 2px solid var(--gold-1);
    box-shadow: 0 0 15px rgba(191, 149, 63, 0.4);
    font-family: var(--font-heading);
    font-weight: 900;
    transition: all 0.2s;
    text-shadow: 0 1px 0 rgba(255,255,255,0.4);
  }
  .bj-action-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 0 25px rgba(191, 149, 63, 0.8);
    color: #000;
  }
  .bj-action-btn.stand {
    background: radial-gradient(circle, #d4af37 0%, #8a6e2f 100%); /* Darker Bronze/Gold */
    color: #fff;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    border-color: #8a6e2f;
  }

    .golden-beam {
      position: absolute;
      width: 200px; height: 1000px;
      background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.2), transparent); /* Reduced opacity */
      transform: rotate(45deg);
      /* animation: beam-sweep 6s infinite ease-in-out; REMOVED for lag */
      filter: blur(20px);
      pointer-events: none;
      display: none; /* Hide by default */
    }
  .beam-1 { top: -200px; left: -200px; animation-delay: 0s; }
  .beam-2 { top: -200px; right: -200px; transform: rotate(-45deg); animation-delay: 3s; }
  
  @keyframes beam-sweep {
    0% { opacity: 0; transform: rotate(45deg) translateY(0); }
    50% { opacity: 1; transform: rotate(45deg) translateY(200px); }
    100% { opacity: 0; transform: rotate(45deg) translateY(400px); }
  }

  .loader-content {
    position: relative;
    z-index: 20;
    text-align: center;
    /* Fancy look */
    background: rgba(0, 0, 0, 0.6);
    padding: 40px 60px;
    border: 2px solid var(--gold-2);
    border-radius: 20px;
    box-shadow: 0 0 50px rgba(191, 149, 63, 0.4), inset 0 0 50px rgba(0,0,0,0.8);
    backdrop-filter: blur(10px);
    animation: float 4s ease-in-out infinite;
  }

  .loader-btn {
    margin-top: 40px;
    padding: 15px 50px;
    font-size: 24px;
    background: rgba(0,0,0,0.6);
    color: var(--gold-2);
    border: 2px solid var(--gold-2);
    border-radius: 50px;
    font-family: var(--font-heading);
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 0 20px rgba(191, 149, 63, 0.2);
    backdrop-filter: blur(5px);
    text-transform: uppercase;
    letter-spacing: 3px;
  }
  .loader-btn:hover {
    background: var(--gold-2);
    color: #000;
    box-shadow: 0 0 50px rgba(191, 149, 63, 0.8);
    transform: scale(1.1);
  }

  /* --- ANIMATIONS --- */
  @keyframes spin { 100% { transform: translateY(-50%) rotate(360deg); } }
  @keyframes pulse-glow {
  0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
  50% { transform: scale(1.05); box-shadow: 0 0 20px 10px rgba(255, 215, 0, 0); }
  100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
}
@keyframes float {
  0% { transform: translateY(0px); }
  50% { transform: translateY(-10px); }
  100% { transform: translateY(0px); }
}
@keyframes shine {
  0% { background-position: -100px; }
  100% { background-position: 300px; }
}

/* --- LAYOUT --- */
/* Wheel Pointer */
.wheel-pointer {
  position: absolute;
  top: 50%;
  right: -20px;
  width: 50px;
  height: 50px;
  background: linear-gradient(135deg, #ffd700, #fff, #b8860b);
  background-size: 200% 200%;
  clip-path: polygon(100% 20%, 0 50%, 100% 80%);
  transform: translateY(-50%);
  filter: drop-shadow(-2px 2px 4px rgba(0,0,0,0.5));
  animation: goldShimmer 2s infinite linear;
  z-index: 10;
}
@keyframes goldShimmer {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* VIP Items */
.vip-item-card {
  border: 1px solid var(--gold-2);
  background: linear-gradient(45deg, #111, #220);
  padding: 15px;
  border-radius: 8px;
  text-align: center;
  transition: transform 0.2s;
  position: relative;
  overflow: hidden;
}
.vip-item-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(218, 165, 32, 0.2); }
.vip-tag {
  background: var(--gold-1);
  color: #000;
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: bold;
  position: absolute;
  top: 5px; right: 5px;
}

/* Frames */
.frame-gold { border: 2px solid #ffd700 !important; box-shadow: 0 0 10px #ffd700; }
.frame-diamond { border: 2px solid #b9f2ff !important; box-shadow: 0 0 10px #b9f2ff, inset 0 0 5px #b9f2ff; }
.frame-neon { border: 2px solid #ff00de !important; box-shadow: 0 0 10px #ff00de; }

/* Name Tags */
.tag-badge {
  display: inline-block;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 10px;
  margin-left: 5px;
  font-weight: bold;
  text-transform: uppercase;
}
.tag-high-roller { background: linear-gradient(45deg, #ffd700, #b8860b); color: #000; }
.tag-vip { background: #000; border: 1px solid #ffd700; color: #ffd700; }
.tag-whale { background: #3498db; color: #fff; }

/* Custom Backgrounds */
.bg-midnight { background: radial-gradient(circle at center, #0a0a2a, #000) !important; }
.bg-royal-red { background: radial-gradient(circle at center, #2a0a0a, #000) !important; }
.bg-cash-rain { background: radial-gradient(circle at center, #0a2a0a, #000) !important; }

.site-header {
  position: sticky;
  top: 0;
  z-index: 1000;
  background: transparent;
  /* backdrop-filter: blur(12px); Removed for performance */
  border-bottom: 1px solid rgba(191, 149, 63, 0.3);
  box-shadow: 0 4px 30px rgba(0,0,0,0.5);
}
.navbar {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;
  padding: 15px 30px;
  width: 100%;
  box-sizing: border-box;
}

.version-tag {
  position: absolute;
  top: 5px;
  right: 10px;
  color: var(--text-muted);
  font-size: 10px;
  opacity: 0.7;
  pointer-events: none;
  z-index: 1001;
  font-family: var(--font-body);
}

.brand {
  display: flex;
  align-items: center;
  gap: 15px;
}
.brand img {
  height: 50px;
  width: auto;
  filter: drop-shadow(0 0 5px var(--gold-3));
}

.nav-links {
  display: flex;
  gap: 20px;
  align-items: center;
}
.nav-item {
  position: relative;
  font-family: var(--font-heading);
  font-weight: 700;
  letter-spacing: 1px;
  color: var(--gold-2);
  background: none;
  border: none;
  padding: 10px;
  text-transform: uppercase;
  font-size: 14px;
}
.nav-item:hover {
  text-shadow: 0 0 10px var(--gold-1);
}

.dropdown-menu {
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%) translateY(10px);
  background: var(--bg-panel);
  border: 1px solid var(--gold-3);
  padding: 10px;
  border-radius: 8px;
  display: none;
  flex-direction: column;
  min-width: 180px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.8);
  opacity: 0;
  transition: opacity 0.2s, transform 0.2s;
}
.nav-item:hover .dropdown-menu, .nav-item:focus-within .dropdown-menu {
  display: flex;
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}
.dropdown-menu a {
  padding: 12px;
  border-bottom: 1px solid rgba(255,255,255,0.05);
  text-align: center;
}
.dropdown-menu a:last-child { border-bottom: none; }
.dropdown-menu a:hover { background: rgba(191, 149, 63, 0.1); color: var(--gold-2); }

.user-panel {
  display: flex;
  align-items: center;
  gap: 15px;
  justify-self: end;
}
.balance-display {
  background: linear-gradient(90deg, #2c2005, #000);
  border: 1px solid var(--gold-5);
  padding: 8px 16px;
  border-radius: 20px;
  color: var(--gold-2);
  font-family: var(--font-heading);
  font-weight: 700;
  box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
  display: flex;
  align-items: center;
  gap: 8px;
}
/* --- XP BAR ENHANCED --- */
.xp-bar-wrapper {
  position: relative;
  width: 140px;
  margin-left: 5px;
}
.xp-bar-container {
  width: 100%;
  height: 16px;
  background: rgba(0,0,0,0.6);
  border: 1px solid var(--gold-5);
  border-radius: 8px;
  overflow: visible;
  position: relative;
  box-shadow: inset 0 2px 5px rgba(0,0,0,0.8);
  transition: all 0.2s;
}
.xp-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--gold-5), var(--gold-2), var(--gold-1));
  background-size: 200% 100%;
  width: 0%;
  border-radius: 6px;
  transition: width 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  box-shadow: 0 0 10px rgba(191, 149, 63, 0.6);
  animation: xp-gradient-flow 2s infinite linear;
  position: relative;
}
.xp-bar-fill::after {
  content: '';
  position: absolute;
  top: 0; right: 0; bottom: 0;
  width: 2px;
  background: #fff;
  box-shadow: 0 0 10px #fff;
  opacity: 0.8;
}
.xp-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 10px;
  color: #fff;
  text-shadow: 0 1px 3px #000, 0 0 2px #000;
  z-index: 5;
  white-space: nowrap;
  font-weight: 700;
  pointer-events: none;
  font-family: var(--font-body);
}
@keyframes xp-gradient-flow {
  0% { background-position: 100% 0; }
  100% { background-position: -100% 0; }
}
@keyframes particle-float {
  0% { transform: translateY(0) scale(1); opacity: 1; }
  100% { transform: translateY(-20px) scale(0); opacity: 0; }
}
.xp-particle {
  position: absolute;
  pointer-events: none;
  width: 4px; height: 4px;
  background: var(--gold-2);
  border-radius: 50%;
  box-shadow: 0 0 5px var(--gold-1);
  animation: particle-float 1s ease-out forwards;
  z-index: 10;
}
/* Micro-interaction on hover */
.xp-bar-container:hover {
  border-color: var(--gold-2);
  box-shadow: 0 0 10px rgba(191, 149, 63, 0.3), inset 0 2px 5px rgba(0,0,0,0.8);
  transform: scale(1.02);
}
.xp-bar-container:hover .xp-bar-fill {
  filter: brightness(1.2);
}
.level-badge {
  width: 30px;
  height: 30px;
  background: var(--gold-1);
  color: #000;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 900;
  font-size: 12px;
  border: 2px solid var(--gold-2);
  box-shadow: 0 0 10px var(--gold-1);
}

.gold-btn {
  background: linear-gradient(to bottom, var(--gold-2) 0%, var(--gold-3) 100%);
  border: 1px solid var(--gold-5);
  color: #2b1d00;
  padding: 10px 24px;
  border-radius: 4px;
  font-family: var(--font-heading);
  font-weight: 900;
  text-transform: uppercase;
  letter-spacing: 1px;
  box-shadow: 0 4px 15px rgba(170, 119, 28, 0.3);
  transition: transform 0.1s, box-shadow 0.1s;
}
.gold-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(170, 119, 28, 0.5);
  background: linear-gradient(to bottom, #fff8d1 0%, #d4a034 100%);
}
.gold-btn:active { transform: translateY(0); }
.gold-btn.secondary {
  background: transparent;
  border: 1px solid var(--gold-3);
  color: var(--gold-2);
  box-shadow: none;
}
.gold-btn.secondary:hover {
  background: rgba(191, 149, 63, 0.1);
}

/* --- NEW HERO LAYOUT --- */
.version-tag {
  position: absolute;
  top: 5px;
  right: 10px;
  color: var(--text-muted);
  font-size: 10px;
  opacity: 0.7;
  pointer-events: none;
  z-index: 1001;
  font-family: var(--font-body);
}

.hero-layout {
  display: flex;
  flex-direction: column;
  align-items: center;
  max-width: 1200px;
  margin: 0 auto;
  min-height: 80vh;
  gap: 40px;
  padding-bottom: 50px;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  background: rgba(10, 10, 12, 0.7);
}

.left-menu, .right-menu {
  display: flex;
  flex-direction: column;
  gap: 15px;
  padding-top: 20px;
}

/* Accordion Styles */
.accordion-item {
  background: linear-gradient(145deg, rgba(20,20,20,0.8), rgba(10,10,10,0.9));
  border: 1px solid rgba(191, 149, 63, 0.2);
  border-radius: 8px;
  overflow: hidden;
  transition: all 0.3s;
}
.accordion-header {
  padding: 15px;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(255, 255, 255, 0.02);
  transition: background 0.2s;
}
.accordion-header:hover {
  background: rgba(255, 255, 255, 0.05);
}
.accordion-title {
  color: var(--gold-2);
  font-family: var(--font-heading);
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: 1px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.accordion-icon {
  font-size: 10px;
  transition: transform 0.3s;
  color: var(--gold-4);
}
.accordion-item.active .accordion-icon {
  transform: rotate(180deg);
}
.accordion-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
  background: rgba(0, 0, 0, 0.2);
}
.accordion-item.active .accordion-content {
  max-height: 600px;
  overflow-y: auto;
  border-top: 1px solid rgba(191, 149, 63, 0.1);
}
.accordion-inner {
  padding: 15px;
}

/* Old Menu Card Styles (can be removed later or kept for reference) */
.menu-card {
  background: linear-gradient(145deg, rgba(20,20,20,0.6), rgba(10,10,10,0.8));
  border: 1px solid rgba(191, 149, 63, 0.2);
  border-radius: 8px;
  padding: 15px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  position: relative;
  overflow: hidden;
  transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
  cursor: pointer;
}
.menu-card:hover {
  transform: translateX(5px);
  box-shadow: 0 4px 20px rgba(191, 149, 63, 0.15);
  border-color: var(--gold-3);
  background: linear-gradient(145deg, rgba(30,30,30,0.8), rgba(15,15,15,0.9));
}
.menu-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; width: 3px; height: 100%;
  background: linear-gradient(to bottom, var(--gold-2), var(--gold-5));
  opacity: 0.7;
  transition: width 0.3s;
}
.menu-card:hover::before {
  width: 5px;
  opacity: 1;
}

.menu-title {
  color: var(--gold-2);
  font-family: var(--font-heading);
  font-size: 16px;
  margin-bottom: 5px;
  display: flex;
  align-items: center;
  gap: 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
}
.menu-desc {
  color: var(--text-muted);
  font-size: 11px;
  line-height: 1.4;
  margin-bottom: 12px;
}

.menu-btn-sm {
  background: rgba(0,0,0,0.3);
  border: 1px solid rgba(191, 149, 63, 0.3);
  color: var(--gold-4);
  padding: 8px 16px;
  border-radius: 4px;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1px;
  width: 100%;
  transition: all 0.2s;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.menu-btn-sm:hover {
  background: var(--gold-2);
  color: #000;
  border-color: var(--gold-2);
}

/* Dropdown in Left Menu */
.left-dropdown {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease-out;
}
.menu-card.active .left-dropdown {
  max-height: 200px;
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid rgba(255,255,255,0.1);
}


.site-header {
  background: transparent;
  backdrop-filter: blur(20px);
  border-bottom: 1px solid rgba(191, 149, 63, 0.2);
  position: sticky; top: 0; z-index: 1000;
  box-shadow: 0 4px 30px rgba(0,0,0,0.6);
}
.navbar {
  padding: 0 40px;
  height: 70px; /* Reduced height */
  max-width: 1600px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.brand img {
  height: 40px; /* Smaller logo */
  width: auto;
  filter: drop-shadow(0 0 5px var(--gold-3));
  transition: transform 0.3s;
}
.brand:hover img { transform: scale(1.05); }

.nav-links { 
  display: flex; 
  gap: 20px; /* Tighter gap */
  height: 100%;
  align-items: center;
}
.nav-item {
  font-family: var(--font-heading);
  font-size: 13px; /* Slightly smaller text */
  letter-spacing: 1px;
  color: #aaa; /* Softer default color */
  transition: all 0.3s ease;
  padding: 8px 12px;
  border-radius: 4px;
  background: transparent;
  border: none;
  text-transform: uppercase;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  position: relative;
}
.nav-item:hover, .nav-item.active {
  color: var(--gold-2);
  background: rgba(191, 149, 63, 0.1);
  text-shadow: 0 0 10px rgba(191, 149, 63, 0.3);
}
.nav-item::after { display: none; } /* Remove underline effect for cleaner look */

.nav-icon { opacity: 0.7; font-size: 14px; }
.nav-item:hover .nav-icon { opacity: 1; }

/* Dropdown Menu Clean Up */
.dropdown-menu {
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%) translateY(10px);
  background: #111;
  border: 1px solid var(--gold-5);
  padding: 5px;
  border-radius: 6px;
  display: none;
  flex-direction: column;
  min-width: 160px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.9);
  opacity: 0;
  transition: all 0.2s;
  z-index: 100;
}
.nav-item:hover .dropdown-menu, .nav-item:focus-within .dropdown-menu {
  display: flex;
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}
.dropdown-menu a {
  padding: 10px 15px;
  border-bottom: 1px solid rgba(255,255,255,0.05);
  text-align: left;
  font-size: 12px;
  color: #ccc;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 8px;
}
.dropdown-menu a:last-child { border-bottom: none; }
.dropdown-menu a:hover { 
  background: rgba(191, 149, 63, 0.15); 
  color: var(--gold-2);
  padding-left: 20px; /* Slide effect */
}

/* VIP Button Special Style */
.nav-item.vip-btn {
  border: 1px solid var(--gold-4);
  color: var(--gold-2);
  box-shadow: 0 0 10px rgba(255, 215, 0, 0.1);
}
.nav-item.vip-btn:hover {
  background: var(--gold-2);
  color: #000;
  box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
}

/* User Panel Cleanup */
.user-panel {
  display: flex;
  align-items: center;
  gap: 20px;
}
.balance-display {
  background: rgba(0,0,0,0.4);
  padding: 5px 12px;
  border-radius: 20px;
  border: 1px solid rgba(255,255,255,0.1);
  font-family: var(--font-heading);
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 5px;
}
.level-badge-sm {
  width: 24px; height: 24px;
  background: var(--gold-2);
  color: #000;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-weight: bold;
  font-size: 10px;
  box-shadow: 0 0 10px var(--gold-3);
}


/* --- MAIN CONTENT --- */
.main {
  max-width: 1200px;
  margin: 40px auto;
  padding: 0 20px;
  min-height: 70vh;
}
.section { display: none; animation: fadeIn 0.5s ease-out; }
.section.active { display: block; }
@keyframes fadeIn { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }

.panel-box {
  background: rgba(15, 18, 25, 0.85);
  border: 1px solid var(--gold-5);
  border-radius: 12px;
  padding: 40px;
  box-shadow: 0 0 50px rgba(0,0,0,0.5), inset 0 0 100px rgba(0,0,0,0.5);
  position: relative;
  overflow: hidden;
}
.panel-box::before {
  content: "";
  position: absolute;
  top: 0; left: 0; right: 0; height: 2px;
  background: linear-gradient(90deg, transparent, var(--gold-2), transparent);
}

h1, h2, h3 { font-family: var(--font-heading); color: var(--gold-2); text-shadow: 0 2px 10px rgba(0,0,0,0.8); margin-top: 0; }

/* --- SLOTS --- */
.slot-frame {
  background: #111;
  padding: 20px;
  border-radius: 20px;
  border: 6px solid var(--gold-3);
  box-shadow: 
    0 0 0 2px #000,
    0 0 0 8px #5c4213,
    0 0 40px rgba(0,0,0,0.8),
    inset 0 0 60px rgba(0,0,0,0.9);
  max-width: 900px;
  margin: 0 auto;
  position: relative;
}
.reels-display {
  display: flex;
  gap: 15px;
  justify-content: center;
  background: #000;
  padding: 20px;
  border-radius: 10px;
  border: 2px solid #333;
  box-shadow: inset 0 0 30px #000;
}
.reel-col {
  width: 140px;
  height: 180px;
  background: linear-gradient(180deg, #050505 0%, #222 50%, #050505 100%);
  border: 2px solid var(--gold-5);
  border-radius: 8px;
  overflow: hidden;
  position: relative;
}
.reel-strip {
  width: 100%;
  /* We manipulate translateY via JS */
}
.symbol-box {
  height: 180px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.slot-icon { width: 100px; height: 100px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.7)); }

.slot-controls {
    margin-top: 40px;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 30px;
    background: linear-gradient(180deg, #111 0%, #222 100%);
    padding: 20px;
    border-radius: 10px;
    border-top: 2px solid #555;
    box-shadow: 0 10px 20px rgba(0,0,0,0.8);
    position: relative;
    z-index: 10;
  }
  .slot-controls::before, .slot-controls::after {
    content: ''; position: absolute; top: 50%; width: 10px; height: 10px;
    border-radius: 50%;
    background: #555;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.8);
    transform: translateY(-50%);
  }
  .slot-controls::before { left: 10px; }
  .slot-controls::after { right: 10px; }

  .slot-machine-modern.win-glow {
    animation: cabinet-glow 0.5s infinite alternate;
  }
  @keyframes cabinet-glow {
    from { box-shadow: 0 0 60px rgba(255, 215, 0, 0.2), inset 0 0 100px rgba(0,0,0,0.9); border-color: #d4af37; }
    to { box-shadow: 0 0 120px rgba(255, 215, 0, 0.8), inset 0 0 100px rgba(0,0,0,0.9); border-color: #fff; }
  }
/* BLACKJACK ENHANCEMENTS */
.bj-table {
  background: radial-gradient(circle at 50% 50%, #0d3815, #001a05);
  border: 15px solid #3d2b1f;
  border-radius: 20px;
  box-shadow: inset 0 0 100px #000, 0 20px 50px rgba(0,0,0,0.5);
  padding: 30px;
  position: relative;
  min-height: 400px;
}
.bj-table::before {
  content: "VEGAS GOLD";
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  font-family: var(--font-heading);
  font-size: 60px;
  color: rgba(255,255,255,0.03);
  pointer-events: none;
  font-weight: 900;
  white-space: nowrap;
}
.bj-card {
  width: 80px;
  height: 112px;
  margin: 0 5px;
  position: relative;
  perspective: 1000px;
  background: transparent;
  box-shadow: none;
  border: none;
}
.bj-card-inner {
  position: relative;
  width: 100%; height: 100%;
  text-align: center;
  transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  transform-style: preserve-3d;
  box-shadow: 0 4px 8px rgba(0,0,0,0.4);
  border-radius: 6px;
  transform: rotateY(180deg); /* Default Face Down */
}
.bj-card.flipped .bj-card-inner {
  transform: rotateY(0deg); /* Face Up */
}

/* Animation for dealing Face Down (e.g. Hole Card) */
.bj-card.deal-fly-in .bj-card-inner {
  animation: deal-fly-in 0.5s ease-out forwards;
}
@keyframes deal-fly-in {
  from { transform: translate(200px, -200px) rotateY(180deg) scale(0.5); opacity: 0; }
  to { transform: translate(0, 0) rotateY(180deg) scale(1); opacity: 1; }
}

/* Animation for dealing Face Up (Player cards) */
.bj-card.deal-fly-in-up .bj-card-inner {
  animation: deal-fly-in-up 0.6s ease-out forwards;
}
@keyframes deal-fly-in-up {
  0% { transform: translate(200px, -200px) rotateY(180deg) scale(0.5); opacity: 0; }
  60% { transform: translate(0, 0) rotateY(180deg) scale(1); opacity: 1; } /* Land then flip? Or flip in air? */
  100% { transform: translate(0, 0) rotateY(0deg) scale(1); opacity: 1; } /* Flip up */
}

.bj-card-front, .bj-card-back {
  position: absolute;
  width: 100%; height: 100%;
  -webkit-backface-visibility: hidden;
  backface-visibility: hidden;
  border-radius: 6px;
  top: 0; left: 0;
  overflow: hidden;
}
.bj-card-front {
  background: #fff;
  color: #000;
  transform: rotateY(0deg);
}
.bj-card-back {
  background: repeating-linear-gradient(45deg, #b8860b, #b8860b 5px, #8b0000 5px, #8b0000 10px);
  border: 3px solid #fff;
  transform: rotateY(180deg);
  box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
}
/* Deck on table */
.bj-deck {
  position: absolute;
  top: 20px; right: 20px;
  width: 80px; height: 112px;
  background: repeating-linear-gradient(45deg, #b8860b, #b8860b 5px, #8b0000 5px, #8b0000 10px);
  border: 3px solid #fff;
  border-radius: 6px;
  box-shadow: 
    1px 1px 0 #999,
    2px 2px 0 #999,
    3px 3px 0 #999,
    4px 4px 0 #999,
    5px 5px 0 #999,
    0 0 20px rgba(0,0,0,0.5);
  transform: rotate(-10deg);
}
.bj-suit-icon {
  width: 20px;
  height: 20px;
}
.bj-suit-center {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  width: 40px;
  height: 40px;
  opacity: 0.2;
}
.bj-chip {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  border: 5px dashed rgba(255,255,255,0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 900;
  font-size: 14px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.6), inset 0 5px 10px rgba(255,255,255,0.3);
  cursor: pointer;
  transition: transform 0.1s;
  position: relative;
}
.bj-chip:active { transform: scale(0.95); }
.bj-chip::after {
  content:''; position:absolute; top:0; left:0; right:0; bottom:0;
  border-radius:50%;
  border: 2px solid rgba(0,0,0,0.2);
}
.chip-10 { background: #3498db; color: #fff; }
.chip-50 { background: #e74c3c; color: #fff; }
.chip-100 { background: #2ecc71; color: #fff; }
.chip-500 { background: #111; color: #ffd700; border-color: #ffd700; }

.spin-btn-lg {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  /* Realistic Gold Look */
  background: radial-gradient(circle at 30% 30%, #fffbe3, #ffd700, #b8860b);
  border: 3px solid #ffd700;
  color: #5a3e00;
  font-family: var(--font-heading);
  font-weight: 900;
  font-size: 13px;
  letter-spacing: 1px;
  text-shadow: 0 1px 0 rgba(255,255,255,0.4);
  box-shadow: 
    0 0 20px rgba(255, 215, 0, 0.6),
    inset 0 5px 10px rgba(255,255,255,0.8),
    inset 0 -10px 20px rgba(0,0,0,0.2);
  transition: transform 0.1s, box-shadow 0.1s;
  position: relative;
  cursor: pointer;
  z-index: 10;
  animation: pulse-glow-intense 1.5s infinite alternate;
}
@keyframes pulse-glow-intense {
  from { box-shadow: 0 0 15px rgba(255, 215, 0, 0.5), inset 0 0 20px rgba(255, 255, 255, 0.5); transform: scale(1); }
  to { box-shadow: 0 0 40px rgba(255, 215, 0, 0.9), inset 0 0 10px rgba(255, 255, 255, 0.8); transform: scale(1.08); }
}
.spin-btn-lg::after {
  content:''; position:absolute; top:-4px; left:-4px; right:-4px; bottom:-4px;
  border-radius:50%;
  background: conic-gradient(from 45deg, #b8860b, #ffd700, #fffbe3, #ffd700, #b8860b);
  z-index:-1;
  box-shadow: 0 10px 20px rgba(0,0,0,0.5);
}
.spin-btn-lg:active { transform: scale(0.96); box-shadow: 0 5px 15px rgba(0,0,0,0.6); }
.spin-btn-lg:disabled { filter: grayscale(0.8) brightness(0.7); cursor: not-allowed; }

.auto-spin-btn {
  background: #222;
  color: #888;
  border: 1px solid #444;
  border-radius: 20px;
  padding: 8px 16px;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 1px;
  text-transform: uppercase;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 6px rgba(0,0,0,0.3);
}
.auto-spin-btn:hover { background: #333; color: #aaa; }
.auto-spin-btn.active {
  background: linear-gradient(135deg, #ffd700, #b8860b);
  color: #3e2700;
  border-color: #ffd700;
  box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
}

/* --- SLOTS MODERN --- */
.slot-machine-modern {
  background: linear-gradient(180deg, #443311 0%, #221a09 100%);
  border: 10px solid #222;
  box-shadow: 
    0 0 0 5px #b38728, /* Gold trim */
    0 0 0 15px #111,   /* Outer casing */
    0 0 60px rgba(0,0,0,0.8),
    inset 0 0 100px rgba(0,0,0,0.9);
  border-radius: 40px 40px 10px 10px; /* Cabinet shape */
  padding: 50px;
  max-width: 900px;
  margin: 0 auto;
  position: relative;
  overflow: hidden;
}

/* Casino Lights around border */
.slot-machine-modern::before {
  content: ''; position: absolute; top: 15px; left: 15px; right: 15px; bottom: 15px;
  border: 4px dashed rgba(255, 215, 0, 0.5);
  border-radius: 30px;
  box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
  pointer-events: none;
  z-index: 5;
  animation: lights-blink 2s infinite;
}
@keyframes lights-blink {
  0%, 100% { border-color: rgba(255, 215, 0, 0.3); box-shadow: 0 0 10px rgba(255, 215, 0, 0.1); }
  50% { border-color: rgba(255, 215, 0, 0.8); box-shadow: 0 0 30px rgba(255, 215, 0, 0.6); }
}

/* Glass Screen Reflection */
.slot-machine-modern::after {
  content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 40%;
  background: linear-gradient(180deg, rgba(255,255,255,0.1) 0%, transparent 100%);
  pointer-events: none;
  z-index: 20;
}

.reels-container-3d {
  display: flex;
  gap: 25px;
  justify-content: center;
  perspective: 1200px;
  padding: 30px;
  background: #000;
  border-radius: 10px;
  box-shadow: inset 0 0 50px #000;
  border: 5px solid #333;
}

.reel-3d-col {
  width: 160px;
  height: 240px;
  background: #fff; /* Base reel color */
  border-radius: 10px;
  position: relative;
  overflow: hidden;
  box-shadow: inset 0 0 60px rgba(0,0,0,0.8); /* Cylinder curvature shadow */
  transform-style: preserve-3d;
  transition: transform 0.3s;
}

/* Reel curvature highlights */
.reel-3d-col::before {
  content: ''; position: absolute; top:0; left:0; width:100%; height:100%;
  background: linear-gradient(90deg, 
    rgba(0,0,0,0.6) 0%, 
    rgba(0,0,0,0.1) 20%, 
    rgba(255,255,255,0.2) 50%, 
    rgba(0,0,0,0.1) 80%, 
    rgba(0,0,0,0.6) 100%
  );
  pointer-events: none;
  z-index: 15;
}

/* Top/Bottom shadows for depth */
.reel-3d-col::after {
  content: ''; position: absolute; top:0; left:0; width:100%; height:100%;
  background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, transparent 20%, transparent 80%, rgba(0,0,0,0.9) 100%);
  pointer-events: none;
  z-index: 10;
}

.win-line {
  position: absolute;
  top: 50%; left: -20px; right: -20px; height: 6px;
  background: #ff0000;
  box-shadow: 0 0 20px #ff0000, 0 0 10px #fff;
  transform: translateY(-50%) scaleX(0);
  transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  z-index: 50;
  border-radius: 4px;
}
.win-line.active { transform: translateY(-50%) scaleX(1); }

/* --- PLINKO --- */
.plinko-board {
  background: #0b0d12;
  border: 4px solid var(--gold-3);
  border-radius: 12px;
  margin: 0 auto;
  display: block;
  box-shadow: 0 0 30px rgba(0,0,0,0.5);
}

/* --- WHEEL --- */
.wheel-container {
  position: relative;
  width: 400px;
  height: 400px;
  margin: 0 auto;
}
#wheel-canvas {
  width: 100%;
  height: 100%;
  transform-origin: center;
  filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5));
}
.wheel-pointer {
  position: absolute;
  top: -15px;
  left: 50%;
  transform: translateX(-50%);
  width: 40px;
  height: 40px;
  z-index: 10;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
}

/* --- OVERLAYS & TOASTS --- */
.toast-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 2000;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.toast {
  background: rgba(15, 18, 25, 0.95);
  border-left: 4px solid var(--gold-2);
  padding: 15px 25px;
  border-radius: 4px;
  color: #fff;
  box-shadow: 0 5px 15px rgba(0,0,0,0.5);
  animation: slideIn 0.3s ease-out;
  display: flex;
  flex-direction: column;
}
.toast-title { font-weight: 700; color: var(--gold-2); font-family: var(--font-heading); }
.toast-body { font-size: 14px; color: #ccc; }
@keyframes slideIn { from{transform:translateX(100%)} to{transform:translateX(0)} }

.big-win {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.85);
  z-index: 3000;
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  pointer-events: none;
}
.big-win.active { display: flex; animation: pulseWin 0.5s ease-out; pointer-events: auto; }
.win-title {
  font-family: var(--font-heading);
  font-size: 80px;
  font-weight: 900;
  background: linear-gradient(to bottom, #fff, var(--gold-2), #d4a034);
  background-clip: text;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  filter: drop-shadow(0 0 20px var(--gold-3));
  margin: 0;
}
.win-val {
  font-size: 40px;
  color: #fff;
  margin-top: 20px;
  font-weight: 700;
}

/* --- MAIN MENU --- */
.hero-section {
  text-align: center;
  padding: 40px 20px;
  background: radial-gradient(circle at center, rgba(255, 215, 0, 0.1), transparent 70%);
  margin-bottom: 40px;
}
.hero-title {
  font-size: 50px; /* Reduced from 60px for better fit */
  margin-bottom: 10px;
  background: linear-gradient(to bottom, #ffd700, #b8860b);
  background-clip: text;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
}
.hero-subtitle {
  font-size: 18px;
  color: var(--text-muted);
  max-width: 600px;
  margin: 0 auto;
}

.game-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 25px;
  padding: 0 20px;
  max-width: 1200px;
  margin: 0 auto;
  justify-content: center;
}

.game-card {
  background: linear-gradient(145deg, rgba(20,20,20,0.9), rgba(10,10,10,0.95));
  border: 1px solid rgba(255, 215, 0, 0.2);
  border-radius: 12px;
  padding: 25px;
  text-align: center;
  transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
  position: relative;
  overflow: hidden;
  cursor: pointer;
}

.game-card:hover {
  transform: translateY(-8px);
  border-color: var(--gold-2);
  box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 15px rgba(255, 215, 0, 0.1);
}

.game-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; width: 100%; height: 100%;
  background: linear-gradient(45deg, transparent, rgba(255,255,255,0.03), transparent);
  transform: translateX(-100%);
  transition: 0.5s;
}
.game-card:hover::before {
  transform: translateX(100%);
}

.game-icon {
  font-size: 48px;
  margin-bottom: 15px;
  filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.3));
}

.game-title {
  font-family: var(--font-heading);
  font-size: 20px;
  color: var(--gold-1);
  margin-bottom: 10px;
}

.game-desc {
  font-size: 13px;
  color: #aaa;
  margin-bottom: 20px;
  line-height: 1.4;
}

/* --- UTILS --- */
.hidden { display: none !important; }
.form-group { margin-bottom: 15px; }
.form-group label { display: block; margin-bottom: 5px; color: var(--gold-4); }
.form-control {
  width: 100%;
  padding: 12px;
  background: rgba(0,0,0,0.3);
  border: 1px solid var(--gold-5);
  border-radius: 4px;
  color: #fff;
}
.form-control:focus { outline: none; border-color: var(--gold-2); box-shadow: 0 0 10px var(--accent-glow); }
.grid-cols-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.achievements-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
.achievement-card {
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.05);
  padding: 15px;
  border-radius: 8px;
  opacity: 0.5;
  transition: all 0.3s;
}
.achievement-card.unlocked {
  opacity: 1;
  border-color: var(--gold-3);
  background: linear-gradient(135deg, rgba(191,149,63,0.1), transparent);
  box-shadow: 0 0 15px rgba(191,149,63,0.1);
}
.ach-icon { font-size: 24px; margin-bottom: 5px; color: var(--gold-2); }

/* --- MODAL --- */
.modal-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.8);
  z-index: 5000;
  display: flex; justify-content: center; align-items: center;
  opacity: 0; pointer-events: none; transition: opacity 0.3s;
  backdrop-filter: blur(5px);
}
.modal-overlay.active { opacity: 1; pointer-events: auto; }
.modal-content {
  background: var(--bg-panel);
  border: 2px solid var(--gold-3);
  padding: 30px;
  border-radius: 12px;
  max-width: 500px; width: 90%;
  box-shadow: 0 0 50px rgba(0,0,0,0.8);
  transform: translateY(20px); transition: transform 0.3s;
}
.modal-overlay.active .modal-content { transform: translateY(0); }
.pay-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
.pay-row:last-child { border-bottom: none; }

  /* MINES Styles */
  .mine-tile {
      background: rgba(255,255,255,0.1);
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      transition: all 0.2s;
      border: 1px solid rgba(255,255,255,0.05);
  }
  .mine-tile:hover:not(.revealed) {
      background: rgba(255,255,255,0.2);
      transform: scale(1.05);
  }
  .mine-tile.revealed {
      background: #000;
      border-color: #333;
      cursor: default;
  }
  .mine-tile.gem {
      background: rgba(46, 204, 113, 0.2);
      border-color: #2ecc71;
      box-shadow: 0 0 10px rgba(46, 204, 113, 0.3);
  }
  .mine-tile.mine {
      background: rgba(231, 76, 60, 0.2);
      border-color: #c0392b;
      box-shadow: 0 0 10px rgba(231, 76, 60, 0.3);
  }

  /* HOT STREAK METER */
  #streak-container {
      position: fixed;
      top: 140px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 90;
      display: flex;
      flex-direction: column;
      align-items: center;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.5s;
  }
  #streak-container.active { opacity: 1; }
  .streak-bar-bg {
      width: 250px;
      height: 12px;
      background: rgba(0,0,0,0.8);
      border: 1px solid var(--gold-4);
      border-radius: 6px;
      overflow: hidden;
      position: relative;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
  }
  .streak-bar-fill {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #ff4500, #ffd700);
      transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 0 15px #ff4500;
  }
  .streak-text {
      font-family: var(--font-heading);
      color: var(--gold-1);
      font-weight: 800;
      text-transform: uppercase;
      text-shadow: 0 2px 4px rgba(0,0,0,0.8), 0 0 10px #ff4500;
      margin-bottom: 5px;
      font-size: 16px;
      letter-spacing: 2px;
  }
  .streak-multiplier {
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      font-weight: bold;
      color: #000;
      z-index: 2;
  }



  /* --- FOOTER --- */
  .site-footer {
      background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
      color: #666;
      text-align: center;
      padding: 30px 20px;
      margin-top: 50px;
      border-top: none;
      position: relative;
      z-index: 10;
      font-family: var(--font-body);
      font-size: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
  }
  .site-footer a {
      color: #888;
      text-decoration: none;
      transition: color 0.3s;
  }
  .site-footer a:hover {
      color: var(--gold-2);
      text-decoration: none;
  }

  .flash-effect {
    animation: flash-screen 0.5s ease-out;
}
@keyframes flash-screen {
    0% { background-color: rgba(255,255,255,0); }
    50% { background-color: rgba(255,255,255,0.8); }
    100% { background-color: rgba(255,255,255,0); }
}

/* --- RESPONSIVE --- */
  @media (max-width: 900px) {
    .hero-layout { grid-template-columns: 1fr; gap: 30px; }
    .left-menu { flex-direction: row; flex-wrap: wrap; justify-content: center; padding-top: 0; }
    .menu-card { flex: 1; min-width: 200px; }
    .hero-title { font-size: 40px !important; text-align: center !important; }
    .hero-subtitle { text-align: center !important; }
    .hero-section { text-align: center !important; }
    .hero-section div[style*="display:flex"] { justify-content: center; }
    .navbar { display: flex; padding: 10px 20px; flex-direction: column; gap: 15px; }
    .nav-links { gap: 15px; flex-wrap: wrap; justify-content: center; }
  }

  /* --- MOBILE OPTIMIZATION --- */
  @media (max-width: 600px) {
    /* Navbar Stacking */
    .navbar { padding: 10px; }
    .nav-links { gap: 8px; justify-content: center; }
    .nav-links a { font-size: 11px; padding: 6px 10px; background: rgba(255,255,255,0.05); border-radius: 4px; }
    .user-panel { width: 100%; justify-content: center; margin-top: 5px; flex-wrap: wrap; gap: 10px; }
    
    /* Typography Scaling */
    .hero-title { font-size: 28px !important; line-height: 1.1; margin-bottom: 15px !important; }
    .hero-subtitle { font-size: 14px; padding: 0 10px; margin-bottom: 20px !important; }
    .epic-title { font-size: 24px; letter-spacing: 2px; }
    
    /* Grid Adjustments */
    .game-grid { grid-template-columns: 1fr; padding: 0 15px; gap: 20px; }

    
    /* Modal Full Width */
    .modal-content { 
      width: 95%; 
      padding: 15px; 
      max-height: 85vh; 
    }
    
    /* Game Specifics */
    #bj-table { padding: 10px; min-height: 400px; }
    .bj-hand { min-width: auto; margin: 5px; }
    .bj-card { width: 50px; height: 75px; }
    .bj-card-content { font-size: 12px; }
    
    /* Hide non-essential on tiny screens */
    .version-tag { display: none; }
    
    /* Improve touch targets */
    button, a { min-height: 44px; min-width: 44px; display: inline-flex; align-items: center; justify-content: center; }
    .nav-links a { min-height: 36px; } /* Exception for nav */
  }
/* --- EPIC THEME OVERRIDES --- */

/* Global Vignette for Dramatic Feel */
body::after {
  content: '';
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: radial-gradient(circle at center, transparent 0%, rgba(0,0,0,0.4) 70%, rgba(0,0,0,0.8) 100%);
  z-index: -1;
  pointer-events: none;
}




/* Epic Title Animation */
.epic-title {
  text-align: center;
  color: var(--gold-2);
  font-family: var(--font-heading);
  margin-bottom: 40px;
  font-size: 42px;
  text-transform: uppercase;
  letter-spacing: 4px;
  position: relative;
  text-shadow: 0 0 10px rgba(212,175,55,0.5), 0 0 20px rgba(212,175,55,0.3);
  animation: epicPulse 3s infinite ease-in-out;
}

@keyframes epicPulse {
  0% { transform: scale(1); text-shadow: 0 0 10px rgba(212,175,55,0.5); }
  50% { transform: scale(1.05); text-shadow: 0 0 30px rgba(212,175,55,0.8), 0 0 50px rgba(212,175,55,0.4); }
  100% { transform: scale(1); text-shadow: 0 0 10px rgba(212,175,55,0.5); }
}

/* Win Reveal Animation */
.win-reveal-container {
  perspective: 1000px;
  padding: 20px;
}

.win-icon-anim {
  width: 150px;
  height: 150px;
  margin: 0 auto 20px;
  filter: drop-shadow(0 0 20px rgba(255,215,0,0.6));
  animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
  opacity: 0;
  transform: scale(0) rotate(-180deg);
}

.win-text-anim {
  opacity: 0;
  transform: translateY(20px);
  animation: slideUpFade 0.5s ease forwards 0.5s;
}

@keyframes popIn {
  to { opacity: 1; transform: scale(1) rotate(0deg); }
}

@keyframes slideUpFade {
  to { opacity: 1; transform: translateY(0); }
}

.god-rays {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  width: 600px; height: 600px;
  background: radial-gradient(circle, rgba(255,215,0,0.2) 0%, transparent 70%);
  z-index: -1;
  animation: rotateRays 10s linear infinite;
  pointer-events: none;
}

@keyframes rotateRays {
  from { transform: translate(-50%, -50%) rotate(0deg); }
  to { transform: translate(-50%, -50%) rotate(360deg); }
}

/* Epic Game Cards (Main Menu) */
.game-card {
  background: linear-gradient(145deg, #151515, #0a0a0a);
  border: 1px solid rgba(191, 149, 63, 0.3);
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}
.game-card:hover {
  box-shadow: 0 15px 40px rgba(0,0,0,0.7), 0 0 15px rgba(191, 149, 63, 0.2);
  border-color: var(--gold-2);
}

</style>
</head>
<body>

<!-- CHANGELOG MODAL -->
<div id="changelog-modal" class="modal-overlay">
  <div class="modal-content" style="max-width:600px">
    <button class="modal-close-btn" onclick="document.getElementById('changelog-modal').classList.remove('active')"></button>
    <h2 style="color:var(--gold-2); text-align:center; margin-bottom:20px; font-family:var(--font-heading)">PATCH NOTES</h2>
    <div id="changelog-list-modal" style="max-height:400px; overflow-y:auto; padding-right:10px;">
        <!-- Populated by JS -->
    </div>
  </div>
</div>

<!-- Loader -->
<div id="loader">
  <div class="flash-overlay"></div>
  <div class="golden-beam beam-1"></div>
  <div class="golden-beam beam-2"></div>
  <div class="loader-content">
    <img src="https://i.imgur.com/9AOKdUO.png" alt="Vegas Gold" style="width:150px; margin-bottom:20px; filter: drop-shadow(0 0 20px gold);">
    <h1 style="font-size:70px; margin:0; color:var(--gold-2); text-shadow:0 0 30px var(--gold-3); font-family:var(--font-heading)">VEGAS GOLD</h1>
    <p style="color:var(--gold-4); letter-spacing:5px; font-size:20px; text-transform:uppercase">Ultimate Royal Edition</p>
    <button class="loader-btn" onclick="app.enterGame()">ENTER CASINO</button>
  </div>
</div>

<!-- Backgrounds -->
<canvas id="bg-canvas"></canvas>

<!-- SVG Icons Defs -->
<svg style="display:none">
  <!-- Custom 7: Stylish, bold, with gold outline effect -->
  <symbol id="icon-7" viewBox="0 0 100 100">
    <defs>
      <linearGradient id="grad-7" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" style="stop-color:#ff4444;stop-opacity:1" />
        <stop offset="100%" style="stop-color:#990000;stop-opacity:1" />
      </linearGradient>
    </defs>
    <path d="M15 15 H85 L55 85 L40 85 L65 25 H25 V15 Z" fill="url(#grad-7)" stroke="#ffd700" stroke-width="3" filter="drop-shadow(0 4px 2px rgba(0,0,0,0.5))"/>
  </symbol>

  <!-- Custom Diamond: Faceted blue gem -->
  <symbol id="icon-diamond" viewBox="0 0 100 100">
    <defs>
      <linearGradient id="grad-dia" x1="0%" y1="0%" x2="0%" y2="100%">
        <stop offset="0%" style="stop-color:#87ceeb;stop-opacity:1" />
        <stop offset="100%" style="stop-color:#4682b4;stop-opacity:1" />
      </linearGradient>
    </defs>
    <path d="M20 35 L50 10 L80 35 L50 90 Z" fill="url(#grad-dia)" stroke="#fff" stroke-width="2"/>
    <path d="M20 35 L80 35 M50 10 L50 90 M20 35 L50 90 L80 35" stroke="rgba(255,255,255,0.5)" stroke-width="1" fill="none"/>
  </symbol>

  <!-- Custom Crown: Gold with red gems -->
  <symbol id="icon-crown" viewBox="0 0 100 100">
    <defs>
      <linearGradient id="grad-crown" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" style="stop-color:#ffd700;stop-opacity:1" />
        <stop offset="100%" style="stop-color:#fdb931;stop-opacity:1" />
      </linearGradient>
    </defs>
    <path d="M10 75 Q50 85 90 75 L90 35 L70 55 L50 15 L30 55 L10 35 Z" fill="url(#grad-crown)" stroke="#b8860b" stroke-width="2"/>
    <circle cx="50" cy="75" r="5" fill="#e74c3c" stroke="#5a0000" stroke-width="1"/>
    <circle cx="30" cy="72" r="4" fill="#3498db" stroke="#003366" stroke-width="1"/>
    <circle cx="70" cy="72" r="4" fill="#3498db" stroke="#003366" stroke-width="1"/>
    <circle cx="50" cy="15" r="5" fill="#fff" stroke="#ffd700" stroke-width="1"/>
  </symbol>

  <!-- Custom Bell: Golden with shine -->
  <symbol id="icon-bell" viewBox="0 0 100 100">
    <defs>
      <linearGradient id="grad-bell" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" style="stop-color:#ffff00;stop-opacity:1" />
        <stop offset="100%" style="stop-color:#d4af37;stop-opacity:1" />
      </linearGradient>
    </defs>
    <path d="M50 10 Q20 10 20 60 L10 70 H90 L80 60 Q80 10 50 10 Z" fill="url(#grad-bell)" stroke="#b8860b" stroke-width="2"/>
    <circle cx="50" cy="70" r="8" fill="#d4af37" stroke="#8b4513" stroke-width="1"/>
    <path d="M50 15 Q60 15 65 30" stroke="rgba(255,255,255,0.6)" stroke-width="3" fill="none" stroke-linecap="round"/>
  </symbol>

  <!-- Custom Bar: Rectangular gold bar -->
  <symbol id="icon-bar" viewBox="0 0 100 100">
    <rect x="10" y="30" width="80" height="40" rx="5" fill="#ffd700" stroke="#b8860b" stroke-width="3"/>
    <text x="50" y="58" font-family="Arial" font-weight="900" font-size="28" text-anchor="middle" fill="#000" stroke="#fff" stroke-width="1">BAR</text>
    <rect x="15" y="35" width="70" height="15" rx="2" fill="rgba(255,255,255,0.3)"/>
  </symbol>

  <!-- Custom Cherry: Realistic red cherries -->
  <symbol id="icon-cherry" viewBox="0 0 100 100">
    <path d="M50 10 Q70 10 80 30" stroke="#2ecc71" stroke-width="4" fill="none"/>
    <path d="M50 10 Q30 10 20 30" stroke="#2ecc71" stroke-width="4" fill="none"/>
    <circle cx="25" cy="60" r="18" fill="#d90429" stroke="#5a0000" stroke-width="1"/>
    <circle cx="75" cy="60" r="18" fill="#d90429" stroke="#5a0000" stroke-width="1"/>
    <circle cx="30" cy="55" r="5" fill="rgba(255,255,255,0.4)"/>
    <circle cx="80" cy="55" r="5" fill="rgba(255,255,255,0.4)"/>
    <path d="M50 10 L50 20" stroke="#2ecc71" stroke-width="4"/>
  </symbol>

  <!-- Card Suits -->
  <symbol id="suit-spade" viewBox="0 0 100 100">
    <path d="M50 15 Q30 40 15 55 Q0 70 20 85 Q30 92 50 80 Q70 92 80 85 Q100 70 85 55 Q70 40 50 15 M50 80 L45 95 H55 L50 80 Z" fill="currentColor"/>
  </symbol>
  <symbol id="suit-heart" viewBox="0 0 100 100">
    <path d="M50 90 Q10 50 10 30 Q10 5 30 5 Q45 5 50 25 Q55 5 70 5 Q90 5 90 30 Q90 50 50 90 Z" fill="currentColor"/>
  </symbol>
  <symbol id="suit-club" viewBox="0 0 100 100">
    <circle cx="50" cy="25" r="15" fill="currentColor"/>
    <circle cx="25" cy="60" r="15" fill="currentColor"/>
    <circle cx="75" cy="60" r="15" fill="currentColor"/>
    <path d="M50 50 L45 95 H55 L50 50 Z" fill="currentColor"/>
  </symbol>
  <symbol id="suit-diamond" viewBox="0 0 100 100">
    <path d="M50 10 L85 50 L50 90 L15 50 Z" fill="currentColor"/>
  </symbol>

  <!-- GAME ICONS (Custom Glassy Style) -->
  <symbol id="icon-slots" viewBox="0 0 100 100">
    <rect x="15" y="20" width="70" height="60" rx="10" fill="rgba(255,255,255,0.06)" stroke="var(--gold-2)" stroke-width="3"/>
    <rect x="22" y="30" width="56" height="32" rx="6" fill="rgba(255,215,0,0.15)" stroke="var(--gold-2)" stroke-width="2"/>
    <circle cx="35" cy="46" r="5" fill="#ffd700"/><circle cx="50" cy="46" r="5" fill="#ffd700"/><circle cx="65" cy="46" r="5" fill="#ffd700"/>
    <path d="M85 30 L95 30 L95 60" stroke="var(--gold-2)" stroke-width="3" fill="none"/>
  </symbol>
  <symbol id="icon-plinko" viewBox="0 0 100 100">
    <rect x="15" y="20" width="70" height="60" rx="6" fill="rgba(255,255,255,0.06)" stroke="var(--gold-2)" stroke-width="2"/>
    <circle cx="50" cy="30" r="6" fill="#ffd700"/>
    <circle cx="35" cy="45" r="3" fill="#fff"/><circle cx="50" cy="45" r="3" fill="#fff"/><circle cx="65" cy="45" r="3" fill="#fff"/>
    <circle cx="42.5" cy="57" r="3" fill="#fff"/><circle cx="57.5" cy="57" r="3" fill="#fff"/>
    <rect x="20" y="70" width="60" height="8" rx="4" fill="rgba(255,215,0,0.2)" stroke="var(--gold-2)" stroke-width="1"/>
  </symbol>
  <symbol id="icon-blackjack" viewBox="0 0 100 100">
    <rect x="25" y="20" width="28" height="40" rx="4" fill="#fff"/><rect x="47" y="30" width="28" height="40" rx="4" fill="#fff"/>
    <path d="M36 35 L38 35 L38 37 L36 37 Z" fill="#000"/><use href="#suit-spade" x="28" y="28" width="22" height="22" />
    <path d="M58 45 L60 45 L60 47 L58 47 Z" fill="#000"/><use href="#suit-heart" x="50" y="40" width="22" height="22" />
  </symbol>
  <symbol id="icon-mines" viewBox="0 0 100 100">
    <circle cx="50" cy="50" r="18" fill="#333" stroke="var(--gold-2)" stroke-width="2"/>
    <path d="M50 30 L50 20 M65 35 L75 30 M35 35 L25 30 M70 50 L80 50 M30 50 L20 50 M65 65 L75 70 M35 65 L25 70" stroke="#ccc" stroke-width="3"/>
    <circle cx="50" cy="50" r="6" fill="#ff4444"/>
  </symbol>

  <symbol id="icon-wheel" viewBox="0 0 100 100">
    <circle cx="50" cy="50" r="28" fill="rgba(255,255,255,0.06)" stroke="var(--gold-2)" stroke-width="3"/>
    <path d="M50 22 L50 78 M22 50 L78 50 M32 32 L68 68 M68 32 L32 68" stroke="#ffd700" stroke-width="2"/>
    <circle cx="50" cy="50" r="4" fill="#ffd700"/>
  </symbol>

  <!-- SKIN ICONS -->
  <!-- Gray Tier -->
  <symbol id="icon-trash" viewBox="0 0 100 100">
    <path d="M35 30 L40 85 H60 L65 30 M30 30 H70 M45 30 V25 H55 V30" stroke="#7f8c8d" stroke-width="3" fill="none"/>
    <line x1="45" y1="40" x2="45" y2="75" stroke="#7f8c8d" stroke-width="2"/>
    <line x1="55" y1="40" x2="55" y2="75" stroke="#7f8c8d" stroke-width="2"/>
  </symbol>
  <symbol id="icon-boot" viewBox="0 0 100 100">
    <path d="M35 20 V60 Q35 80 55 80 H70 V70 H60 V60 H35" stroke="#7f8c8d" stroke-width="3" fill="none"/>
    <line x1="35" y1="30" x2="50" y2="30" stroke="#7f8c8d"/>
    <line x1="35" y1="40" x2="50" y2="40" stroke="#7f8c8d"/>
  </symbol>
  <symbol id="icon-clip" viewBox="0 0 100 100">
    <path d="M40 30 V70 Q40 80 50 80 Q60 80 60 70 V25 Q60 15 45 15 Q30 15 30 25 V60" stroke="#bdc3c7" stroke-width="3" fill="none"/>
  </symbol>
  <symbol id="icon-cherry" viewBox="0 0 100 100">
    <path d="M35 65 A12 12 0 1 0 35 89 A12 12 0 1 0 35 65" fill="#e74c3c"/>
    <path d="M65 60 A12 12 0 1 0 65 84 A12 12 0 1 0 65 60" fill="#e74c3c"/>
    <path d="M40 65 Q50 20 80 15 M70 60 Q70 20 50 15" stroke="#2ecc71" stroke-width="4" fill="none"/>
  </symbol>

  <!-- Green Tier -->
  <symbol id="icon-poker" viewBox="0 0 100 100">
    <circle cx="50" cy="50" r="25" stroke="#2ecc71" stroke-width="3" fill="none"/>
    <circle cx="50" cy="50" r="18" stroke="#2ecc71" stroke-width="1" stroke-dasharray="4 2"/>
    <rect x="45" y="45" width="10" height="10" fill="#2ecc71" transform="rotate(45 50 50)"/>
  </symbol>
  <symbol id="icon-die" viewBox="0 0 100 100">
    <rect x="30" y="30" width="40" height="40" rx="5" stroke="#2ecc71" stroke-width="3" fill="none"/>
    <circle cx="40" cy="40" r="3" fill="#2ecc71"/>
    <circle cx="60" cy="40" r="3" fill="#2ecc71"/>
    <circle cx="40" cy="60" r="3" fill="#2ecc71"/>
    <circle cx="60" cy="60" r="3" fill="#2ecc71"/>
  </symbol>

  <!-- Purple Tier -->
  <symbol id="icon-shades" viewBox="0 0 100 100">
    <path d="M20 40 H45 L50 45 L55 40 H80" stroke="#9b59b6" stroke-width="3" fill="none"/>
    <path d="M25 40 Q25 60 35 60 Q45 60 45 40" stroke="#9b59b6" stroke-width="3" fill="rgba(155,89,182,0.2)"/>
    <path d="M55 40 Q55 60 65 60 Q75 60 75 40" stroke="#9b59b6" stroke-width="3" fill="rgba(155,89,182,0.2)"/>
  </symbol>
  <symbol id="icon-sparkle" viewBox="0 0 100 100">
    <path d="M50 20 L55 45 L80 50 L55 55 L50 80 L45 55 L20 50 L45 45 Z" fill="#9b59b6"/>
  </symbol>

  <!-- Gold Tier -->
  <symbol id="icon-crown" viewBox="0 0 100 100">
     <path d="M20 70 L20 30 L35 50 L50 20 L65 50 L80 30 L80 70 Z" fill="#ffd700" stroke="#b8860b" stroke-width="3"/>
     <circle cx="20" cy="25" r="4" fill="#fff"/>
     <circle cx="50" cy="15" r="4" fill="#fff"/>
     <circle cx="80" cy="25" r="4" fill="#fff"/>
  </symbol>
  <symbol id="icon-7" viewBox="0 0 100 100">
    <text x="50" y="75" font-family="Arial" font-weight="900" font-size="70" text-anchor="middle" fill="#e74c3c" stroke="#c0392b" stroke-width="2">7</text>
  </symbol>
  <symbol id="icon-diamond" viewBox="0 0 100 100">
    <path d="M50 15 L85 50 L50 85 L15 50 Z" fill="#9b59b6" stroke="#8e44ad" stroke-width="3"/>
    <path d="M50 25 L75 50 L50 75 L25 50 Z" fill="rgba(255,255,255,0.2)"/>
  </symbol>

  <!-- Ultra Tier -->
  <symbol id="icon-key" viewBox="0 0 100 100">
    <circle cx="35" cy="35" r="10" stroke="#e74c3c" stroke-width="3" fill="none"/>
    <path d="M42 42 L75 75" stroke="#e74c3c" stroke-width="3"/>
    <path d="M75 75 L80 70 M65 65 L70 60" stroke="#e74c3c" stroke-width="3"/>
  </symbol>
  <symbol id="icon-planet" viewBox="0 0 100 100">
    <circle cx="50" cy="50" r="20" fill="#3498db"/>
    <ellipse cx="50" cy="50" rx="35" ry="10" stroke="#fff" stroke-width="2" fill="none" transform="rotate(-30 50 50)"/>
  </symbol>
  <symbol id="icon-hourglass" viewBox="0 0 100 100">
    <path d="M30 20 H70 L50 50 L70 80 H30 L50 50 Z" stroke="#e67e22" stroke-width="3" fill="none"/>
    <path d="M30 20 H70 M30 80 H70" stroke="#e67e22" stroke-width="3"/>
    <circle cx="50" cy="65" r="2" fill="#e67e22"/>
  </symbol>
</svg>

<header class="site-header">
  <div class="version-tag">Version: 0.1 Beta</div>
  <nav class="navbar">
    <a href="#" class="brand" onclick="app.nav('home')">
      <img src="https://i.imgur.com/9AOKdUO.png" alt="Logo">
    </a>
    
    <div class="nav-links">
      <button class="nav-item" onclick="app.nav('home')">Home</button>
      <button class="nav-item">
        Games
      <div class="dropdown-menu">
          <a href="#" onclick="app.nav('slots')"><svg style="width:14px;height:14px;vertical-align:-2px;margin-right:6px"><use href="#icon-slots"/></svg> Royal Slots</a>
          <a href="#" onclick="app.nav('plinko')"><svg style="width:14px;height:14px;vertical-align:-2px;margin-right:6px"><use href="#icon-plinko"/></svg> Golden Plinko</a>
          <a href="#" onclick="app.nav('blackjack')"><svg style="width:14px;height:14px;vertical-align:-2px;margin-right:6px"><use href="#icon-blackjack"/></svg> Blackjack</a>
          <a href="#" onclick="app.nav('mines')"><svg style="width:14px;height:14px;vertical-align:-2px;margin-right:6px"><use href="#icon-mines"/></svg> Royal Mines</a>
          <a href="#" onclick="app.nav('wheel')"><svg style="width:14px;height:14px;vertical-align:-2px;margin-right:6px"><use href="#icon-wheel"/></svg> Daily Wheel</a>
        </div>
      </button>
      <button class="nav-item" onclick="app.nav('shop')">Shop</button>
      <button class="nav-item" onclick="document.getElementById('daily-modal').classList.add('active')">Daily</button>
      <button class="nav-item vip-btn" onclick="app.nav('vip-shop')">VIP Shop</button>
       
       <!-- More Menu -->
       <button class="nav-item">
         Menu
         <div class="dropdown-menu">
             <a href="#" onclick="app.nav('inventory')">ðŸŽ’ Inventory</a>
             <a href="#" onclick="app.nav('market')">ðŸª Market</a>
             <a href="#" onclick="ProfileSystem.openModal()">ðŸ‘¤ Profile</a>
             <a href="#" onclick="app.nav('community')">ðŸ‘¥ Community</a>
             <a href="#" onclick="app.nav('settings')">âš™ï¸ Settings</a>
         </div>
       </button>
    </div>

    <div class="user-panel">
      <div id="auth-ui" class="hidden" style="display:flex;gap:15px;align-items:center">
        <div class="level-badge-sm" id="lvl-badge">1</div>
        <div class="xp-bar-wrapper">
          <div class="xp-bar-container" id="xp-bar-container">
            <div class="xp-bar-fill" id="xp-fill"></div>
            <div class="xp-text" id="xp-text">0 / 1000 XP</div>
            <div id="xp-particles-layer" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;overflow:visible;"></div>
          </div>
        </div>
        <div class="balance-display">
          <span style="color:var(--gold-1)">V$</span> <span id="balance-disp">1000</span>
        </div>
        <div class="balance-display" style="border-color:#9b59b6">
          <span style="color:#9b59b6">ðŸ’Ž</span> <span id="gems-disp">0</span>
        </div>
        <button class="gold-btn secondary" onclick="app.logout()" style="padding:4px 10px;font-size:10px; border-radius:4px">LOGOUT</button>
      </div>
      <div id="guest-ui">
        <button class="gold-btn" onclick="app.nav('login')">LOGIN</button>
      </div>
    </div>
  </nav>
</header>

<main class="main">

  <!-- HOT STREAK METER -->
  <div id="streak-container">
      <div class="streak-text" id="streak-text">HOT STREAK</div>
      <div class="streak-bar-bg">
          <div class="streak-bar-fill" id="streak-fill"></div>
          <div class="streak-multiplier" id="streak-mult">1x</div>
      </div>
  </div>

  <!-- HOME -->
  <section id="home" class="section active">
    <div class="hero-layout">


        <!-- CENTER CONTENT -->
        <div class="hero-main-content">
            <div class="hero-section" style="background:none; display:flex; flex-direction:column; align-items:center; text-align:center; padding:0; margin-bottom:30px">
                <h1 class="hero-title" style="font-size:60px; text-align:center">THE ROYAL EXPERIENCE</h1>
                <p class="hero-subtitle" style="margin:0 auto; text-align:center">
                    Step into the world's most exclusive digital casino. Where fortunes are made and legends are born.
                </p>
                <div style="margin-top:30px; display:flex; gap:15px; justify-content:center">
                     <button class="gold-btn" onclick="app.nav('slots')">QUICK PLAY</button>
                </div>
            </div>

      <div class="game-grid" style="padding:0; margin:0">
              <!-- Slots Card -->
              <div class="game-card" onclick="app.nav('slots')">
                <div class="game-icon"><svg class="slot-icon" style="width:40px;height:40px"><use href="#icon-slots"/></svg></div>
                <div class="game-title">ROYAL SLOTS</div>
                <div class="game-desc">Classic 3-reel action with modern 3D visuals. Hit the jackpot with 777s!</div>
                <button class="gold-btn secondary" style="width:100%">PLAY NOW</button>
              </div>

      <!-- Plinko Card -->
      <div class="game-card" onclick="app.nav('plinko')">
        <div class="game-icon"><svg class="slot-icon" style="width:40px;height:40px"><use href="#icon-plinko"/></svg></div>
        <div class="game-title">GOLDEN PLINKO</div>
        <div class="game-desc">Drop the ball through the pegboard. Risk it all for high multipliers.</div>
        <button class="gold-btn secondary" style="width:100%">PLAY NOW</button>
      </div>

      <!-- Blackjack Card -->
      <div class="game-card" onclick="app.nav('blackjack')">
        <div class="game-icon"><svg class="slot-icon" style="width:40px;height:40px"><use href="#icon-blackjack"/></svg></div>
        <div class="game-title">BLACKJACK</div>
        <div class="game-desc">Test your skills against the dealer. Hit, stand, or double down to 21.</div>
        <button class="gold-btn secondary" style="width:100%">PLAY NOW</button>
      </div>

      <!-- Wheel Card -->
      <div class="game-card" onclick="app.nav('wheel')">
        <div class="game-icon"><svg class="slot-icon" style="width:40px;height:40px"><use href="#icon-wheel"/></svg></div>
        <div class="game-title">DAILY WHEEL</div>
        <div class="game-desc">Spin the wheel every 24 hours for guaranteed free credits and prizes.</div>
        <button class="gold-btn secondary" style="width:100%">SPIN NOW</button>
      </div>

      <!-- Mines Card -->
      <div class="game-card" onclick="app.nav('mines')">
        <div class="game-icon"><svg class="slot-icon" style="width:40px;height:40px"><use href="#icon-mines"/></svg></div>
        <div class="game-title">ROYAL MINES</div>
        <div class="game-desc">Uncover diamonds, avoid the mines. The more you find, the more you win.</div>
        <button class="gold-btn secondary" style="width:100%">PLAY NOW</button>
      </div>

      <!-- Poker Card -->
      <div class="game-card" onclick="app.nav('poker')">
        <div class="game-icon">â™ ï¸</div>
        <div class="game-title">VEGAS POKER</div>
        <div class="game-desc">Classic Texas Hold'em style. Form the best hand to win the pot.</div>
        <button class="gold-btn secondary" style="width:100%">PLAY NOW</button>
      </div>

      <!-- Roulette Card -->
      <div class="game-card" onclick="app.nav('roulette')">
        <div class="game-icon">ðŸŽ¡</div>
        <div class="game-title">ROYAL ROULETTE</div>
        <div class="game-desc">Place your bets on Red, Black, or your lucky number.</div>
        <button class="gold-btn secondary" style="width:100%">PLAY NOW</button>
      </div>


    </div>



    </div> <!-- End hero-main-content -->




  </div> <!-- End hero-layout -->
  </section>

  <!-- POKER -->
  <section id="poker" class="section">
      <div class="panel-box" style="max-width:800px; margin:0 auto; text-align:center">
          <h2 style="color:var(--gold-1); margin-bottom:20px">VEGAS POKER</h2>
          
          <div style="background:rgba(0,0,0,0.5); padding:20px; border-radius:10px; margin-bottom:20px; min-height:300px; position:relative">
              <!-- Dealer / Community Cards -->
              <div style="margin-bottom:20px">
                  <div style="color:#aaa; font-size:12px; margin-bottom:5px">COMMUNITY CARDS</div>
                  <div id="poker-community" style="display:flex; justify-content:center; gap:10px; height:80px">
                      <!-- Cards -->
                  </div>
              </div>
              
              <div style="font-size:24px; color:var(--gold-2); margin-bottom:20px">Pot: V$ <span id="poker-pot">0</span></div>
              
              <!-- Player Hand -->
              <div>
                  <div style="color:#aaa; font-size:12px; margin-bottom:5px">YOUR HAND</div>
                  <div id="poker-hand" style="display:flex; justify-content:center; gap:10px; height:80px">
                      <!-- Cards -->
                  </div>
                  <div id="poker-status" style="margin-top:10px; color:#fff; font-weight:bold; height:20px"></div>
              </div>
          </div>
          
          <div class="controls-area" style="display:flex; gap:10px; justify-content:center; align-items:center">
              <button class="gold-btn secondary" onclick="Poker.fold()">FOLD</button>
              <button class="gold-btn" onclick="Poker.call()">CALL / CHECK</button>
              <button class="gold-btn" onclick="Poker.raise()">RAISE V$100</button>
          </div>
          
          <div style="margin-top:20px">
              <button class="gold-btn secondary" onclick="app.nav('home')">EXIT TABLE</button>
          </div>
      </div>
  </section>

  <!-- ROULETTE -->
  <section id="roulette" class="section">
      <div class="panel-box" style="max-width:800px; margin:0 auto; text-align:center">
          <h2 style="color:var(--gold-1); margin-bottom:20px">ROYAL ROULETTE</h2>
          
          <div style="margin-bottom:30px">
              <div id="roulette-wheel" style="width:200px; height:200px; border:10px solid var(--gold-2); border-radius:50%; margin:0 auto; display:flex; align-items:center; justify-content:center; background:#111; font-size:48px; color:#fff; box-shadow:0 0 20px rgba(0,0,0,0.5)">
                  <span id="roulette-result">?</span>
              </div>
          </div>
          
          <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; max-width:400px; margin:0 auto 20px auto">
              <button class="gold-btn" style="background:#d00; border-color:#d00" onclick="Roulette.bet('red')">RED (x2)</button>
              <button class="gold-btn" style="background:#0a0; border-color:#0a0" onclick="Roulette.bet('green')">GREEN (x14)</button>
              <button class="gold-btn" style="background:#222; border-color:#555" onclick="Roulette.bet('black')">BLACK (x2)</button>
          </div>
          
          <div style="margin-bottom:20px">
              <input type="number" id="roulette-bet-amount" value="100" class="form-control" style="width:100px; text-align:center; display:inline-block">
              <div style="color:#aaa; font-size:12px; margin-top:5px">Bet Amount</div>
          </div>
          
          <div id="roulette-msg" style="height:20px; color:var(--gold-2); margin-bottom:10px; font-weight:bold"></div>
          
          <button class="gold-btn secondary" onclick="app.nav('home')">LEAVE TABLE</button>
      </div>
  </section>

  <!-- COMMUNITY PAGE -->
  <section id="community" class="section">
    <div style="width:100%; max-width:1200px; padding:0 20px; margin:0 auto">
        <h2 style="text-align:center; color:var(--gold-2); font-family:var(--font-heading); margin-bottom:40px; font-size:32px;">COMMUNITY HUB</h2>
        <p style="text-align:center; color:var(--text-muted); margin-bottom:40px; max-width:600px; margin-left:auto; margin-right:auto;">
            Stay updated with the latest news, roadmap progress, and connect with other players.
        </p>

        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap:30px; justify-content:center;">
            
            <!-- News Accordion -->
            <div class="accordion-item" style="height:fit-content">
                <div class="accordion-header" onclick="app.toggleAccordion(this)">
                    <div class="accordion-title">ðŸ“¢ News</div>
                    <div class="accordion-icon">â–¼</div>
                </div>
                <div class="accordion-content">
                    <div style="padding:15px">
                        <div id="changelog-list" style="max-height:400px; overflow-y:auto;">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Roadmap Accordion -->
            <div class="accordion-item" style="height:fit-content">
                <div class="accordion-header" onclick="app.toggleAccordion(this)">
                    <div class="accordion-title">ðŸ—ºï¸ Roadmap</div>
                    <div class="accordion-icon">â–¼</div>
                </div>
                <div class="accordion-content">
                    <div style="padding:15px">
                         <div id="roadmap-list" style="display:flex; flex-direction:column; gap:10px">
                            <!-- Populated by JS -->
                         </div>
                    </div>
                </div>
            </div>

            <!-- Social Accordion -->
            <div class="accordion-item" style="height:fit-content">
                <div class="accordion-header" onclick="app.toggleAccordion(this)">
                    <div class="accordion-title">ðŸ‘¥ Social Hub</div>
                    <div class="accordion-icon">â–¼</div>
                </div>
                <div class="accordion-content">
                    <div style="padding:15px; text-align:center">
                        <!-- Social Tabs -->
                        <div style="display:flex; gap:5px; margin-bottom:15px; justify-content:center">
                            <button class="gold-btn" style="flex:1; padding:5px; font-size:10px" onclick="Social.switchTab('friends')">FRIENDS</button>
                            <button class="gold-btn secondary" style="flex:1; padding:5px; font-size:10px" onclick="Social.switchTab('chat')">CHAT</button>
                            <button class="gold-btn secondary" style="flex:1; padding:5px; font-size:10px" onclick="Social.switchTab('leaderboard')">TOP</button>
                        </div>

                        <!-- Friends Tab -->
                        <div id="social-tab-friends">
                            <p style="color:#aaa;margin-bottom:5px;font-size:10px;letter-spacing:1px">MY CODE</p>
                            <div id="my-profile-code" style="font-family:monospace;font-size:18px;color:var(--gold-2);letter-spacing:2px;margin-bottom:15px; background:rgba(0,0,0,0.3); padding:5px; border-radius:4px">----</div>
                            
                            <div style="display:flex;gap:5px;margin-bottom:15px">
                                <input type="text" id="friend-code-input" placeholder="Friend Code" style="flex:1;padding:8px;background:#050505;border:1px solid #333;color:#fff;font-family:monospace;font-size:12px; border-radius:4px">
                                <button class="gold-btn" style="padding:8px 12px; font-size:10px" onclick="Social.addFriend()">ADD</button>
                            </div>
                            
                            <div id="friends-list" style="max-height:200px;overflow-y:auto;border-top:1px solid #333;padding-top:10px;display:flex;flex-direction:column;gap:5px; text-align:left">
                                <p style="text-align:center;color:#666;font-style:italic; font-size:11px">No friends.</p>
                            </div>
                        </div>

                        <!-- Chat Tab -->
                        <div id="social-tab-chat" style="display:none">
                            <div id="chat-messages" style="height:200px; overflow-y:auto; background:rgba(0,0,0,0.3); padding:10px; border-radius:4px; text-align:left; margin-bottom:10px; font-size:11px; display:flex; flex-direction:column; gap:5px">
                                <!-- Populated by JS -->
                            </div>
                            <div style="display:flex; gap:5px">
                                <input type="text" id="chat-input" placeholder="Say something..." style="flex:1; padding:8px; background:#050505; border:1px solid #333; color:#fff; font-size:12px; border-radius:4px">
                                <button class="gold-btn" style="padding:8px; font-size:10px" onclick="Social.sendMessage()">SEND</button>
                            </div>
                        </div>

                        <!-- Leaderboard Tab -->
                        <div id="social-tab-leaderboard" style="display:none">
                            <div id="leaderboard-list" style="max-height:250px; overflow-y:auto; text-align:left; font-size:11px">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                    </div>
                </div>
            </div>

        </div>
    </div>
  </section>
  
  <!-- MARKET -->
  <section id="market" class="section">
    <div class="panel-box">
      <h2 style="text-align:center">COMMUNITY MARKET</h2>
      <p style="text-align:center;color:var(--text-muted);margin-bottom:20px">List your skins for sale and buy from others.</p>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
        <div>
          <h3 style="text-align:center;color:var(--gold-2)">LIST A SKIN</h3>
          <div id="market-sell" style="display:flex;flex-direction:column;gap:10px">
            <!-- Populated by JS -->
          </div>
        </div>
        <div>
          <h3 style="text-align:center;color:var(--gold-2)">MARKET LISTINGS</h3>
          <div class="achievements-grid" id="market-grid">
            <!-- Populated by JS -->
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- SLOTS -->
  <section id="slots" class="section">
    <div class="slot-machine-modern">
      <div class="win-line" id="slot-win-line"></div>
      <div class="reels-container-3d">
        <div class="reel-3d-col"><div class="reel-strip" id="reel-0"></div></div>
        <div class="reel-3d-col"><div class="reel-strip" id="reel-1"></div></div>
        <div class="reel-3d-col"><div class="reel-strip" id="reel-2"></div></div>
      </div>
    
      <div class="slot-controls">
        <div class="panel-box" style="padding:15px;min-width:150px;text-align:center;background:rgba(0,0,0,0.5)">
          <label style="display:block;color:var(--gold-4);font-size:12px;margin-bottom:5px">BALANCE</label>
          <div style="font-size:18px;font-weight:700;color:var(--gold-2)">V$<span id="slot-bal-disp">0</span></div>
        </div>

        <div class="panel-box" style="padding:15px;min-width:150px;text-align:center;background:rgba(0,0,0,0.5)">
          <label style="display:block;color:var(--gold-4);font-size:12px;margin-bottom:5px">BET AMOUNT</label>
          <select id="slot-bet" class="form-control" style="text-align:center;font-weight:700;color:var(--gold-2);background:transparent;border:none">
            <option value="10">V$10</option>
            <option value="50">V$50</option>
            <option value="100">V$100</option>
            <option value="500">V$500</option>
          </select>
        </div>
        
        <div style="display:flex; flex-direction:column; align-items:center; gap:15px; position:relative; z-index:5">
          <button id="spin-btn" class="spin-btn-lg">SPIN</button>
          <button id="auto-spin-btn" class="auto-spin-btn">AUTO OFF</button>
        </div>
        
        <div class="panel-box" style="padding:15px;min-width:150px;text-align:center;background:rgba(0,0,0,0.5)">
           <label style="display:block;color:var(--gold-4);font-size:12px;margin-bottom:5px">LAST WIN</label>
           <div id="last-win" style="font-size:24px;font-weight:700;color:var(--success)">V$0</div>
        </div>
      </div>
      
      <div style="text-align:center;margin-top:20px">
        <button class="gold-btn secondary" onclick="document.getElementById('paytable-modal').classList.add('active')">View Paytable</button>
      </div>
    </div>
  </section>

  <!-- PLINKO -->
  <section id="plinko" class="section">
    <div class="panel-box" style="text-align:center">
      <h2>GOLDEN PLINKO</h2>
      <p style="color:var(--text-muted)">Drop the ball and multiply your riches.</p>
      <div style="margin:20px 0">
        <canvas id="plinko-canvas" width="600" height="500" class="plinko-board"></canvas>
      </div>
      <div style="display:flex;justify-content:center;gap:20px;align-items:center">
        <div class="panel-box" style="padding:10px 20px;min-width:120px;text-align:center">
           <small style="color:var(--gold-4)">BALANCE</small>
           <div style="font-weight:700;color:var(--gold-2)">V$<span id="plinko-bal-disp">0</span></div>
        </div>
        <select id="plinko-bet" class="form-control" style="width:120px">
          <option value="10">V$10</option>
          <option value="50">V$50</option>
          <option value="100">V$100</option>
        </select>
        <button id="plinko-drop" class="gold-btn">DROP BALL</button>
      </div>
    </div>
  </section>

  <!-- WHEEL -->
  <section id="wheel" class="section">
    <div class="panel-box" style="text-align:center">
      <h2>DAILY ROYAL WHEEL</h2>
      <div class="wheel-container" style="position:relative;display:inline-block">
        <canvas id="wheel-canvas" width="400" height="400"></canvas>
        <div class="wheel-pointer"></div>
      </div>
      <div style="margin-top:30px">
        <button id="wheel-spin-btn" class="gold-btn">SPIN NOW</button>
        <div id="wheel-timer" style="margin-top:10px;color:var(--gold-4);font-family:monospace;font-size:18px"></div>
      </div>
    </div>
  </section>

  <!-- ACHIEVEMENTS / PROFILE -->
  <section id="achievements" class="section">
    <div class="panel-box">
      <h2>YOUR LEGACY</h2>
      <div class="grid-cols-2">
        <div>
          <h3>Stats</h3>
          <p>Current Level: <strong id="stats-lvl" style="color:var(--gold-2)">1</strong></p>
          <p>Total XP: <strong id="stats-xp" style="color:var(--gold-2)">0</strong></p>
          <p>Total Spins: <strong id="stats-spins" style="color:var(--gold-2)">0</strong></p>
        </div>
        <div>
          <h3>Achievements</h3>
          <div class="achievements-grid" id="ach-list">
            <!-- Populated by JS -->
          </div>
        </div>
      </div>
      
      <div style="margin-top:30px;border-top:1px solid rgba(255,255,255,0.1);padding-top:20px">
        <h3>Wardrobe & Customization</h3>
        <p style="color:var(--text-muted);font-size:12px;margin-bottom:15px">Equip your VIP items here.</p>
        <div class="achievements-grid" id="wardrobe-grid">
           <!-- Populated by JS -->
        </div>
      </div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="settings" class="section">
    <div class="panel-box" style="max-width:600px;margin:0 auto">
      <h2>SETTINGS</h2>
      
      <div class="form-group">
        <label>Master Volume</label>
        <input type="range" id="vol-slider" min="0" max="100" value="30" style="width:100%">
      </div>

      <div class="form-group">
        <label>Casino Ambience</label>
        <div style="display:flex;align-items:center;gap:10px">
          <button id="music-toggle" class="gold-btn secondary" style="flex:1">Turn On Music</button>
        </div>
        <small style="color:var(--text-muted)">Plays Chill Gaming Music Mix.</small>
      </div>

      <button class="gold-btn" onclick="app.saveSettings()">Save Preferences</button>
    </div>
  </section>

  <!-- SHOP -->
  <section id="shop" class="section">
    <div class="panel-box">
      <h2 style="text-align:center">ROYAL SHOP</h2>
      <p style="text-align:center;color:var(--text-muted);margin-bottom:30px">Purchase exclusive perks to enhance your winning potential.</p>
      
      <div class="achievements-grid" id="shop-grid">
        <!-- Populated by JS -->
      </div>
    </div>
  </section>

  <!-- VIP SHOP -->
  <section id="vip-shop" class="section">
    <div class="panel-box">
      <h2 style="text-align:center; color:var(--gold-1)">VIP BOUTIQUE</h2>
      <p style="text-align:center;color:var(--gold-4);margin-bottom:30px">Exclusive customization for the elite.</p>
      
      <div class="achievements-grid" id="vip-shop-grid">
        <!-- Populated by JS -->
      </div>
    </div>
  </section>

  <!-- INVENTORY -->
  <section id="inventory" class="section">
    <div class="panel-box">
      <h2 style="text-align:center">YOUR VAULT</h2>
      <p style="text-align:center;color:var(--text-muted);margin-bottom:30px">Manage your active perks and upgrades.</p>
      
      <div class="achievements-grid" id="inventory-grid">
        <!-- Populated by JS -->
      </div>
    </div>
  </section>

  <!-- LOGIN / REGISTER -->
  <section id="login" class="section">
    <div class="panel-box" style="max-width:400px;margin:0 auto">
      <h2 id="auth-title">Access Royal Club</h2>
      
      <div id="login-form">
        <div class="form-group"><label>Email</label><input type="email" id="auth-email" class="form-control"></div>
        <div class="form-group"><label>Password</label><input type="password" id="auth-pass" class="form-control"></div>
        <button class="gold-btn" style="width:100%" onclick="app.login()">ENTER</button>
        <p style="text-align:center;margin-top:15px;font-size:14px">
          New here? <a href="#" style="color:var(--gold-2)" onclick="app.toggleAuthMode()">Join the Club</a>
        </p>
      </div>

      <div id="register-form" class="hidden">
        <div class="form-group"><label>Full Name</label><input type="text" id="reg-name" class="form-control"></div>
        <div class="form-group"><label>Email</label><input type="email" id="reg-email" class="form-control"></div>
        <div class="form-group"><label>Password</label><input type="password" id="reg-pass" class="form-control"></div>
        <button class="gold-btn" style="width:100%" onclick="app.register()">JOIN CLUB NOW</button>
        <p style="text-align:center;margin-top:15px;font-size:14px">
          Already a member? <a href="#" style="color:var(--gold-2)" onclick="app.toggleAuthMode()">Login</a>
        </p>
      </div>

      <div id="auth-msg" style="text-align:center;margin-top:10px"></div>
    </div>
  </section>

  <!-- Blackjack Game -->
  <section id="blackjack" class="section">
    <div class="bj-table" id="blackjack-game">
      <div id="bj-deck" class="bj-deck"></div>
      
      <div id="bj-msg" class="win-modal" style="display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:20;background:rgba(0,0,0,0.9);padding:30px;border:2px solid var(--gold-2);text-align:center;border-radius:10px">
         <h2 id="bj-result-text" style="font-size:36px;margin-bottom:10px;color:#fff;text-shadow:0 0 10px gold">YOU WIN</h2>
         <div id="bj-win-amount" style="font-size:24px;color:var(--gold-1);margin-bottom:20px">V$ 100</div>
         <button class="gold-btn" onclick="Blackjack.reset()">PLAY AGAIN</button>
      </div>

      <div class="game-container" style="height:100%;display:flex;flex-direction:column;justify-content:space-between;position:relative;z-index:10">
         <!-- Dealer Area -->
         <div style="text-align:center;padding-top:20px">
             <div style="margin-bottom:10px;color:rgba(255,255,255,0.7);font-weight:bold;text-transform:uppercase;letter-spacing:1px">Dealer <span id="bj-dealer-score" style="background:rgba(0,0,0,0.5);padding:2px 8px;border-radius:10px;margin-left:5px;border:1px solid rgba(255,255,255,0.2)">0</span></div>
             <div id="bj-dealer-cards" style="display:flex;justify-content:center;height:120px;perspective:1000px"></div>
         </div>
         
         <!-- Player Area -->
         <div style="text-align:center;padding-bottom:120px">
             <div id="bj-player-cards" style="display:flex;justify-content:center;height:120px;margin-bottom:15px;perspective:1000px"></div>
             <div style="margin-bottom:10px;color:rgba(255,255,255,0.7);font-weight:bold;text-transform:uppercase;letter-spacing:1px">You <span id="bj-player-score" style="background:rgba(0,0,0,0.5);padding:2px 8px;border-radius:10px;margin-left:5px;border:1px solid rgba(255,255,255,0.2)">0</span></div>
         </div>
      </div>

      <!-- Controls -->
      <div class="controls-area" style="position:absolute;bottom:20px;left:0;width:100%;display:flex;justify-content:center;z-index:15">
         
         <!-- Betting Controls -->
         <div id="bj-bet-controls" style="display:flex;flex-direction:column;align-items:center;gap:15px;background:rgba(0,0,0,0.8);padding:15px;border-radius:20px;border:1px solid var(--gold-3)">
             <div style="color:var(--gold-2);font-weight:bold">PLACE YOUR BET</div>
             <div style="display:flex;gap:15px">
                 <div class="bj-chip chip-10" onclick="Blackjack.addBet(10)">10</div>
                 <div class="bj-chip chip-50" onclick="Blackjack.addBet(50)">50</div>
                 <div class="bj-chip chip-100" onclick="Blackjack.addBet(100)">100</div>
                 <div class="bj-chip chip-500" onclick="Blackjack.addBet(500)">500</div>
             </div>
             <div style="display:flex;gap:10px;align-items:center">
                <div style="background:#fff;color:#000;padding:5px 15px;border-radius:5px;font-weight:bold">V$ <span id="bj-current-bet">0</span></div>
                <button class="gold-btn" onclick="Blackjack.deal()">DEAL</button>
                <button class="gold-btn secondary" onclick="Blackjack.clearBet()" style="padding:8px">Clear</button>
             </div>
         </div>

         <!-- Play Controls -->
         <div id="bj-play-controls" style="display:none;gap:20px">
             <button class="bj-action-btn" onclick="Blackjack.hit()">HIT</button>
             <button class="bj-action-btn stand" onclick="Blackjack.stand()">STAND</button>
         </div>
      </div>
      
      <div style="position:absolute;top:20px;right:20px;background:rgba(0,0,0,0.6);padding:5px 10px;border-radius:5px;color:var(--gold-2);font-weight:bold;border:1px solid var(--gold-3)">
          Balance: V$ <span id="bj-balance">0</span>
      </div>
    </div>
  </section>

  <!-- MINES Game -->
  <section id="mines" class="section">
    <div class="panel-box" style="max-width:800px; margin:0 auto; display:flex; gap:20px; align-items:flex-start">
        
        <!-- Controls -->
        <div style="width:250px; flex-shrink:0; background:rgba(0,0,0,0.3); padding:20px; border-radius:10px; border:1px solid var(--gold-5)">
            <h3 style="color:var(--gold-1); margin-bottom:20px; text-align:center">CONTROLS</h3>
            
            <div class="form-group">
                <label>Bet Amount</label>
                <div style="display:flex; gap:5px; margin-bottom:5px">
                    <button class="gold-btn secondary" style="padding:5px 10px; font-size:10px" onclick="Mines.setBet(10)">10</button>
                    <button class="gold-btn secondary" style="padding:5px 10px; font-size:10px" onclick="Mines.setBet(50)">50</button>
                    <button class="gold-btn secondary" style="padding:5px 10px; font-size:10px" onclick="Mines.setBet(100)">100</button>
                    <button class="gold-btn secondary" style="padding:5px 10px; font-size:10px" onclick="Mines.setBet('max')">MAX</button>
                </div>
                <input type="number" id="mines-bet" class="form-control" value="10">
            </div>

            <div class="form-group">
                <label>Mines (1-24)</label>
                <input type="range" id="mines-count" min="1" max="24" value="3" class="form-control" oninput="document.getElementById('mines-count-val').textContent=this.value">
                <div style="text-align:right; color:var(--gold-2); font-weight:bold" id="mines-count-val">3</div>
            </div>

            <button id="mines-start-btn" class="gold-btn" style="width:100%; height:50px; font-size:18px" onclick="Mines.start()">BET</button>
            <button id="mines-cashout-btn" class="gold-btn" style="width:100%; height:50px; font-size:18px; display:none; background:#2ecc71; border-color:#27ae60; color:#fff" onclick="Mines.cashout()">
                CASHOUT <br><span id="mines-cashout-val" style="font-size:14px">V$ 0</span>
            </button>

            <div style="margin-top:20px; text-align:center">
                <div style="font-size:12px; color:var(--text-muted)">Next Multiplier</div>
                <div id="mines-next-mult" style="font-size:20px; color:var(--gold-2); font-weight:bold">1.13x</div>
            </div>
            <div style="margin-top:10px; text-align:center; font-size:12px; color:var(--text-muted)">
                Balance: V$<span id="mines-balance">0</span>
            </div>
        </div>

        <!-- Grid -->
        <div style="flex:1; display:flex; flex-direction:column; align-items:center">
            <div id="mines-grid" style="display:grid; grid-template-columns:repeat(5, 1fr); gap:10px; width:100%; max-width:500px; aspect-ratio:1">
                <!-- Tiles generated by JS -->
            </div>

            <!-- History Bar -->
            <div style="width:100%; max-width:500px; margin-top:20px; background:rgba(0,0,0,0.5); border-radius:10px; padding:10px; border:1px solid #333">
                 <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px">
                     <span style="font-size:10px; color:#888; text-transform:uppercase; letter-spacing:1px">History (Last 4 Cashouts)</span>
                 </div>
                 <div id="mines-history" style="display:flex; gap:10px; justify-content:flex-start">
                     <div style="font-size:12px; color:#444; font-style:italic">No cashouts yet</div>
                 </div>
            </div>
        </div>
    </div>
  </section>

  <!-- Terms & Conditions -->
  <section id="terms" class="section">
    <div class="panel-box" style="max-width:800px; margin:0 auto">
        <h2 style="color:var(--gold-1); text-align:center; margin-bottom:30px; font-family:var(--font-heading)">TERMS & CONDITIONS</h2>
        
        <div style="height:400px; overflow-y:auto; padding-right:15px; margin-bottom:30px; color:#ccc; line-height:1.6; font-size:14px">
            <h3 style="color:var(--gold-2); margin-top:0">1. Introduction</h3>
            <p>Welcome to Vegas Gold. By accessing our application, you agree to be bound by these Terms & Conditions. Please read them carefully.</p>

            <h3 style="color:var(--gold-2)">2. Virtual Currency</h3>
            <p>Vegas Gold is a social casino game intended for entertainment purposes only. The virtual currency ("V$") used in the game has no real-world monetary value and cannot be exchanged for real money or prizes.</p>

            <h3 style="color:var(--gold-2)">3. Eligibility</h3>
            <p>You must be at least 18 years of age to access and use Vegas Gold. By using the service, you warrant that you are of legal age.</p>

            <h3 style="color:var(--gold-2)">4. Fair Play</h3>
            <p>Users agree not to use cheats, exploits, automation software (bots), or any unauthorized third-party software to modify or interfere with the Service.</p>

            <h3 style="color:var(--gold-2)">5. Account Security</h3>
            <p>You are responsible for maintaining the confidentiality of your account information. Vegas Gold is not liable for any loss resulting from unauthorized access to your account.</p>

            <h3 style="color:var(--gold-2)">6. Changes to Terms</h3>
            <p>We reserve the right to modify these terms at any time. Continued use of the service constitutes acceptance of the modified terms.</p>
        </div>

        <div style="text-align:center">
            <button class="gold-btn" onclick="app.nav('home')">BACK TO HOME</button>
        </div>
    </div>
  </section>

  <!-- Privacy Policy -->
  <section id="privacy" class="section">
    <div class="panel-box" style="max-width:800px; margin:0 auto">
        <h2 style="color:var(--gold-1); text-align:center; margin-bottom:30px; font-family:var(--font-heading)">PRIVACY POLICY</h2>
        
        <div style="height:400px; overflow-y:auto; padding-right:15px; margin-bottom:30px; color:#ccc; line-height:1.6; font-size:14px">
            <h3 style="color:var(--gold-2); margin-top:0">1. Data Collection</h3>
            <p>We collect limited information necessary to provide the service, including username, gameplay data, and device information.</p>

            <h3 style="color:var(--gold-2)">2. Use of Information</h3>
            <p>Your data is used to maintain your account, improve game features, and ensure fair play. We do not sell your personal data to third parties.</p>

            <h3 style="color:var(--gold-2)">3. Cookies & Local Storage</h3>
            <p>We use local storage to save your game progress and preferences on your device. No tracking cookies are used for advertising purposes.</p>

            <h3 style="color:var(--gold-2)">4. Data Security</h3>
            <p>We implement appropriate security measures to protect your data. However, no transmission over the internet is completely secure.</p>

            <h3 style="color:var(--gold-2)">5. Children's Privacy</h3>
            <p>Our service is not directed to children under 13. We do not knowingly collect personal information from children under 13.</p>

            <h3 style="color:var(--gold-2)">6. Contact Us</h3>
            <p>If you have questions about this Privacy Policy, please contact us through our support channels.</p>
        </div>

        <div style="text-align:center">
            <button class="gold-btn" onclick="app.nav('home')">BACK TO HOME</button>
        </div>
    </div>
  </section>

</main>



<!-- Game Info Modal -->
<div id="game-info-modal" class="modal-overlay">
  <div class="modal-content" style="max-width:500px; text-align:center;">
    <h2 id="game-info-title" style="color:var(--gold-1);margin-bottom:15px;text-shadow:0 0 10px var(--gold-3)">GAME TITLE</h2>
    <p id="game-info-desc" style="margin-bottom:20px;line-height:1.6;color:#ccc"></p>
    <div style="margin-bottom:20px;display:flex;align-items:center;justify-content:center;gap:10px">
      <input type="checkbox" id="game-info-check" style="width:20px;height:20px;cursor:pointer">
      <label for="game-info-check" style="cursor:pointer">Don't show this again</label>
    </div>
    <button class="gold-btn" onclick="app.closeGameInfo()">PLAY NOW</button>
  </div>
</div>

<!-- Daily Reward Modal -->
<div id="daily-modal" class="modal-overlay">
  <div class="modal-content" style="text-align:center;border:2px solid var(--gold-1);box-shadow:0 0 50px rgba(191,149,63,0.2);max-width:400px;position:relative">
    <button class="modal-close-btn" onclick="document.getElementById('daily-modal').classList.remove('active')"></button>
    <h2 style="color:var(--gold-1);font-size:32px;margin-bottom:10px;font-family:var(--font-heading)">DAILY REWARD</h2>
    <p style="color:#aaa;margin-bottom:20px;font-size:12px">Timezone: Eastern European Time (EET)</p>
    
    <div style="background:radial-gradient(circle, rgba(191,149,63,0.2) 0%, transparent 70%);padding:20px">
        <div style="font-size:48px;color:#fff;text-shadow:0 0 20px var(--gold-1)">V$ 1,000</div>
    </div>
    
    <div id="daily-challenge-box" style="background:rgba(255,255,255,0.05);padding:15px;margin:20px 0;border-radius:8px;text-align:left">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <h3 style="margin:0;color:var(--gold-2);font-size:16px">Daily Challenge</h3>
          <span style="font-size:10px;background:var(--gold-5);padding:2px 6px;border-radius:4px;color:#000;font-weight:bold">NEW</span>
      </div>
      <p id="daily-challenge-text" style="margin:0 0 10px 0;color:#ddd;font-size:14px">Spin 50 times in Slots</p>
      <div style="background:#000;height:6px;border-radius:3px;overflow:hidden">
        <div id="daily-challenge-bar" style="width:0%;height:100%;background:var(--success);transition:width 0.5s"></div>
      </div>
      <p id="daily-challenge-progress" style="margin:5px 0 0 0;font-size:10px;color:#888;text-align:right">0 / 50</p>
    </div>
    
    <button class="gold-btn" onclick="Daily.claim()" style="width:100%;font-size:18px;padding:15px">CLAIM REWARD</button>
  </div>
</div>

<!-- Paytable Modal -->
<div id="paytable-modal" class="modal-overlay" onclick="if(event.target===this)this.classList.remove('active')">
  <div class="modal-content" style="position:relative">
    <button class="modal-close-btn" onclick="document.getElementById('paytable-modal').classList.remove('active')"></button>
    <h2 style="text-align:center;margin-bottom:20px;color:var(--gold-1);text-shadow:0 0 10px var(--gold-3)">PAYTABLE</h2>
    <div class="pay-row">
      <div style="display:flex;align-items:center;gap:10px"><svg class="slot-icon" style="width:30px;height:30px"><use href="#icon-7"/></svg> 3x 777</div>
      <strong style="color:var(--gold-2)">500x</strong>
    </div>
    <div class="pay-row">
      <div style="display:flex;align-items:center;gap:10px"><svg class="slot-icon" style="width:30px;height:30px"><use href="#icon-diamond"/></svg> 3x Diamond</div>
      <strong style="color:var(--gold-2)">200x</strong>
    </div>
    <div class="pay-row">
      <div style="display:flex;align-items:center;gap:10px"><svg class="slot-icon" style="width:30px;height:30px"><use href="#icon-crown"/></svg> 3x Crown</div>
      <strong style="color:var(--gold-2)">100x</strong>
    </div>
    <div class="pay-row">
      <div style="display:flex;align-items:center;gap:10px"><svg class="slot-icon" style="width:30px;height:30px"><use href="#icon-bell"/></svg> 3x Bell</div>
      <strong style="color:var(--gold-2)">50x</strong>
    </div>
    <div class="pay-row">
      <div style="display:flex;align-items:center;gap:10px"><svg class="slot-icon" style="width:30px;height:30px"><use href="#icon-bar"/></svg> 3x Bar</div>
      <strong style="color:var(--gold-2)">25x</strong>
    </div>
    <div class="pay-row">
      <div style="display:flex;align-items:center;gap:10px"><svg class="slot-icon" style="width:30px;height:30px"><use href="#icon-cherry"/></svg> 3x Cherry</div>
      <strong style="color:var(--gold-2)">10x</strong>
    </div>
  </div>
</div>

<!-- Win Overlay -->
<div id="big-win" class="big-win">
  <h1 class="win-title">BIG WIN</h1>
  <div class="win-val" id="win-overlay-val">V$0</div>
  <button class="gold-btn" style="margin-top:40px" onclick="document.getElementById('big-win').classList.remove('active')">COLLECT</button>
</div>

<!-- Toasts -->
<div class="toast-container" id="toasts"></div>

<!-- Profile Modal -->
<div id="profile-modal" class="modal-overlay">
  <div class="modal-content" style="max-width:500px; text-align:center;">
    <button class="modal-close-btn" onclick="ProfileSystem.closeModal()"></button>
    <h2 style="color:var(--gold-1);margin-bottom:20px;font-family:var(--font-heading)">CUSTOMIZE PROFILE</h2>
    
    <div style="margin-bottom:30px">
        <div style="width:100px;height:100px;margin:0 auto 10px auto;border-radius:50%;overflow:hidden;border:3px solid var(--gold-2);position:relative;background:#111">
            <img id="profile-avatar-preview" src="" style="width:100%;height:100%;object-fit:cover;display:none">
            <div id="profile-avatar-placeholder" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:40px;color:#333">ðŸ‘¤</div>
        </div>
        <button class="gold-btn secondary" onclick="document.getElementById('avatar-upload').click()" style="padding:5px 10px; font-size:12px">UPLOAD PHOTO</button>
        <input type="file" id="avatar-upload" accept="image/png, image/jpeg, image/webp" style="display:none" onchange="ProfileSystem.handleAvatarUpload(this)">
        <p style="font-size:10px;color:#666;margin-top:5px">Max 2MB. JPG, PNG, WEBP.</p>
    </div>
    
    <div class="panel-box" style="text-align:left; padding:20px; margin-bottom:20px">
        <label style="display:block;color:var(--gold-4);font-size:12px;margin-bottom:5px">DISPLAY NAME</label>
        <div style="display:flex;gap:10px">
            <input type="text" id="profile-name-input" class="form-control" style="flex:1" maxlength="30">
            <button class="gold-btn" onclick="ProfileSystem.changeName()" style="white-space:nowrap">
                CHANGE (100 ðŸ’Ž)
            </button>
        </div>
        <p id="name-error" style="font-size:11px;color:var(--danger);margin-top:5px;display:none"></p>
    </div>
    
    <div style="text-align:left; margin-bottom:20px">
        <h3 style="color:var(--gold-2);font-size:14px;margin-bottom:10px">Recent Activity</h3>
        <div id="profile-audit-log" style="height:100px;overflow-y:auto;background:rgba(0,0,0,0.3);padding:10px;border-radius:4px;font-size:11px;color:#aaa">
            <!-- Logs -->
        </div>
    </div>

  </div>
</div>

<script>
/**
 * AUDIO ENGINE
 * Synthesizes sounds to avoid external dependencies.
 */
const AudioEngine = {
  ctx: new (window.AudioContext || window.webkitAudioContext)(),
  masterVol: 0.3,
  musicPlaying: false,
  musicInterval: null,
  
  init() {
    // Resume context if needed
    document.addEventListener('click', () => {
      if (this.ctx.state === 'suspended') this.ctx.resume();
    }, {once:true});
  },
  
  startMusic() {
    if(this.ctx.state === 'suspended') this.ctx.resume();
    
    if(!this.musicEl) {
      // TODO: Replace with a valid direct MP3 link or local file (e.g., 'assets/music.mp3')
      // The previous background music link has expired.
      this.musicEl = new Audio(''); 
      this.musicEl.loop = true;
    }
    
    // Set initial volume to 0 for fade in
    this.musicEl.volume = 0;
    this.musicEl.play().catch(e => console.log("Audio play error:", e));
    this.musicPlaying = true;
    
    // Fade in to 15% (0.15) over 2 seconds
    const targetVol = 0.15;
    this.masterVol = targetVol; // Set internal master to 15%
    
    // Update slider if it exists
    const slider = document.getElementById('vol-slider');
    if(slider) slider.value = 15;
    
    let vol = 0;
    const fade = setInterval(() => {
      vol += 0.01;
      if(vol >= targetVol) {
        vol = targetVol;
        clearInterval(fade);
      }
      if(this.musicEl) this.musicEl.volume = vol;
    }, 100);
    
    // Update button state
    const btn = document.getElementById('music-toggle');
    if(btn) {
       btn.textContent = "Turn Off Music";
       btn.classList.remove('secondary');
    }
  },
  playTone(freq, type, duration, vol=0.1, fade=true) {
    if(this.ctx.state === 'suspended') this.ctx.resume();
    const t = this.ctx.currentTime;
    const osc = this.ctx.createOscillator();
    const gn = this.ctx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, t);
    gn.gain.setValueAtTime(vol * this.masterVol, t);
    if(fade) gn.gain.exponentialRampToValueAtTime(0.001, t + duration);
    osc.connect(gn);
    gn.connect(this.ctx.destination);
    osc.start(t);
    osc.stop(t + duration);
  },

  coinSound() { 
    const now = this.ctx.currentTime;
    if(this.lastCoin && now - this.lastCoin < 0.08) return; // Throttle: max 12 sounds/sec
    this.lastCoin = now;
    this.playTone(1200 + Math.random()*400, 'sine', 0.1, 0.1); 
  },
  winSound() { 
    [0, 0.1, 0.2].forEach((d, i) => this.playTone(400 + i*100, 'square', 0.3, 0.2)); 
    [0.3, 0.4, 0.5].forEach((d, i) => this.playTone(800 + i*100, 'triangle', 0.4, 0.2)); 
  },
  spinSound() { 
    const now = this.ctx.currentTime;
    if(this.lastSpin && now - this.lastSpin < 0.05) return;
    this.lastSpin = now;
    this.playTone(200, 'sawtooth', 0.05, 0.05); 
  },
  dramaticWin() {
    const t = this.ctx.currentTime;
    const osc = this.ctx.createOscillator();
    const gn = this.ctx.createGain();
    osc.type = 'triangle';
    osc.frequency.setValueAtTime(120, t);
    osc.frequency.exponentialRampToValueAtTime(600, t + 1.2);
    gn.gain.setValueAtTime(0.0001, t);
    gn.gain.exponentialRampToValueAtTime(0.2 * this.masterVol, t + 0.1);
    gn.gain.exponentialRampToValueAtTime(0.0001, t + 1.4);
    osc.connect(gn);
    gn.connect(this.ctx.destination);
    osc.start(t);
    osc.stop(t + 1.5);
    [0, 0.2, 0.4].forEach((d,i) => this.playTone(800 + i*200, 'sine', 0.2, 0.08));
  },
  chipSound() { this.playTone(1500, 'sine', 0.05, 0.05); },
  cardSound() { this.playTone(600, 'triangle', 0.05, 0.05); },
  wooshSound() {
    if(this.ctx.state === 'suspended') this.ctx.resume();
    const t = this.ctx.currentTime;
    const osc = this.ctx.createOscillator();
    const gn = this.ctx.createGain();
    
    // Low frequency sweep for "woosh"
    osc.frequency.setValueAtTime(200, t);
    osc.frequency.exponentialRampToValueAtTime(50, t + 0.5);
    
    gn.gain.setValueAtTime(0, t);
    gn.gain.linearRampToValueAtTime(0.3 * this.masterVol, t + 0.1);
    gn.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
    
    osc.connect(gn);
    gn.connect(this.ctx.destination);
    osc.start(t);
    osc.stop(t + 0.5);
  },
  tickSound() { this.playTone(800, 'sine', 0.05, 0.05); },
  stopSound() { /* No-op for now */ },

  musicEl: null,
  toggleMusic() {
    if(!this.musicEl) {
      // TODO: Replace with a valid direct MP3 link or local file
      this.musicEl = new Audio(''); 
      this.musicEl.loop = true;
    }
    
    if(this.musicPlaying) {
      this.musicEl.pause();
      this.musicPlaying = false;
      return false;
    } else {
      this.musicEl.volume = this.masterVol;
      this.musicEl.play().catch(e => console.log("Audio play error:", e));
      this.musicPlaying = true;
      return true;
    }
  }
};
AudioEngine.init();

/**
 * DAILY REWARDS & CHALLENGES
 */
const Daily = {
  rewards: [1000, 2000, 3000, 5000, 10000],
  
  check() {
    // Current time in EET
    const now = new Date(new Date().toLocaleString("en-US", {timeZone: "Europe/Bucharest"}));
    const todayStr = now.toDateString(); // "Mon Jan 01 2024"
    
    if (app.data.lastDaily !== todayStr) {
        document.getElementById('daily-modal').classList.add('active');
        // Reset challenge if new day
        app.data.dailyProgress = 0;
    }
    
    // Update Challenge UI
    this.updateUI();
  },
  
  claim() {
    const now = new Date(new Date().toLocaleString("en-US", {timeZone: "Europe/Bucharest"}));
    app.data.lastDaily = now.toDateString();
    app.addBalance(1000);
    app.toast("Daily Reward Claimed: V$1000");
    document.getElementById('daily-modal').classList.remove('active');
    app.save();
  },
  
  updateProgress(amount) {
      if (app.data.dailyProgress >= 50) return;
      app.data.dailyProgress += amount;
      if (app.data.dailyProgress >= 50) {
          app.data.dailyProgress = 50;
          app.addBalance(500); // Challenge Reward
          app.toast("Daily Challenge Completed: V$500", "Success");
      }
      this.updateUI();
      app.save();
  },
  
  updateUI() {
      const p = app.data.dailyProgress || 0;
      const pct = (p / 50) * 100;
      document.getElementById('daily-challenge-bar').style.width = pct + '%';
      document.getElementById('daily-challenge-progress').textContent = `${p} / 50`;
  }
};

/**
 * SOCIAL SYSTEM
 */
const Social = {
  chatMessages: [],
  leaderboard: [],
  
  init() {
    if (!app.data.profileCode) {
        app.data.profileCode = Math.random().toString(36).substring(2, 6).toUpperCase();
        app.save();
    }
    document.getElementById('my-profile-code').textContent = app.data.profileCode;
    this.renderFriends();
    
    // Seed initial chat
    this.chatMessages = [
        { user: 'System', msg: 'Welcome to Global Chat!', type: 'system' },
        { user: 'LadyLuck', msg: 'Just hit a massive win on Plinko!', type: 'user' },
        { user: 'CardShark', msg: 'Anyone up for Blackjack?', type: 'user' }
    ];
    this.renderChat();
    
    // Seed leaderboard
    this.leaderboard = [
        { name: 'CasinoKing', score: 1500000 },
        { name: 'JackpotJill', score: 1200000 },
        { name: 'HighRoller99', score: 950000 },
        { name: 'LuckyStrike', score: 800000 },
        { name: 'ChipMaster', score: 500000 }
    ];
    this.renderLeaderboard();
  },
  
  switchTab(tab) {
      ['friends', 'chat', 'leaderboard'].forEach(t => {
          document.getElementById('social-tab-' + t).style.display = (t === tab) ? 'block' : 'none';
      });
      // Update button styles (optional, but good for UX)
      // For now just toggle visibility
  },
  
  sendMessage() {
      const input = document.getElementById('chat-input');
      const msg = input.value.trim();
      if(!msg) return;
      
      this.chatMessages.push({ 
          user: app.user ? app.user.name : 'Guest', 
          msg: msg, 
          type: 'user',
          self: true
      });
      
      input.value = '';
      this.renderChat();
      
      // Mock reply
      if(Math.random() > 0.7) {
          setTimeout(() => {
               const bots = ['Dealer', 'PitBoss', 'VegasBot'];
               const replies = ['Nice!', 'Good luck!', 'Wow!', 'Keep it up!'];
               this.chatMessages.push({
                   user: bots[Math.floor(Math.random()*bots.length)],
                   msg: replies[Math.floor(Math.random()*replies.length)],
                   type: 'user'
               });
               this.renderChat();
          }, 2000);
      }
  },
  
  renderChat() {
      const el = document.getElementById('chat-messages');
      if(!el) return;
      el.innerHTML = '';
      this.chatMessages.slice(-20).forEach(m => {
          const div = document.createElement('div');
          div.style.padding = '5px';
          div.style.borderRadius = '4px';
          div.style.background = m.type === 'system' ? 'rgba(255,215,0,0.1)' : (m.self ? 'rgba(255,255,255,0.1)' : 'transparent');
          
          const nameColor = m.type === 'system' ? 'var(--gold-2)' : (m.self ? '#fff' : '#aaa');
          
          div.innerHTML = `
            <span style="color:${nameColor};font-weight:bold;font-size:10px">${m.user}:</span>
            <span style="color:#ddd">${m.msg}</span>
          `;
          el.appendChild(div);
      });
      el.scrollTop = el.scrollHeight;
  },
  
  renderLeaderboard() {
      const el = document.getElementById('leaderboard-list');
      if(!el) return;
      el.innerHTML = '';
      
      // Add current user if not in list
      const userEntry = { name: app.user ? app.user.name : 'You', score: app.data.balance, highlight: true };
      const sorted = [...this.leaderboard, userEntry].sort((a,b) => b.score - a.score);
      
      sorted.slice(0, 10).forEach((p, i) => {
          const div = document.createElement('div');
          div.style.display = 'flex';
          div.style.justifyContent = 'space-between';
          div.style.padding = '8px';
          div.style.borderBottom = '1px solid #333';
          if(p.highlight) div.style.background = 'rgba(255,215,0,0.1)';
          
          let rankColor = '#666';
          if(i===0) rankColor = 'var(--gold-1)';
          if(i===1) rankColor = '#c0c0c0';
          if(i===2) rankColor = '#cd7f32';
          
          div.innerHTML = `
            <div style="display:flex;gap:10px">
                <span style="color:${rankColor};font-weight:bold;width:20px">${i+1}.</span>
                <span style="color:${p.highlight ? '#fff' : '#aaa'}">${p.name}</span>
            </div>
            <div style="color:var(--gold-2)">V$ ${p.score.toLocaleString()}</div>
          `;
          el.appendChild(div);
      });
  },

  addFriend() {
      const input = document.getElementById('friend-code-input');
      const code = input.value.trim().toUpperCase();
      
      if (!code || code.length !== 4) {
          app.toast("Invalid Friend Code", "Error");
          return;
      }
      
      if (code === app.data.profileCode) {
          app.toast("Cannot add yourself!", "Error");
          return;
      }
      
      if (app.data.friends.find(f => f.code === code)) {
          app.toast("Friend already added", "Error");
          return;
      }
      
      // Simulate adding friend (Mock Data with Cosmetics)
      const mockFriend = {
          code: code,
          name: "Player_" + code,
          balance: Math.floor(Math.random() * 50000) + 1000,
          favorite: ['Slots', 'Plinko', 'Blackjack'][Math.floor(Math.random() * 3)],
          equipped: {
              frame: Math.random() > 0.5 ? ['frame_gold', 'frame_diamond', 'frame_neon'][Math.floor(Math.random()*3)] : null,
              tag: Math.random() > 0.5 ? ['tag_high_roller', 'tag_whale', 'tag_vip'][Math.floor(Math.random()*3)] : null
          }
      };
      
      app.data.friends.push(mockFriend);
      app.save();
      this.renderFriends();
      input.value = "";
      app.toast("Friend Added!");
  },
  
  renderFriends() {
      const list = document.getElementById('friends-list');
      list.innerHTML = "";
      
      if (!app.data.friends || app.data.friends.length === 0) {
          list.innerHTML = '<p style="text-align:center;color:#666;font-style:italic">No friends added yet.</p>';
          return;
      }
      
      app.data.friends.forEach(f => {
          const frameClass = f.equipped && f.equipped.frame ? f.equipped.frame.replace('_', '-') : '';
          const tagClass = f.equipped && f.equipped.tag ? f.equipped.tag.replace('_', '-') : '';
          const tagName = f.equipped && f.equipped.tag ? f.equipped.tag.replace('tag_', '').replace('_', ' ').toUpperCase() : '';
          
          const div = document.createElement('div');
          div.className = "panel-box";
          div.style.padding = "10px";
          div.style.background = "#1a1a1a";
          div.style.display = "flex";
          div.style.justifyContent = "space-between";
          div.style.alignItems = "center";
          
          div.innerHTML = `
            <div style="display:flex;align-items:center;gap:10px">
                <div class="level-badge ${frameClass}" style="position:static;width:30px;height:30px;font-size:12px;display:flex;align-items:center;justify-content:center">
                    ${f.name.charAt(0)}
                </div>
                <div>
                    <div style="color:#fff;font-weight:bold;display:flex;align-items:center">
                        ${f.name} <span style="color:#666;font-size:10px;margin-left:5px">#${f.code}</span>
                        ${tagClass ? `<span class="tag-badge ${tagClass}">${tagName}</span>` : ''}
                    </div>
                    <div style="color:var(--gold-2);font-size:12px">Fav: ${f.favorite}</div>
                </div>
            </div>
            <div style="text-align:right">
                <div style="color:var(--gold-1);font-weight:bold">V$ ${f.balance.toLocaleString()}</div>
                <div style="font-size:10px;color:var(--success)">Online</div>
            </div>
          `;
          list.appendChild(div);
      });
  }
};

/**
 * HOT STREAK SYSTEM
 */
const HotStreak = {
    count: 0,
    
    win() {
        this.count++;
        this.checkMilestones();
        this.updateUI();
    },
    
    loss() {
        if(this.count >= 3) {
            app.toast("Streak Broken!", "Info");
        }
        this.count = 0;
        this.updateUI();
        document.body.classList.remove('hot-mode');
    },
    
    checkMilestones() {
        if(this.count === 3) {
            app.addBalance(100);
            app.toast("Heating Up! +V$100", "Hot Streak");
            try { AudioEngine.winSound(); } catch(e){}
        }
        if(this.count === 5) {
            app.addBalance(500);
            app.toast("ON FIRE! +V$500", "Hot Streak");
            document.body.classList.add('hot-mode');
            try { AudioEngine.winSound(); } catch(e){}
        }
        if(this.count === 10) {
            app.addBalance(2000);
            app.toast("GODLIKE! +V$2000", "Hot Streak");
            try { Particles.spawnExplosion(window.innerWidth/2, window.innerHeight/2); } catch(e){}
            try { AudioEngine.winSound(); } catch(e){}
        }
    },
    
    updateUI() {
        const c = document.getElementById('streak-container');
        const fill = document.getElementById('streak-fill');
        const text = document.getElementById('streak-text');
        const mult = document.getElementById('streak-mult');
        
        if(!c) return;
        
        if(this.count > 0) {
            c.classList.add('active');
        } else {
            c.classList.remove('active');
        }
        
        // Max visual streak 10
        const pct = Math.min(100, (this.count / 10) * 100);
        fill.style.width = pct + '%';
        
        if(this.count >= 10) {
            text.textContent = "GODLIKE";
            text.style.color = "#ff0000";
            mult.textContent = "1.25x";
        } else if(this.count >= 5) {
            text.textContent = "ON FIRE";
            text.style.color = "#ff4500";
            mult.textContent = "1.10x";
        } else if(this.count >= 3) {
            text.textContent = "HEATING UP";
            text.style.color = "#ffd700";
            mult.textContent = "1.05x";
        } else {
            text.textContent = "HOT STREAK";
            text.style.color = "var(--gold-1)";
            mult.textContent = "1.0x";
        }
    },
    
    getMultiplier() {
        if(this.count >= 10) return 1.25;
        if(this.count >= 5) return 1.1;
        if(this.count >= 3) return 1.05;
        return 1.0;
    }
};

/**
 * CHANGELOG SYSTEM
 */
const Changelog = {
    entries: [
        {
            version: "1.3.4",
            date: "2026-01-06",
            changes: [
                "NEW CASES: Added Neon, Diamond, and Cyber Cases",
                "KEY SYSTEM: Cases now require specific Keys to open",
                "SHOP UPDATE: Purchase Keys directly from the Shop",
                "UI FIXES: Fixed Case Info Panel visibility and drop rates"
            ]
        },
        {
            version: "1.3.3",
            date: "2026-01-06",
            changes: [
                "MOBILE UPDATE: Vegas Case Shop is now fully playable on phones",
                "Responsive layout adjustments for smaller screens",
                "Optimized touch targets and navigation",
                "Fixed modal sizing for mobile devices"
            ]
        },
        {
            version: "1.3.2",
            date: "2026-01-06",
            changes: [
                "UI OVERHAUL: Brand new Vegas Case Shop design",
                "Added glassmorphism effects and hover animations",
                "Improved typography and layout for Case Cards",
                "CASE INFO: Click 'i' to see drop rates and contents",
                "Fixed 'Buy' button visibility and styling"
            ]
        },
        {
            version: "1.3.1",
            date: "2026-01-06",
            changes: [
                "Fixed Vegas Case Shop layout (horizontal alignment)",
                "Updated Case Shop buttons to 'Buy'",
                "Enabled opening Cases from Inventory",
                "Optimized Inventory Grid for Cases"
            ]
        },
        {
            version: "1.3.0",
            date: "2026-01-06",
            changes: [
                "INVENTORY 2.0: Added search, filters, and chronological sorting",
                "VEGAS CASES OVERHAUL: New 'Vegas Vault' shop UI and better animations",
                "CASE MECHANICS: Cases now go to inventory first (open them when you want)",
                "VISUALS: New particle effects, updated icons, and cleaner layouts",
                "MARKET: Items are now tradeable directly from inventory"
            ]
        },
        {
            version: "1.2.1",
            date: "2026-01-06",
            changes: [
                "Moved Hot Streak Meter below game UI for better visibility",
                "Cleaned up Main Menu: Removed text logo & emojis",
                "Fixed Top Menu alignment issues",
                "Added 'Updates' tab to view patch notes"
            ]
        },
        {
            version: "1.2.0",
            date: "2026-01-06",
            changes: [
                "Added HOT STREAK System",
                "Win streaks grant multipliers (up to 1.25x)",
                "Added visual effects for 3/5/10 win streaks",
                "Integrated streak logic into all games"
            ]
        },
        {
            version: "1.1.0",
            date: "2026-01-05",
            changes: [
                "Added VIP Shop with exclusive backgrounds",
                "Added Profile Name Tags",
                "Added Golden Arrow indicator to Daily Wheel",
                "Optimized Particle System"
            ]
        }
    ],

    init() {
        this.render();
    },

    open() {
        this.render();
        document.getElementById('changelog-modal').classList.add('active');
    },

    render() {
        const targets = [
            document.getElementById('changelog-list'),
            document.getElementById('changelog-list-modal')
        ];

        targets.forEach(list => {
            if (!list) return;
            list.innerHTML = '';

            this.entries.forEach(entry => {
                const item = document.createElement('div');
                item.style.marginBottom = "20px";
                item.style.borderBottom = "1px solid rgba(255,255,255,0.1)";
                item.style.paddingBottom = "15px";
                
                let html = `
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                        <span style="color:var(--gold-2);font-weight:bold;font-size:18px">v${entry.version}</span>
                        <span style="color:var(--gold-4);font-size:12px">${entry.date}</span>
                    </div>
                    <ul style="list-style:none;padding-left:10px">
                `;
                
                entry.changes.forEach(change => {
                    html += `<li style="color:#ddd;margin-bottom:5px;font-size:14px;display:flex;align-items:start">
                        <span style="color:var(--gold-3);margin-right:8px">âž¢</span> ${change}
                    </li>`;
                });
                
                html += `</ul></div>`;
                item.innerHTML = html;
                list.appendChild(item);
            });
        });
    }
};

/**
 * ROADMAP SYSTEM
 */
const Roadmap = {
    items: [
        { phase: "Phase 1", title: "Launch", desc: "Core games, VIP system, Shop", status: "completed" },
        { phase: "Phase 2", title: "Multiplayer", desc: "Live chat, PvP Blackjack, Leaderboards", status: "completed" },
        { phase: "Phase 3", title: "Expansion", desc: "Poker, Roulette, Mobile App", status: "in_progress" }
    ],
    
    init() {
        this.render();
    },

    render() {
        const list = document.getElementById('roadmap-list');
        if(!list) return;
        list.innerHTML = '';
        
        this.items.forEach(item => {
            const div = document.createElement('div');
            div.style.background = 'rgba(255,255,255,0.05)';
            div.style.padding = '10px';
            div.style.borderRadius = '4px';
            div.style.borderLeft = item.status === 'completed' ? '3px solid var(--success)' : (item.status === 'in_progress' ? '3px solid var(--gold-2)' : '3px solid #666');
            
            div.innerHTML = `
                <div style="font-size:12px;color:var(--gold-4);text-transform:uppercase;letter-spacing:1px;margin-bottom:2px">${item.phase}</div>
                <div style="font-weight:bold;color:#fff;margin-bottom:4px">${item.title}</div>
                <div style="font-size:11px;color:#aaa">${item.desc}</div>
            `;
            list.appendChild(div);
        });
    }
};

/**
 * BLACKJACK
 */
const Blackjack = {
    deck: [],
    dealerHand: [],
    playerHand: [],
    bet: 0,
    currentBet: 0,
    active: false,
    
    init() {
        this.currentBet = 0;
        this.updateUI();
    },
    
    createDeck() {
        const suits = ['spade', 'heart', 'club', 'diamond'];
        const values = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
        this.deck = [];
        for (let s of suits) {
            for (let v of values) {
                this.deck.push({ s, v });
            }
        }
        // Shuffle
        for (let i = this.deck.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [this.deck[i], this.deck[j]] = [this.deck[j], this.deck[i]];
        }
    },
    
    getCardValue(card) {
        if (['J', 'Q', 'K'].includes(card.v)) return 10;
        if (card.v === 'A') return 11;
        return parseInt(card.v);
    },
    
    calculate(hand) {
        let score = 0;
        let aces = 0;
        for (let c of hand) {
            score += this.getCardValue(c);
            if (c.v === 'A') aces++;
        }
        while (score > 21 && aces > 0) {
            score -= 10;
            aces--;
        }
        return score;
    },
    
    addBet(amount) {
        if (this.active) return;
        if (app.data.balance < this.currentBet + amount) {
            app.toast("Insufficient funds", "Error");
            return;
        }
        this.currentBet += amount;
        AudioEngine.chipSound();
        this.updateUI();
    },

    clearBet() {
        if (this.active) return;
        this.currentBet = 0;
        this.updateUI();
    },

    async deal() {
        if (this.active) return;
        if (this.currentBet === 0) {
            app.toast("Place a bet first!", "Error");
            return;
        }
        
        if (app.data.balance < this.currentBet) {
             app.toast("Insufficient funds", "Error");
             return;
        }

        app.addBalance(-this.currentBet);
        this.bet = this.currentBet;
        this.active = true;
        this.createDeck();
        this.playerHand = [];
        this.dealerHand = [];
        
        document.getElementById('bj-bet-controls').style.display = 'none';
        document.getElementById('bj-play-controls').style.display = 'flex';
        document.getElementById('bj-msg').style.display = 'none';
        
        // Clear board
        document.getElementById('bj-player-cards').innerHTML = '';
        document.getElementById('bj-dealer-cards').innerHTML = '';
        
        // Deal animation sequence
        await this.dealCard(this.playerHand, 'bj-player-cards', true);
        await this.dealCard(this.dealerHand, 'bj-dealer-cards', true);
        await this.dealCard(this.playerHand, 'bj-player-cards', true);
        await this.dealCard(this.dealerHand, 'bj-dealer-cards', false); // Hole card
        
        this.updateUI(false, true); // Update scores only
        
        // Check Natural Blackjack
        const pScore = this.calculate(this.playerHand);
        if (pScore === 21) {
            setTimeout(() => this.stand(), 500);
        }
    },

    dealCard(hand, containerId, faceUp) {
        return new Promise(resolve => {
            // Safety Check: Deck empty?
            if (this.deck.length === 0) this.createDeck();
            
            const card = this.deck.pop();
            if (!card) { resolve(); return; } // Should not happen after createDeck
            
            hand.push(card);
            
            const container = document.getElementById(containerId);
            if (!container) {
                console.error("Blackjack container missing:", containerId);
                resolve();
                return;
            }

            const cardEl = this.createCardElement(card);
            
            // Initial state: Face down (CSS default)
            
            container.appendChild(cardEl);
            
            // Animation
            try { AudioEngine.cardSound(); } catch(e){}
            
            if (faceUp) {
                cardEl.classList.add('deal-fly-in-up');
                // Ensure state persists after animation
                setTimeout(() => {
                    cardEl.classList.add('flipped');
                    resolve();
                }, 600);
            } else {
                cardEl.classList.add('deal-fly-in');
                setTimeout(() => {
                    resolve();
                }, 500);
            }
        });
    },
    
    async hit() {
        if (!this.active) return;
        await this.dealCard(this.playerHand, 'bj-player-cards', true);
        this.updateUI(false, true);
        
        if (this.calculate(this.playerHand) > 21) {
            setTimeout(() => this.endRound(false, "BUST!"), 500);
        }
    },
    
    async stand() {
        if (!this.active) return;
        
        // Reveal hole card
        const dealerContainer = document.getElementById('bj-dealer-cards');
        if(dealerContainer.children.length > 1) {
            dealerContainer.children[1].classList.add('flipped');
        }
        this.updateUI(true, true); // Update dealer score
        
        await new Promise(r => setTimeout(r, 600));
        
        while (this.calculate(this.dealerHand) < 17) {
            await this.dealCard(this.dealerHand, 'bj-dealer-cards', true);
            this.updateUI(true, true);
            await new Promise(r => setTimeout(r, 600));
        }
        
        const pScore = this.calculate(this.playerHand);
        const dScore = this.calculate(this.dealerHand);
        
        if (dScore > 21) {
            this.endRound(true, "DEALER BUST!");
        } else if (pScore > dScore) {
            this.endRound(true, "YOU WIN!");
        } else if (pScore === dScore) {
            this.endRound(null, "PUSH");
        } else {
            this.endRound(false, "DEALER WINS");
        }
    },
    
    endRound(win, msg) {
        this.active = false;
        let winAmount = 0;
        
        if (win === true) {
            const pScore = this.calculate(this.playerHand);
            // Blackjack pays 3:2
            if (pScore === 21 && this.playerHand.length === 2) {
                winAmount = Math.floor(this.bet * 2.5);
                msg = "BLACKJACK!";
            } else {
                winAmount = this.bet * 2;
            }
            
            // Hot Streak Bonus
            const mult = HotStreak.getMultiplier();
            if(mult > 1) {
                winAmount = Math.floor(winAmount * mult);
                app.toast(`Hot Streak Bonus! ${mult}x`, "Bonus");
            }
            HotStreak.win();
            
            app.addBalance(winAmount);
            AudioEngine.winSound();
        } else if (win === null) {
            winAmount = this.bet;
            app.addBalance(winAmount); // Return bet
        } else {
            HotStreak.loss();
        }
        
        document.getElementById('bj-result-text').textContent = msg;
        document.getElementById('bj-win-amount').textContent = winAmount > 0 ? `+ V$ ${winAmount}` : `V$ 0`;
        document.getElementById('bj-msg').style.display = 'block';
        document.getElementById('bj-play-controls').style.display = 'none';
        
        this.currentBet = 0; // Reset for next
    },
    
    reset() {
        document.getElementById('bj-msg').style.display = 'none';
        document.getElementById('bj-bet-controls').style.display = 'flex';
        this.dealerHand = [];
        this.playerHand = [];
        this.updateUI();
    },
    
    updateUI(showDealer = false, partial = false) {
        const dScore = document.getElementById('bj-dealer-score');
        const pScore = document.getElementById('bj-player-score');
        const betDisp = document.getElementById('bj-current-bet');
        
        if(betDisp) betDisp.textContent = this.currentBet;
        
        // Update Scores
        pScore.textContent = this.calculate(this.playerHand);
        
        let dealerScoreVal = 0;
        if (showDealer || !this.active) {
            dealerScoreVal = this.calculate(this.dealerHand);
            dScore.style.opacity = 1;
        } else {
            if (this.dealerHand.length > 0) {
                 dealerScoreVal = this.getCardValue(this.dealerHand[0]);
                 dScore.style.opacity = 1;
            } else {
                 dScore.style.opacity = 0;
            }
        }
        dScore.textContent = dealerScoreVal;

        document.getElementById('bj-balance').textContent = app.data.balance.toLocaleString();

        if (partial) return;

        // Full Re-render
        const pDiv = document.getElementById('bj-player-cards');
        const dDiv = document.getElementById('bj-dealer-cards');
        
        pDiv.innerHTML = '';
        this.playerHand.forEach(c => {
             const el = this.createCardElement(c);
             el.classList.add('flipped');
             pDiv.appendChild(el);
        });
        
        dDiv.innerHTML = '';
        this.dealerHand.forEach((c, i) => {
             const el = this.createCardElement(c);
             if (i === 0 || showDealer || !this.active) el.classList.add('flipped');
             // Else: Hole card stays Face Down (default CSS)
             dDiv.appendChild(el);
        });
    },
    
    renderCard(c) {
        if (!c) {
            return `<div class="bj-card"><div class="bj-card-inner"><div class="bj-card-back"></div></div></div>`;
        }
        // Legacy fallback - new logic uses createCardElement
        return this.createCardElement(c).outerHTML;
    },
    
    createCardElement(c) {
        const div = document.createElement('div');
        div.className = 'bj-card';
        const color = (c.s === 'heart' || c.s === 'diamond') ? '#ff4444' : '#000';
        div.innerHTML = `
            <div class="bj-card-inner">
                <div class="bj-card-front">
                    <div class="bj-card-content" style="color:${color}">
                        <div style="font-size:18px">${c.v}</div>
                        <svg class="bj-suit-icon"><use href="#suit-${c.s}"/></svg>
                        <div style="text-align:right;transform:rotate(180deg)">
                            <div style="font-size:18px">${c.v}</div>
                            <svg class="bj-suit-icon"><use href="#suit-${c.s}"/></svg>
                        </div>
                    </div>
                    <svg class="bj-suit-center" style="fill:${color}"><use href="#suit-${c.s}"/></svg>
                </div>
                <div class="bj-card-back"></div>
            </div>
        `;
        return div;
    }
};



/**
 * GAME APP CONTROLLER
 */
const app = {
  user: null,
  data: {
    balance: 1000,
    xp: 0,
    level: 1,
    spins: 0,
    lastWheel: 0,
    achievements: [],
    inventory: [], // Store bought item IDs
    settings: { vol: 30, theme: 'royal' },
    friends: [],
    profileCode: null,
    lastDaily: null,
    dailyProgress: 0,
    popupsSeen: []
  },
  achievementsList: [
    { id: 'first_win', title: 'First Blood', desc: 'Win your first game', icon: 'â˜…' },
    { id: 'high_roller', title: 'High Roller', desc: 'Bet V$500 in one go', icon: 'â™›' },
    { id: 'level_5', title: 'Rising Star', desc: 'Reach Level 5', icon: 'â™œ' },
    { id: 'big_winner', title: 'Jackpot', desc: 'Win over V$1000 in one spin', icon: 'â™¦' }
  ],

  enterGame() {
    document.getElementById('loader').classList.add('walk-in-active');
    setTimeout(() => {
        const loader = document.getElementById('loader');
        // Smooth fade out
        loader.style.transition = 'opacity 1s ease-out';
        loader.style.opacity = '0';
        
        setTimeout(() => {
            loader.style.display = 'none';
        }, 1000);
        
        AudioEngine.wooshSound();
    }, 3500); // Wait for walk-in animation
    AudioEngine.startMusic();
  },

  init() {
    this.load();
    this.nav('home');
    this.updateUI();
    this.renderAchievements();
    Mines.init();
    Shop.init();
    Inventory.init();
    Market.init();
    Particles.init();
    Social.init();
    Changelog.init();
    Roadmap.init();
    Daily.check();
    
    // Bind Settings
    const vol = document.getElementById('vol-slider');
    vol.value = this.data.settings.vol;
    AudioEngine.masterVol = vol.value / 100;
    vol.oninput = (e) => {
      this.data.settings.vol = e.target.value;
      AudioEngine.masterVol = e.target.value / 100;
      if(AudioEngine.musicEl) AudioEngine.musicEl.volume = AudioEngine.masterVol;
      this.save();
    };
    
    document.getElementById('music-toggle').onclick = (e) => {
      const playing = AudioEngine.toggleMusic();
      e.target.textContent = playing ? "Turn Off Music" : "Turn On Music";
      e.target.classList.toggle('secondary', !playing);
    };
  },

  load() {
    const s = localStorage.getItem('vg_session');
    if(s) {
      this.user = JSON.parse(s);
      const d = localStorage.getItem('vg_data_' + this.user.email);
      if(d) this.data = { ...this.data, ...JSON.parse(d) };
    }
  },

  save() {
    if(this.user) {
      localStorage.setItem('vg_data_' + this.user.email, JSON.stringify(this.data));
    }
  },

  closeGameInfo() {
      if (document.getElementById('game-info-check').checked) {
          this.data.popupsSeen.push(this.pendingGame);
          this.save();
      }
      document.getElementById('game-info-modal').classList.remove('active');
      this.nav(this.pendingGame, true); // Force nav
  },

  toggleAccordion(header) {
      const item = header.parentElement;
      const isActive = item.classList.contains('active');
      
      // Close all accordions in the same container
      const container = item.parentElement;
      if(container) {
          container.querySelectorAll('.accordion-item').forEach(el => el.classList.remove('active'));
      }
      
      // If it wasn't active, open it
      if (!isActive) {
          item.classList.add('active');
      }
  },

  nav(id, force = false) {
    // Game Popups
    const games = {
      'slots': { title: 'Royal Slots', desc: 'Spin the reels and match symbols to win big! Look out for 777s for the jackpot.' },
      'plinko': { title: 'Golden Plinko', desc: 'Drop the ball and watch it bounce to multipliers. High risk, high reward!' },
      'wheel': { title: 'Daily Wheel', desc: 'Spin the wheel every 24 hours for free credits. No risk, just rewards.' },
      'blackjack': { title: 'Blackjack', desc: 'Beat the dealer by getting closer to 21 without going over. Blackjack pays 3:2.' },
      'mines': { title: 'Royal Mines', desc: 'Uncover diamonds on the grid. Avoid the hidden mines to multiply your bet. Cash out anytime!' },
      'poker': { title: 'Vegas Poker', desc: 'Texas Hold\'em. Bluff your way to victory or hold the winning hand.' },
      'roulette': { title: 'Royal Roulette', desc: 'Spin the wheel! Red, Black, or Green. High stakes, instant wins.' }
    };
    
    if (!force && games[id] && (!this.data.popupsSeen || !this.data.popupsSeen.includes(id))) {
      this.pendingGame = id;
      if(!this.data.popupsSeen) this.data.popupsSeen = [];
      document.getElementById('game-info-title').textContent = games[id].title;
      document.getElementById('game-info-desc').textContent = games[id].desc;
      document.getElementById('game-info-check').checked = false;
      document.getElementById('game-info-modal').classList.add('active');
      return;
    }

    document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.game-section').forEach(el => el.style.display = 'none');
    
    if (id === 'blackjack') {
        document.getElementById('blackjack').classList.add('active');
        Blackjack.init();
    } else if (id === 'mines') {
        document.getElementById('mines').classList.add('active');
        Mines.init();
    } else if (id === 'market') {
        document.getElementById('market').classList.add('active');
        Market.render();
    } else {
        const el = document.getElementById(id);
        if(el) el.classList.add('active');
    }
    
    const sc = document.getElementById('streak-container');
    if (sc) {
      const gameIds = new Set(['slots','plinko','wheel','blackjack','mines','poker','roulette']);
      sc.style.display = gameIds.has(id) ? 'block' : 'none';
      HotStreak.updateUI();
    }
    
    // Handle auth UI visibility
    const auth = !!this.user;
    document.getElementById('auth-ui').classList.toggle('hidden', !auth);
    document.getElementById('guest-ui').classList.toggle('hidden', auth);
  },

  login() {
    const email = document.getElementById('auth-email').value;
    // Simple mock login
    if(email) {
      this.user = { email, name: email.split('@')[0] };
      localStorage.setItem('vg_session', JSON.stringify(this.user));
      this.load(); // Reload data for this user
      this.nav('home');
      this.updateUI();
      this.toast('Welcome back, ' + this.user.name);
    }
  },

  logout() {
    localStorage.removeItem('vg_session');
    this.user = null;
    this.data = { balance: 1000, gems: 0, xp: 0, level: 1, spins: 0, lastWheel: 0, achievements: [], inventory: [], settings: {vol:30, theme:'royal'} };
    this.nav('home');
    this.updateUI();
  },

  toggleAuthMode() {
    const log = document.getElementById('login-form');
    const reg = document.getElementById('register-form');
    const title = document.getElementById('auth-title');
    
    if(log.classList.contains('hidden')) {
      log.classList.remove('hidden');
      reg.classList.add('hidden');
      title.textContent = "Access Royal Club";
    } else {
      log.classList.add('hidden');
      reg.classList.remove('hidden');
      title.textContent = "Join Royal Club";
    }
  },

  register() { 
    const name = document.getElementById('reg-name').value;
    const email = document.getElementById('reg-email').value;
    const pass = document.getElementById('reg-pass').value;
    
    if(!name || !email || !pass) {
      document.getElementById('auth-msg').textContent = "Please fill all fields";
      document.getElementById('auth-msg').style.color = "var(--danger)";
      return;
    }
    
    // Create user
    this.user = { email, name };
    localStorage.setItem('vg_session', JSON.stringify(this.user));
    
    // Init data
    this.data = { balance: 2000, xp: 0, level: 1, spins: 0, lastWheel: 0, achievements: [], inventory: [], settings: {vol:30, theme:'royal'} };
    this.save();
    
    this.nav('home');
    this.updateUI();
    this.toast(`Welcome to the club, ${name}! Here is V$2000 bonus.`);
  },

  hasPerk(id) {
    return this.data.inventory && this.data.inventory.includes(id);
  },

  updateUI() {
    document.getElementById('balance-disp').textContent = this.data.balance;
    const slotBal = document.getElementById('slot-bal-disp');
    if(slotBal) slotBal.textContent = this.data.balance;
    const plinkoBal = document.getElementById('plinko-bal-disp');
    if(plinkoBal) plinkoBal.textContent = this.data.balance;
    
    document.getElementById('lvl-badge').textContent = this.data.level;
    document.getElementById('stats-lvl').textContent = this.data.level;
    document.getElementById('stats-xp').textContent = this.data.xp;
    document.getElementById('stats-spins').textContent = this.data.spins;
    
    // XP Bar logic (Level * 1000 XP required)
    const nextLvlXp = this.data.level * 1000;
    const pct = Math.min(100, (this.data.xp / nextLvlXp) * 100);
    document.getElementById('xp-fill').style.width = pct + '%';
    
    // Enhanced XP Text
    const xpText = document.getElementById('xp-text');
    if(xpText) xpText.textContent = `${this.data.xp} / ${nextLvlXp} XP`;
  },

  addXP(amount) {
    this.data.xp += amount;
    this.spawnXPParticles(amount);
    const nextLvlXp = this.data.level * 1000;
    if(this.data.xp >= nextLvlXp) {
      this.data.level++;
      this.data.xp -= nextLvlXp;
      this.toast(`LEVEL UP! You are now level ${this.data.level}`);
      this.playWin();
      this.unlockAch('level_5');
    }
    this.save();
    this.updateUI();
  },

  spawnXPParticles(amount) {
    const container = document.getElementById('xp-particles-layer');
    const barContainer = document.getElementById('xp-bar-container');
    if(!container) return;
    
    // Pulse effect
    if(barContainer) {
        barContainer.animate([
            { boxShadow: 'inset 0 2px 5px rgba(0,0,0,0.8)' },
            { boxShadow: '0 0 15px var(--gold-2), inset 0 2px 5px rgba(0,0,0,0.8)' },
            { boxShadow: 'inset 0 2px 5px rgba(0,0,0,0.8)' }
        ], {
            duration: 500,
            easing: 'ease-out'
        });
    }
    
    // Number of particles based on amount, capped
    const count = Math.min(10, Math.max(3, Math.floor(amount / 10)));
    
    for(let i=0; i<count; i++) {
      const p = document.createElement('div');
      p.className = 'xp-particle';
      // Random position along the bar
      const left = Math.random() * 100;
      p.style.left = left + '%';
      p.style.bottom = '0';
      // Random delay
      p.style.animationDelay = (Math.random() * 0.5) + 's';
      container.appendChild(p);
      
      // Remove after animation
      setTimeout(() => p.remove(), 1000);
    }
  },

  addBalance(amount) {
    this.data.balance += amount;
    this.save();
    this.updateUI();
  },

  removeBalance(amount) {
      if(this.data.balance < amount) return false;
      this.data.balance -= amount;
      this.save();
      this.updateUI();
      return true;
  },

  addGems(amount) {
      this.data.gems = (this.data.gems || 0) + amount;
      this.save();
      this.updateUI();
  },
  
  removeGems(amount) {
      if((this.data.gems || 0) < amount) return false;
      this.data.gems -= amount;
      this.save();
      this.updateUI();
      return true;
  },

  toast(msg, title="Notification") {
    const c = document.getElementById('toasts');
    const t = document.createElement('div');
    t.className = 'toast';
    t.innerHTML = `<span class="toast-title">${title}</span><span class="toast-body">${msg}</span>`;
    c.appendChild(t);
    setTimeout(() => t.remove(), 4000);
  },

  playWin() { AudioEngine.winSound(); },
  
  unlockAch(id) {
    if(!this.data.achievements.includes(id)) {
      const ach = this.achievementsList.find(a => a.id === id);
      if(ach) {
        this.data.achievements.push(id);
        this.toast(ach.title, "Achievement Unlocked!");
        this.save();
        this.renderAchievements();
      }
    }
  },

  renderAchievements() {
    const c = document.getElementById('ach-list');
    c.innerHTML = '';
    this.achievementsList.forEach(a => {
      const unlocked = this.data.achievements.includes(a.id);
      const div = document.createElement('div');
      div.className = `achievement-card ${unlocked ? 'unlocked' : ''}`;
      div.innerHTML = `<div class="ach-icon">${a.icon}</div><strong>${a.title}</strong><div style="font-size:12px">${a.desc}</div>`;
      c.appendChild(div);
    });
  }
};

/**
 * SHOP SYSTEM
 */
const Shop = {
  items: [
    { id: 'lucky_charm', name: 'Lucky Charm', desc: 'Increases Slot win chance significantly', cost: 1000, icon: 'ðŸ€' },
    { id: 'refund_ins', name: 'Refund Insurance', desc: '10% chance to refund a lost bet', cost: 2000, icon: 'ðŸ›¡ï¸' },
    { id: 'vip_card', name: 'VIP Card', desc: '10% Discount on all items', cost: 5000, icon: 'ðŸ’³' },
    { id: 'plinko_guide', name: 'Plinko Guide', desc: 'Slightly improves ball control', cost: 3000, icon: 'ðŸŽ¯' }
  ],
  
  init() { this.render(); },
  
  render() {
    const c = document.getElementById('shop-grid');
    if(!c) return;
    c.innerHTML = '';
    
    this.items.forEach(item => {
      const owned = app.hasPerk(item.id);
      let cost = item.cost;
      if(app.hasPerk('vip_card') && item.id !== 'vip_card') cost = Math.floor(cost * 0.9);
      
      const div = document.createElement('div');
      div.className = `achievement-card ${owned ? 'unlocked' : ''}`;
      div.style.opacity = '1';
      div.style.borderColor = owned ? 'var(--success)' : 'var(--gold-5)';
      
      div.innerHTML = `
        <div class="ach-icon">${item.icon}</div>
        <strong>${item.name}</strong>
        <div style="font-size:12px;margin-bottom:10px">${item.desc}</div>
        ${owned 
          ? '<button class="gold-btn secondary" disabled style="width:100%;font-size:12px;padding:5px">OWNED</button>'
          : `<button class="gold-btn" style="width:100%;font-size:12px;padding:5px" onclick="Shop.buy('${item.id}')">BUY V$${cost}</button>`
        }
      `;
      c.appendChild(div);
    });
  },
  
  buy(id) {
    const item = this.items.find(i => i.id === id);
    if(!item) return;
    if(app.hasPerk(id)) return;
    
    let cost = item.cost;
    if(app.hasPerk('vip_card') && id !== 'vip_card') cost = Math.floor(cost * 0.9);
    
    if(app.data.balance >= cost) {
      app.addBalance(-cost);
      app.data.inventory.push(id);
      app.save();
      app.toast(`Purchased ${item.name}!`, "Shop");
      app.playWin();
      this.render();
      Inventory.render();
    } else {
      app.toast("Insufficient funds", "Shop");
    }
  }
};

/**
 * INVENTORY SYSTEM
 */
const Inventory = {
  filter: 'all',
  search: '',

  init() { this.render(); },
  
  render() {
    const container = document.getElementById('inventory-grid');
    if(!container) return;
    
    // Inject Controls if not present
    let controls = document.getElementById('inv-controls');
    if(!controls) {
        controls = document.createElement('div');
        controls.id = 'inv-controls';
        controls.style.display = 'flex';
        controls.style.gap = '15px';
        controls.style.marginBottom = '20px';
        controls.style.gridColumn = '1 / -1';
        
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.className = 'form-control';
        searchInput.placeholder = 'Search items...';
        searchInput.style.flex = '1';
        searchInput.oninput = (e) => {
            this.search = e.target.value.toLowerCase();
            this.renderGrid();
        };
        
        const filterSelect = document.createElement('select');
        filterSelect.className = 'form-control';
        filterSelect.style.width = '150px';
        ['all', 'skin', 'case', 'upgrade', 'vip'].forEach(opt => {
            const o = document.createElement('option');
            o.value = opt;
            o.textContent = opt.toUpperCase();
            filterSelect.appendChild(o);
        });
        filterSelect.onchange = (e) => {
            this.filter = e.target.value;
            this.renderGrid();
        };
        
        controls.appendChild(searchInput);
        controls.appendChild(filterSelect);
        container.parentNode.insertBefore(controls, container);
    }
    
    this.renderGrid();
  },

  renderGrid() {
    const c = document.getElementById('inventory-grid');
    if(!c) return;
    c.innerHTML = '';
    
    if(!app.data.inventory || app.data.inventory.length === 0) {
      c.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:var(--text-muted);padding:40px;">Your vault is empty. Visit the Shop!</div>';
      return;
    }
    
    // Aggregate all possible items
    const allItems = [
        ...Shop.items.map(i => ({...i, type: 'upgrade', rarity: 'purple'})), 
        ...VIPShop.items.map(i => ({...i, type: 'vip', rarity: 'gold'}))
    ];

    // Map inventory IDs to item objects and add timestamp/index for sorting if needed
    // Since app.data.inventory is just an array of IDs, order is insertion order (chronological).
    // We want to reverse it to show newest first? User said "recenter the cases so they are in an chronological order".
    // Usually means Newest First or Oldest First. Let's assume Newest First is better for UI.
    // However, user specifically mentioned "cases".
    
    let inventoryItems = app.data.inventory.map((id, index) => {
        const item = allItems.find(i => i.id === id);
        return item ? { ...item, originalIndex: index } : null;
    }).filter(i => i !== null);

    // Apply Filter & Search
    inventoryItems = inventoryItems.filter(item => {
        const matchSearch = item.name.toLowerCase().includes(this.search);
        let matchFilter = true;
        if(this.filter !== 'all') {
            matchFilter = item.type === this.filter;
        }
        return matchSearch && matchFilter;
    });

    // Sorting: 
    // User asked to "recenter the cases so they are in an chronological order".
    // Let's sort by: Cases First, then Chronological (Newest First).
    inventoryItems.sort((a, b) => {
        // Prioritize Cases if filter is ALL
        if(this.filter === 'all') {
            const aIsCase = a.id.startsWith('case_');
            const bIsCase = b.id.startsWith('case_');
            if(aIsCase && !bIsCase) return -1;
            if(!aIsCase && bIsCase) return 1;
        }
        // Then Chronological (Newest First)
        return b.originalIndex - a.originalIndex;
    });

    if(inventoryItems.length === 0) {
        c.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:var(--text-muted)">No items found.</div>';
        return;
    }

    inventoryItems.forEach(item => {
      const div = document.createElement('div');
      div.className = 'achievement-card'; // Base class
      div.classList.add('unlocked');

      // Icon rendering
      const renderIcon = (icon) => {
          if(!icon) return '';
          if(icon.startsWith('icon-')) return `<svg class="ach-icon-svg" style="width:40px;height:40px;fill:currentColor"><use href="#${icon}"/></svg>`;
          return `<div class="ach-icon">${icon}</div>`;
      };

      let actionBtn = `<div style="font-size:10px;color:var(--success);margin-top:10px;text-align:center">ACTIVE</div>`;

      div.innerHTML = `
        <div style="text-align:center; margin-bottom:10px; color:${item.color || 'inherit'}">${renderIcon(item.icon)}</div>
        <div style="text-align:center">
            <strong style="color:${item.color || 'inherit'}">${item.name}</strong>
            <div style="font-size:11px; margin-top:5px; color:#aaa">${item.desc}</div>
            ${actionBtn}
        </div>
      `;
      
      c.appendChild(div);
    });
  }
};

/**
 * COMMUNITY MARKET
 */
const Market = {
  list: [],
  
  init() { 
    this.load(); 
    this.render(); 
  },
  
  // Helper to get all game items with normalized properties
  getAllItems() {
      // Base items
      const shopItems = Shop.items.map(i => ({...i, rarity: 'purple', type: 'upgrade'}));
      const vipItems = VIPShop.items.map(i => ({...i, rarity: 'gold', type: 'vip'}));
      return [...shopItems, ...vipItems];
  },

  load() {
    try {
      const s = localStorage.getItem('vg_market');
      this.list = s ? JSON.parse(s) : [];
    } catch(e) { this.list = []; }
    if(this.list.length === 0) {
      // Seed sample listings
      this.list = [
        { id: 'mk_4', skinId: 'vip_card', seller: 'vipTrader', price: 4500 } // Added sample non-skin
      ];
      this.save();
    }
  },
  
  save() {
    localStorage.setItem('vg_market', JSON.stringify(this.list));
  },
  
  render() {
    const sellC = document.getElementById('market-sell');
    const grid = document.getElementById('market-grid');
    if(!sellC || !grid) return;
    
    const allItems = this.getAllItems();

    const renderIcon = (icon) => {
        if(!icon) return '';
        if(icon.startsWith('icon-')) return `<svg style="width:30px;height:30px;fill:currentColor;vertical-align:middle"><use href="#${icon}"/></svg>`;
        return icon;
    };

    // Controls (Search & Filter)
    const controls = document.createElement('div');
    controls.style.display = 'flex';
    controls.style.gap = '10px';
    controls.style.marginBottom = '10px';
    const search = document.createElement('input');
    search.type = 'text';
    search.className = 'form-control';
    search.placeholder = 'Search market...';
    const rarity = document.createElement('select');
    rarity.className = 'form-control';
    ['all','gray','green','purple','gold','ultra'].forEach(r => {
      const opt = document.createElement('option');
      opt.value = r;
      opt.textContent = r.toUpperCase();
      rarity.appendChild(opt);
    });
    controls.appendChild(search);
    controls.appendChild(rarity);
    
    // Manage controls insertion
    if(grid.previousElementSibling && grid.previousElementSibling.querySelector('input')) {
         grid.previousElementSibling.remove();
    }
    grid.parentElement.insertBefore(controls, grid);
    
    // Sell Form
    sellC.innerHTML = '';
    // Find all owned items that are valid game items
    const ownedIds = app.data.inventory || [];
    const sellable = ownedIds.filter(id => allItems.some(x => x.id === id));

    if(sellable.length === 0) {
      sellC.innerHTML = '<div style="text-align:center;color:var(--text-muted)">No sellable items in inventory.</div>';
    } else {
      const select = document.createElement('select');
      select.className = 'form-control';
      
      const uniqueIds = [...new Set(sellable)];
      
      uniqueIds.forEach(uid => {
        const item = allItems.find(x => x.id === uid);
        const count = sellable.filter(x => x === uid).length;
        if(item) {
          const opt = document.createElement('option');
          opt.value = item.id;
          opt.textContent = `${item.name} (${item.rarity ? item.rarity.toUpperCase() : 'ITEM'}) x${count}`;
          select.appendChild(opt);
        }
      });
      
      const priceInput = document.createElement('input');
      priceInput.type = 'number';
      priceInput.className = 'form-control';
      priceInput.placeholder = 'Price (V$)';
      
      const btn = document.createElement('button');
      btn.className = 'gold-btn';
      btn.textContent = 'LIST FOR SALE';
      btn.onclick = () => {
        const itemId = select.value;
        const price = parseInt(priceInput.value, 10);
        if(!itemId || !price || price <= 0) {
          app.toast('Enter a valid price', 'Market');
          return;
        }
        // Remove ONE instance from inventory
        const idx = app.data.inventory.indexOf(itemId);
        if(idx > -1) {
            app.data.inventory.splice(idx, 1);
            app.save();
            Inventory.render(); // Update inventory view
            // Add to market
            this.list.push({ id: 'mk_' + Date.now(), skinId: itemId, seller: (app.user ? app.user.name : 'guest'), price });
            this.save();
            this.render();
            app.toast('Listed on market', 'Market');
        } else {
            app.toast('Item not found', 'Error');
        }
      };
      
      sellC.appendChild(select);
      sellC.appendChild(priceInput);
      sellC.appendChild(btn);
    }
    
    // Listings Grid
    grid.innerHTML = '';
    
    const applyFilter = () => {
      grid.innerHTML = '';
      const term = (search.value || '').toLowerCase();
      const rar = rarity.value;
      
      const filtered = this.list.filter(l => {
        const item = allItems.find(x => x.id === l.skinId);
        if(!item) return false; // Item definition missing?
        
        const okR = rar === 'all' ? true : (item.rarity === rar);
        const okT = term ? (item.name.toLowerCase().includes(term)) : true;
        return okR && okT;
      });
      
      if(filtered.length === 0) {
        grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:var(--text-muted)">No listings match.</div>';
        return;
      }
      
      filtered.forEach(l => {
        const item = allItems.find(x => x.id === l.skinId);
        if(!item) return;
        
        const div = document.createElement('div');
        div.className = `achievement-card rarity-${item.rarity || 'gray'}`;
        div.innerHTML = `
          <div style="text-align:center;margin-bottom:10px">${renderIcon(item.icon)}</div>
          <strong>${item.name}</strong>
          <div style="font-size:12px;color:#aaa">Seller: ${l.seller}</div>
          <div style="font-size:12px;margin-bottom:8px">Price: V$ ${l.price.toLocaleString()}</div>
          ${(app.user && l.seller === app.user.name) 
             ? `<button class="gold-btn secondary" style="font-size:12px;padding:6px" onclick="Market.cancel('${l.id}')">CANCEL</button>`
             : `<button class="gold-btn" style="font-size:12px;padding:6px" onclick="Market.buy('${l.id}')">BUY</button>`
          }
        `;
        grid.appendChild(div);
      });
    };
    
    search.oninput = applyFilter;
    rarity.onchange = applyFilter;
    
    if(this.list.length === 0) {
      grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:var(--text-muted)">No listings yet.</div>';
    } else {
      applyFilter();
    }
  },
  
  buy(listingId) {
    const l = this.list.find(x => x.id === listingId);
    if(!l) return;
    if(app.data.balance < l.price) {
      app.toast('Insufficient funds', 'Market');
      return;
    }
    app.addBalance(-l.price);
    app.data.inventory.push(l.skinId);
    app.save();
    Inventory.render();
    this.list = this.list.filter(x => x.id !== listingId);
    this.save();
    this.render();
    app.toast('Purchase completed', 'Market');
  },

  // Added feature: Cancel listing (return to inventory)
  cancel(listingId) {
    const l = this.list.find(x => x.id === listingId);
    if(!l) return;
    app.data.inventory.push(l.skinId);
    this.list = this.list.filter(x => x.id !== listingId);
    app.save();
    this.save();
    Inventory.render();
    this.render();
    app.toast('Listing cancelled', 'Market');
  }
};
/**
 * VIP SHOP SYSTEM
 */
const VIPShop = {
  items: [
    { id: 'bg_midnight', type: 'background', name: 'Midnight Gold', desc: 'Dark luxury wallpaper', cost: 10000, icon: 'ðŸŒƒ' },
    { id: 'bg_royal_red', type: 'background', name: 'Royal Red', desc: 'Regal velvet atmosphere', cost: 15000, icon: 'ðŸ·' },
    { id: 'bg_cash_rain', type: 'background', name: 'Cash Rain', desc: 'Money everywhere', cost: 25000, icon: 'ðŸ’¸' },
    
    { id: 'frame_gold', type: 'frame', name: 'Solid Gold Frame', desc: 'A border of pure gold', cost: 5000, icon: 'ðŸ–¼ï¸' },
    { id: 'frame_diamond', type: 'frame', name: 'Diamond Edge', desc: 'Sparkling diamond border', cost: 20000, icon: 'ðŸ’Ž' },
    { id: 'frame_neon', type: 'frame', name: 'Neon Pulse', desc: 'Cyberpunk aesthetic', cost: 12000, icon: 'ðŸ”®' },
    
    { id: 'tag_high_roller', type: 'tag', name: 'High Roller Tag', desc: 'Show your status', cost: 8000, icon: 'ðŸ·ï¸' },
    { id: 'tag_whale', type: 'tag', name: 'Whale Tag', desc: 'For the big spenders', cost: 30000, icon: 'ðŸ‹' },
    { id: 'tag_vip', type: 'tag', name: 'VIP Tag', desc: 'Exclusive club member', cost: 50000, icon: 'ðŸ‘‘' }
  ],
  
  init() { this.render(); },
  
  render() {
    const c = document.getElementById('vip-shop-grid');
    if(!c) return;
    c.innerHTML = '';
    
    this.items.forEach(item => {
      const owned = app.hasPerk(item.id);
      
      const div = document.createElement('div');
      div.className = `vip-item-card ${owned ? 'owned' : ''}`;
      
      div.innerHTML = `
        <div class="ach-icon" style="font-size:30px">${item.icon}</div>
        <div class="vip-tag">${item.type.toUpperCase()}</div>
        <strong style="color:var(--gold-2)">${item.name}</strong>
        <div style="font-size:12px;margin-bottom:10px;color:#aaa">${item.desc}</div>
        ${owned 
          ? '<button class="gold-btn secondary" disabled style="width:100%;font-size:12px;padding:5px">OWNED</button>'
          : `<button class="gold-btn" style="width:100%;font-size:12px;padding:5px" onclick="VIPShop.buy('${item.id}')">BUY V$${item.cost.toLocaleString()}</button>`
        }
      `;
      c.appendChild(div);
    });
  },
  
  buy(id) {
    const item = this.items.find(i => i.id === id);
    if(!item) return;
    if(app.hasPerk(id)) return;
    
    if(app.data.balance >= item.cost) {
      app.addBalance(-item.cost);
      app.data.inventory.push(id);
      app.save();
      app.toast(`Purchased ${item.name}!`, "VIP Shop");
      app.playWin();
      this.render();
      Cosmetics.render();
    } else {
      app.toast("Insufficient funds", "VIP Shop");
    }
  }
};

const CasesFX = {
  active: false,
  canvas: null,
  ctx: null,
  parts: [],
  start() {
    this.canvas = document.getElementById('case-fx');
    if(!this.canvas) return;
    const rect = this.canvas.getBoundingClientRect();
    this.canvas.width = rect.width * devicePixelRatio;
    this.canvas.height = rect.height * devicePixelRatio;
    this.ctx = this.canvas.getContext('2d');
    this.parts = [];
    for(let i=0;i<40;i++){
      this.parts.push({
        x: Math.random()*this.canvas.width,
        y: Math.random()*this.canvas.height,
        z: Math.random()*300 + 100,
        vx: (Math.random()-0.5)*0.6,
        vy: (Math.random()-0.5)*0.4,
        vz: (Math.random()-0.5)*2,
        c: i%3===0?'#ffd700':(i%3===1?'#9b59b6':'#2ecc71')
      });
    }
    this.active = true;
    this.loop();
  },
  stop() {
    this.active = false;
    if(this.ctx) {
      this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
    }
  },
  loop() {
    if(!this.active || !this.ctx) return;
    const w = this.canvas.width, h = this.canvas.height;
    this.ctx.clearRect(0,0,w,h);
    this.ctx.save();
    this.ctx.globalAlpha = 0.9;
    this.parts.forEach(p=>{
      p.x += p.vx; p.y += p.vy; p.z += p.vz;
      if(p.z < 80 || p.z > 420) p.vz *= -1;
      if(p.x < 0) p.x = w; if(p.x > w) p.x = 0;
      if(p.y < 0) p.y = h; if(p.y > h) p.y = 0;
      const f = 300/(p.z+300);
      const sx = p.x, sy = p.y;
      const size = 6*f*devicePixelRatio;
      this.ctx.fillStyle = p.c;
      this.ctx.beginPath();
      this.ctx.moveTo(sx, sy - size);
      this.ctx.lineTo(sx - size, sy + size);
      this.ctx.lineTo(sx + size, sy + size);
      this.ctx.closePath();
      this.ctx.fill();
    });
    this.ctx.restore();
    requestAnimationFrame(()=>this.loop());
  }
};
/**
 * COSMETICS SYSTEM
 */
const Cosmetics = {
  init() {
    if(!app.data.equipped) app.data.equipped = { background: null, frame: null, tag: null };
    this.apply();
    this.render();
  },
  
  apply() {
    // Background
    const bg = app.data.equipped.background;
    document.body.className = ''; // Reset
    if(bg) document.body.classList.add(bg.replace('_', '-')); // bg_midnight -> bg-midnight
    
    // Frames and Tags are applied in render loops (Social, Profile)
    this.updateUserPanel();
  },
  
  updateUserPanel() {
      // Add frame/tag to user panel if visible
      const badge = document.getElementById('lvl-badge');
      if(badge) {
          badge.className = 'level-badge'; // Reset
          if(app.data.equipped.frame) {
             badge.classList.add(app.data.equipped.frame.replace('_', '-'));
          }
      }
      // Tag could be added next to name if we had name display in panel, but we have auth-ui
  },
  
  equip(type, id) {
    if(app.data.equipped[type] === id) {
        // Unequip
        app.data.equipped[type] = null;
    } else {
        app.data.equipped[type] = id;
    }
    app.save();
    this.apply();
    this.render();
    app.toast("Profile Updated", "Customization");
  },
  
  render() {
    const c = document.getElementById('wardrobe-grid');
    if(!c) return;
    c.innerHTML = '';
    
    const ownedCosmetics = VIPShop.items.filter(i => app.hasPerk(i.id));
    
    if(ownedCosmetics.length === 0) {
        c.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:var(--text-muted)">You have no VIP items. Visit the VIP Boutique!</div>';
        return;
    }
    
    ownedCosmetics.forEach(item => {
        const isEquipped = app.data.equipped[item.type] === item.id;
        const div = document.createElement('div');
        div.className = `achievement-card ${isEquipped ? 'unlocked' : ''}`;
        div.style.borderColor = isEquipped ? 'var(--gold-1)' : '#333';
        
        div.innerHTML = `
            <div class="ach-icon">${item.icon}</div>
            <strong>${item.name}</strong>
            <div style="font-size:10px;text-transform:uppercase;color:#666">${item.type}</div>
            <button class="gold-btn ${isEquipped ? 'secondary' : ''}" style="width:100%;margin-top:5px;font-size:10px;padding:4px" onclick="Cosmetics.equip('${item.type}', '${item.id}')">
                ${isEquipped ? 'UNEQUIP' : 'EQUIP'}
            </button>
        `;
        c.appendChild(div);
    });
  }
};

/**
 * MINES GAME
 */
const Mines = {
    grid: [],
    minesCount: 3,
    bet: 10,
    active: false,
    gemsFound: 0,
    currentMult: 1.0,
    mineLocations: [],
    history: [],
    
    init() {
        this.renderGrid();
        this.updateUI();
        this.updateHistoryUI();
    },

    setBet(val) {
        if(this.active) return;
        if(val === 'max') val = app.data.balance;
        this.bet = Math.min(Math.max(10, parseInt(val)), app.data.balance);
        document.getElementById('mines-bet').value = this.bet;
    },

    start() {
        if(this.active) return;
        this.bet = parseInt(document.getElementById('mines-bet').value);
        this.minesCount = parseInt(document.getElementById('mines-count').value);
        
        if(this.bet > app.data.balance) { app.toast("Insufficient funds", "Mines"); return; }
        if(this.bet < 10) { app.toast("Min bet is V$10", "Mines"); return; }

        app.addBalance(-this.bet);
        this.active = true;
        this.gemsFound = 0;
        this.currentMult = 1.0;
        this.mineLocations = this.generateMines();
        this.renderGrid(); // Reset grid
        this.updateUI();
    },

    generateMines() {
        let locs = [];
        while(locs.length < this.minesCount) {
            let r = Math.floor(Math.random() * 25);
            if(!locs.includes(r)) locs.push(r);
        }
        return locs;
    },

    clickTile(idx) {
        if(!this.active) return;
        const tile = document.getElementById(`mine-tile-${idx}`);
        if(tile.classList.contains('revealed')) return;

        tile.classList.add('revealed');

        if(this.mineLocations.includes(idx)) {
            // Hit Mine
            tile.classList.add('mine');
            tile.innerHTML = 'ðŸ’£';
            this.gameOver(false);
        } else {
            // Hit Gem
            tile.classList.add('gem');
            tile.innerHTML = 'ðŸ’Ž';
            this.gemsFound++;
            this.calculateMultiplier();
            this.updateUI();
            
            if(this.gemsFound === 25 - this.minesCount) {
                this.cashout(); // Auto win all
            }
        }
    },

    calculateMultiplier() {
        // Simple multiplier logic based on probability
        // n = 25, x = mines, k = gems found
        // Prob = (25-x)/25 * (24-x)/24 ...
        // Mult = 0.99 / Prob
        
        let prob = 1;
        for(let i=0; i<this.gemsFound; i++) {
            prob *= (25 - this.minesCount - i) / (25 - i);
        }
        this.currentMult = 1 / prob; 
        // Apply house edge
        this.currentMult = this.currentMult * 0.95; 
    },

    cashout() {
        if(!this.active) return;
        let win = Math.floor(this.bet * this.currentMult);
        
        // History
        this.history.unshift(this.currentMult);
        if(this.history.length > 4) this.history.pop();
        this.updateHistoryUI();

        // Hot Streak
        const mult = HotStreak.getMultiplier();
        if(mult > 1) {
            win = Math.floor(win * mult);
            app.toast(`Hot Streak Bonus! ${mult}x`, "Bonus");
        }
        HotStreak.win();

        app.addBalance(win);
        app.toast(`Cashed out V$${win.toLocaleString()}`, "Mines");
        app.playWin();
        this.gameOver(true);
    },

    gameOver(win) {
        this.active = false;
        if(!win) HotStreak.loss();
        
        // Reveal all
        for(let i=0; i<25; i++) {
            const tile = document.getElementById(`mine-tile-${i}`);
            if(!tile.classList.contains('revealed')) {
                tile.classList.add('revealed');
                tile.style.opacity = '0.5';
                if(this.mineLocations.includes(i)) {
                    tile.innerHTML = `<svg style="width:60%;height:60%"><use href="#icon-mines"/></svg>`;
                } else {
                    tile.innerHTML = `<svg style="width:60%;height:60%"><use href="#icon-diamond"/></svg>`;
                }
            }
        }
        this.updateUI();
    },

    updateUI() {
        const startBtn = document.getElementById('mines-start-btn');
        const cashoutBtn = document.getElementById('mines-cashout-btn');
        const nextMult = document.getElementById('mines-next-mult');
        const cashoutVal = document.getElementById('mines-cashout-val');
        const balance = document.getElementById('mines-balance');
        const inputs = [document.getElementById('mines-bet'), document.getElementById('mines-count')];

        balance.textContent = app.data.balance.toLocaleString();

        if(this.active) {
            startBtn.style.display = 'none';
            cashoutBtn.style.display = 'block';
            inputs.forEach(i => i.disabled = true);
            
            const currentWin = Math.floor(this.bet * this.currentMult);
            cashoutVal.textContent = `V$ ${currentWin.toLocaleString()}`;
            
            // Calc next mult
            let prob = 1;
            for(let i=0; i<=this.gemsFound; i++) { // +1 gem
                prob *= (25 - this.minesCount - i) / (25 - i);
            }
            let nextM = (1/prob) * 0.95;
            nextMult.textContent = nextM.toFixed(2) + 'x';

        } else {
            startBtn.style.display = 'block';
            cashoutBtn.style.display = 'none';
            inputs.forEach(i => i.disabled = false);
            nextMult.textContent = "1.00x";
        }
    },

    updateHistoryUI() {
        const container = document.getElementById('mines-history');
        if(!container) return;
        
        if(!this.history || this.history.length === 0) {
            container.innerHTML = '<div style="font-size:12px; color:#444; font-style:italic">No cashouts yet</div>';
            return;
        }
        
        container.innerHTML = '';
        this.history.forEach(mult => {
            const color = mult >= 2 ? '#2ecc71' : '#e74c3c';
            const bg = mult >= 2 ? 'rgba(46, 204, 113, 0.2)' : 'rgba(231, 76, 60, 0.2)';
            
            const div = document.createElement('div');
            div.style.cssText = `
                background: ${bg};
                color: ${color};
                border: 1px solid ${color};
                padding: 5px 10px;
                border-radius: 5px;
                font-weight: bold;
                font-size: 12px;
                min-width: 50px;
                text-align: center;
                box-shadow: 0 0 5px ${bg};
            `;
            div.textContent = mult.toFixed(2) + 'x';
            container.appendChild(div);
        });
    },

    renderGrid() {
        const grid = document.getElementById('mines-grid');
        grid.innerHTML = '';
        for(let i=0; i<25; i++) {
            const btn = document.createElement('div');
            btn.id = `mine-tile-${i}`;
            btn.className = 'mine-tile';
            btn.onclick = () => this.clickTile(i);
            grid.appendChild(btn);
        }
    }
};

/**
 * POKER GAME (Simplified Texas Hold'em)
 */
const Poker = {
    deck: [],
    playerHand: [],
    communityCards: [],
    pot: 0,
    active: false,
    stage: 'preflop', // preflop, flop, turn, river, showdown
    
    init() {
        this.reset();
        this.updateUI();
    },
    
    createDeck() {
        const suits = ['â™ ', 'â™¥', 'â™£', 'â™¦'];
        const values = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
        this.deck = [];
        for (let s of suits) {
            for (let v of values) {
                let color = (s === 'â™¥' || s === 'â™¦') ? 'red' : 'black';
                this.deck.push({ s, v, color });
            }
        }
        // Shuffle
        for (let i = this.deck.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [this.deck[i], this.deck[j]] = [this.deck[j], this.deck[i]];
        }
    },
    
    reset() {
        this.active = true;
        this.pot = 0;
        this.stage = 'preflop';
        this.createDeck();
        this.playerHand = [this.deck.pop(), this.deck.pop()];
        this.communityCards = [];
        // Ante
        const ante = 50;
        if(app.data.balance >= ante) {
            app.removeBalance(ante);
            this.pot = ante * 2; // Simulate opponent matching
            app.toast("Ante paid: V$50");
        } else {
            app.toast("Insufficient funds for Ante");
            this.active = false;
        }
        this.updateUI();
    },
    
    updateUI() {
        if(!this.active) return;
        
        document.getElementById('poker-pot').textContent = this.pot.toLocaleString();
        
        // Render Player Hand
        const handEl = document.getElementById('poker-hand');
        handEl.innerHTML = '';
        this.playerHand.forEach(c => {
            handEl.innerHTML += this.renderCard(c);
        });
        
        // Render Community Cards
        const commEl = document.getElementById('poker-community');
        commEl.innerHTML = '';
        this.communityCards.forEach(c => {
            commEl.innerHTML += this.renderCard(c);
        });
        // Fill empty spots
        for(let i=this.communityCards.length; i<5; i++) {
            commEl.innerHTML += `<div class="card back" style="width:50px;height:70px;background:#333;border-radius:4px;border:1px solid #555"></div>`;
        }
        
        document.getElementById('poker-status').textContent = this.stage.toUpperCase();
    },
    
    renderCard(c) {
        return `<div class="card" style="width:50px;height:70px;background:#fff;color:${c.color};border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:bold">${c.v}${c.s}</div>`;
    },
    
    nextStage() {
        if(this.stage === 'preflop') {
            this.stage = 'flop';
            this.communityCards.push(this.deck.pop(), this.deck.pop(), this.deck.pop());
        } else if(this.stage === 'flop') {
            this.stage = 'turn';
            this.communityCards.push(this.deck.pop());
        } else if(this.stage === 'turn') {
            this.stage = 'river';
            this.communityCards.push(this.deck.pop());
        } else if(this.stage === 'river') {
            this.showdown();
            return;
        }
        this.updateUI();
    },
    
    call() {
        if(!this.active) { this.reset(); return; }
        const bet = 100;
        if(app.data.balance < bet) {
            app.toast("Insufficient funds");
            return;
        }
        app.removeBalance(bet);
        this.pot += bet * 2; // Opponent matches
        AudioEngine.chipSound();
        this.nextStage();
    },
    
    raise() {
        if(!this.active) { this.reset(); return; }
        const bet = 200; // Raise 100 on top of call
        if(app.data.balance < bet) {
            app.toast("Insufficient funds");
            return;
        }
        app.removeBalance(bet);
        this.pot += bet * 2;
        AudioEngine.chipSound();
        this.nextStage();
    },
    
    fold() {
        if(!this.active) return;
        app.toast("Folded. Pot lost.");
        this.reset();
    },
    
    showdown() {
        this.stage = 'showdown';
        this.updateUI();
        
        // Simple random win for now (50/50) + slight bias for high cards
        let winChance = 0.5;
        const hasAce = this.playerHand.some(c => c.v === 'A');
        const hasPair = this.playerHand[0].v === this.playerHand[1].v;
        if(hasAce) winChance += 0.1;
        if(hasPair) winChance += 0.2;
        
        const win = Math.random() < winChance;
        
        setTimeout(() => {
            if(win) {
                app.addBalance(this.pot);
                app.toast(`You Won V$${this.pot}!`, "Poker");
                app.playWin();
            } else {
                app.toast("Opponent Won.", "Poker");
            }
            setTimeout(() => this.reset(), 3000);
        }, 1000);
    }
};

/**
 * ROULETTE GAME
 */
const Roulette = {
    wheel: [0, 32, 15, 19, 4, 21, 2, 25, 17, 34, 6, 27, 13, 36, 11, 30, 8, 23, 10, 5, 24, 16, 33, 1, 20, 14, 31, 9, 22, 18, 29, 7, 28, 12, 35, 3, 26],
    colors: {
        0: 'green',
        // Red numbers: 1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36
        1: 'red', 3: 'red', 5: 'red', 7: 'red', 9: 'red', 12: 'red', 14: 'red', 16: 'red', 18: 'red', 19: 'red', 21: 'red', 23: 'red', 25: 'red', 27: 'red', 30: 'red', 32: 'red', 34: 'red', 36: 'red'
        // Others are black
    },
    spinning: false,
    
    init() {
        this.updateUI();
    },
    
    getColor(n) {
        if(n === 0) return 'green';
        return this.colors[n] || 'black';
    },
    
    bet(type) {
        if(this.spinning) return;
        const amountInput = document.getElementById('roulette-bet-amount');
        const amount = parseInt(amountInput.value);
        
        if(isNaN(amount) || amount <= 0) {
            app.toast("Invalid bet amount");
            return;
        }
        if(app.data.balance < amount) {
            app.toast("Insufficient funds");
            return;
        }
        
        app.removeBalance(amount);
        this.spin(type, amount);
    },
    
    spin(betType, betAmount) {
        this.spinning = true;
        const wheelEl = document.getElementById('roulette-wheel');
        const resultEl = document.getElementById('roulette-result');
        const msgEl = document.getElementById('roulette-msg');
        
        msgEl.textContent = "Spinning...";
        AudioEngine.wooshSound();
        
        // Animation
        let spins = 0;
        const interval = setInterval(() => {
            const r = Math.floor(Math.random() * 37);
            resultEl.textContent = r;
            resultEl.style.color = this.getColor(r) === 'red' ? '#ff4444' : (this.getColor(r) === 'green' ? '#00cc00' : '#fff');
            spins++;
            if(spins > 20) {
                clearInterval(interval);
                this.resolve(betType, betAmount, r);
            }
        }, 100);
    },
    
    resolve(betType, betAmount, result) {
        this.spinning = false;
        const color = this.getColor(result);
        const msgEl = document.getElementById('roulette-msg');
        
        let win = false;
        let payout = 0;
        
        if(betType === 'red' && color === 'red') {
            win = true;
            payout = betAmount * 2;
        } else if (betType === 'black' && color === 'black') {
            win = true;
            payout = betAmount * 2;
        } else if (betType === 'green' && color === 'green') {
            win = true;
            payout = betAmount * 14;
        }
        
        if(win) {
            app.addBalance(payout);
            msgEl.textContent = `WIN! +V$${payout}`;
            msgEl.style.color = "var(--success)";
            app.playWin();
        } else {
            msgEl.textContent = `LOST V$${betAmount}`;
            msgEl.style.color = "var(--danger)";
        }
    },
    
    updateUI() {
        // Nothing special to init
    }
};

/**
 * PROFILE SYSTEM
 */
const ProfileSystem = {
    logs: [],
    
    init() {
        if(app.data.profile) {
            this.logs = app.data.profile.logs || [];
        }
    },
    
    openModal() {
        if(!app.user) {
            app.toast("Please login first");
            return;
        }
        
        document.getElementById('profile-name-input').value = app.user.name;
        this.renderAvatar();
        this.renderLogs();
        document.getElementById('profile-modal').classList.add('active');
    },
    
    closeModal() {
        document.getElementById('profile-modal').classList.remove('active');
    },
    
    renderAvatar() {
        const img = document.getElementById('profile-avatar-preview');
        const ph = document.getElementById('profile-avatar-placeholder');
        
        if(app.data.profile && app.data.profile.avatar) {
            img.src = app.data.profile.avatar;
            img.style.display = 'block';
            ph.style.display = 'none';
        } else {
            img.style.display = 'none';
            ph.style.display = 'flex';
        }
    },
    
    renderLogs() {
        const c = document.getElementById('profile-audit-log');
        c.innerHTML = '';
        if(this.logs.length === 0) {
            c.innerHTML = 'No recent activity.';
            return;
        }
        this.logs.slice().reverse().forEach(log => {
            const div = document.createElement('div');
            div.style.marginBottom = '5px';
            div.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
            div.style.paddingBottom = '2px';
            div.innerHTML = `<span style="color:var(--gold-2)">[${new Date(log.ts).toLocaleTimeString()}]</span> ${log.msg}`;
            c.appendChild(div);
        });
    },
    
    log(msg) {
        this.logs.push({ ts: Date.now(), msg });
        if(this.logs.length > 50) this.logs.shift();
        
        if(!app.data.profile) app.data.profile = {};
        app.data.profile.logs = this.logs;
        app.save();
        this.renderLogs();
    },
    
    changeName() {
        const input = document.getElementById('profile-name-input');
        const err = document.getElementById('name-error');
        const newName = input.value.trim();
        
        // Validation
        err.style.display = 'none';
        if(newName.length < 2 || newName.length > 30) {
            err.textContent = "Name must be between 2 and 30 characters.";
            err.style.display = 'block';
            return;
        }
        if(!/^[a-zA-Z0-9 ]+$/.test(newName)) {
            err.textContent = "Only alphanumeric characters allowed.";
            err.style.display = 'block';
            return;
        }
        if(newName === app.user.name) {
            err.textContent = "No change detected.";
            err.style.display = 'block';
            return;
        }
        
        // Rate limit (Mock)
        const lastChange = app.data.profile ? app.data.profile.lastNamChange : 0;
        if(Date.now() - lastChange < 60000) {
             err.textContent = "Please wait 1 minute between name changes.";
             err.style.display = 'block';
             return;
        }
        
        // Payment
        if(!app.removeGems(100)) {
            app.toast("Insufficient Gems (Need 100)", "Error");
            return;
        }
        
        // Execute
        const oldName = app.user.name;
        app.user.name = newName;
        // Update session storage too
        localStorage.setItem('vg_session', JSON.stringify(app.user));
        
        if(!app.data.profile) app.data.profile = {};
        app.data.profile.lastNamChange = Date.now();
        
        app.save();
        app.updateUI(); // Update displayed name if any
        app.toast("Name updated successfully!");
        this.log(`Changed name from ${oldName} to ${newName}`);
        
        // Update welcome message if present
        // (Reload page or update specific elements not strictly required as nav handles most)
    },
    
    handleAvatarUpload(input) {
        const file = input.files[0];
        if(!file) return;
        
        // Validation
        const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
        if(!validTypes.includes(file.type)) {
            app.toast("Invalid file type. JPG, PNG, WEBP only.", "Error");
            return;
        }
        if(file.size > 2 * 1024 * 1024) { // 2MB
            app.toast("File too large. Max 2MB.", "Error");
            return;
        }
        
        // Client-side compression / resize
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_SIZE = 500;
                let width = img.width;
                let height = img.height;
                
                if (width > height) {
                    if (width > MAX_SIZE) {
                        height *= MAX_SIZE / width;
                        width = MAX_SIZE;
                    }
                } else {
                    if (height > MAX_SIZE) {
                        width *= MAX_SIZE / height;
                        height = MAX_SIZE;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                const dataUrl = canvas.toDataURL('image/jpeg', 0.7); // Compress
                
                // Save
                if(!app.data.profile) app.data.profile = {};
                app.data.profile.avatar = dataUrl;
                app.save();
                
                this.renderAvatar();
                this.log("Updated profile picture");
                app.toast("Profile picture updated!");
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
};

/**
 * SLOTS GAME
 */
const Slots = {
  icons: ['7', 'diamond', 'crown', 'bell', 'bar', 'cherry'],
  weights: [25, 30, 35, 40, 45, 60], // Extremely high win rate
  payouts: { '7': 500, 'diamond': 200, 'crown': 100, 'bell': 50, 'bar': 25, 'cherry': 10 },
  spinning: false,
  autoSpin: false,
  
  init() {
    this.reels = [document.getElementById('reel-0'), document.getElementById('reel-1'), document.getElementById('reel-2')];
    this.reels.forEach(r => this.fillReel(r));
    document.getElementById('spin-btn').onclick = () => this.spin();
    document.getElementById('auto-spin-btn').onclick = () => this.toggleAuto();
  },

  toggleAuto() {
    this.autoSpin = !this.autoSpin;
    const btn = document.getElementById('auto-spin-btn');
    if(this.autoSpin) {
      btn.classList.add('active');
      btn.textContent = "AUTO ON";
      if(!this.spinning) this.spin();
    } else {
      btn.classList.remove('active');
      btn.textContent = "AUTO OFF";
    }
  },
  
  fillReel(el) {
    let html = '';
    for(let i=0; i<30; i++) {
      const ico = this.icons[Math.floor(Math.random()*this.icons.length)];
      html += `<div class="symbol-box"><svg class="slot-icon"><use href="#icon-${ico}"/></svg></div>`;
    }
    el.innerHTML = html;
  },

  getWeightedSymbol() {
    const total = this.weights.reduce((a,b) => a+b, 0);
    let r = Math.random() * total;
    for(let i=0; i<this.weights.length; i++) {
      if(r < this.weights[i]) return this.icons[i];
      r -= this.weights[i];
    }
    return this.icons[this.icons.length-1];
  },

  async spin() {
    if(this.spinning) return;
    const bet = parseInt(document.getElementById('slot-bet').value);
    
    if(app.data.balance < bet) {
      if(this.autoSpin) this.toggleAuto();
      app.toast("Insufficient funds", "Error");
      return;
    }
    
    // Reset UI
    document.getElementById('slot-win-line').classList.remove('active');
    document.querySelector('.slot-machine-modern').classList.remove('win-glow');
    
    app.addBalance(-bet);
    if(bet >= 500) app.unlockAch('high_roller');
    
    this.spinning = true;
    document.getElementById('spin-btn').disabled = true;
    
    // Determine Result
    let result = [this.getWeightedSymbol(), this.getWeightedSymbol(), this.getWeightedSymbol()];
    
    // Perk: Lucky Charm (Force win if lost, 20% chance)
    let isWin = result[0] === result[1] && result[1] === result[2];
    if(!isWin && app.hasPerk('lucky_charm') && Math.random() < 0.2) {
      const winSym = Math.random() < 0.5 ? 'cherry' : 'bar'; // Moderate wins
      result = [winSym, winSym, winSym];
      isWin = true;
      app.toast("Lucky Charm triggered!", "Bonus");
    }

    // Perk: Refund Insurance (Refund if lost, 10% chance)
    let refund = false;
    if(!isWin && app.hasPerk('refund_ins') && Math.random() < 0.1) {
      refund = true;
    }
    
    // Animate
    await Promise.all(this.reels.map((el, i) => this.animateReel(el, result[i], i)));
    
    // Check Win
    if(isWin) {
      const mult = this.payouts[result[0]];
      let win = bet * mult;
      
      // Hot Streak
      const sMult = HotStreak.getMultiplier();
      if(sMult > 1) {
          win = Math.floor(win * sMult);
          app.toast(`Hot Streak Bonus! ${sMult}x`, "Bonus");
      }
      HotStreak.win();
      
      app.addBalance(win);
      document.getElementById('last-win').textContent = 'V$' + win;
      app.unlockAch('first_win');
      if(win >= 1000) app.unlockAch('big_winner');
      
      AudioEngine.winSound();
      document.getElementById('slot-win-line').classList.add('active');
      document.querySelector('.slot-machine-modern').classList.add('win-glow');
      
      const ov = document.getElementById('big-win');
      document.getElementById('win-overlay-val').textContent = 'V$' + win;
      ov.classList.add('active');
      setTimeout(() => ov.classList.remove('active'), 4000);
    } else {
      HotStreak.loss();
      document.getElementById('last-win').textContent = 'V$0';
      if(refund) {
        app.addBalance(bet);
        app.toast("Refund Insurance Saved You!", "Perk");
      }
    }
    
    app.data.spins++;
    app.addXP(10);
    
    this.spinning = false;
    document.getElementById('spin-btn').disabled = false;
    
    if(this.autoSpin) {
      setTimeout(() => this.spin(), 1000);
    }
  },
  
  animateReel(el, targetIcon, idx) {
    return new Promise(resolve => {
      const dur = 1000 + (idx * 500);
      el.style.transition = `transform ${dur}ms cubic-bezier(0.4, 0.0, 0.2, 1)`;
      el.style.transform = `translateY(-2000px)`; 
      
      const iv = setInterval(() => AudioEngine.spinSound(), 100);
      
      setTimeout(() => {
        clearInterval(iv);
        AudioEngine.stopSound();
        el.style.transition = 'none';
        el.style.transform = 'translateY(0)';
        
        // Insert target at top
        const d = document.createElement('div');
        d.className = 'symbol-box';
        d.innerHTML = `<svg class="slot-icon"><use href="#icon-${targetIcon}"/></svg>`;
        el.prepend(d);
        if(el.children.length > 30) el.lastElementChild.remove();
        
        // Add subtle bounce
        el.animate([
          { transform: 'translateY(0)' },
          { transform: 'translateY(-20px)' },
          { transform: 'translateY(0)' }
        ], { duration: 200 });
        
        resolve();
      }, dur);
    });
  }
};
Slots.init();

/**
 * PLINKO
 */
const Plinko = {
  cvs: document.getElementById('plinko-canvas'),
  ctx: document.getElementById('plinko-canvas').getContext('2d'),
  pegs: [],
  balls: [],
  rows: 8,
  boardCanvas: null,
  
  init() {
    this.setupBoard();
    
    // Pre-render board
    this.boardCanvas = document.createElement('canvas');
    this.boardCanvas.width = this.cvs.width;
    this.boardCanvas.height = this.cvs.height;
    this.renderStaticBoard(this.boardCanvas.getContext('2d'));
    
    this.loop();
    document.getElementById('plinko-drop').onclick = () => this.drop();
  },
  
  setupBoard() {
    this.pegs = [];
    const w = this.cvs.width;
    const h = this.cvs.height;
    const spacing = 50;
    const startY = 100;
    
    for(let r=0; r<this.rows; r++) {
      for(let c=0; c<=r; c++) {
        const x = (w/2) - (r * spacing / 2) + (c * spacing);
        const y = startY + (r * spacing);
        this.pegs.push({x, y, r: 4});
      }
    }
  },

  renderStaticBoard(ctx) {
    const mults = [0, 5, 2, 0.5, 0.2, 0.5, 2, 5, 0];
    const zoneW = 600 / mults.length;
    
    // Draw Zones
    mults.forEach((m, i) => {
        const x = i * zoneW;
        let color = 'rgba(227, 179, 65, 0.1)';
        let borderColor = '#e3b341';
        let glowColor = '#e3b341';
        
        if(m >= 5) { color = 'rgba(255, 68, 68, 0.2)'; borderColor='#ff4444'; glowColor='#ff0000'; }
        else if(m >= 2) { color = 'rgba(255, 170, 0, 0.2)'; borderColor='#ffaa00'; glowColor='#ffaa00'; }
        else if(m === 0) { color = 'rgba(51, 51, 51, 0.5)'; borderColor='#333'; glowColor='#000'; } 
        else if(m < 1) { color = 'rgba(255, 255, 68, 0.1)'; borderColor='#ffff44'; glowColor='#ffff00'; }
        
        ctx.fillStyle = color;
        ctx.fillRect(x, 460, zoneW, 40);
        
        ctx.shadowBlur = 10;
        ctx.shadowColor = glowColor;
        ctx.strokeStyle = borderColor;
        ctx.lineWidth = 2;
        ctx.strokeRect(x, 460, zoneW, 40);
        ctx.shadowBlur = 0;
        
        ctx.fillStyle = '#fff';
        ctx.font = '900 14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(m === 0 ? 'LOSE' : m + 'x', x + zoneW/2, 485);
    });
    
    // Draw Pegs (Glowing)
    ctx.shadowBlur = 5;
    ctx.shadowColor = '#fff';
    ctx.fillStyle = '#fff';
    this.pegs.forEach(p => {
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      ctx.fill();
    });
    ctx.shadowBlur = 0;
  },
  
  drop() {
    const bet = parseInt(document.getElementById('plinko-bet').value);
    if(app.data.balance < bet) { app.toast("No funds"); return; }
    app.addBalance(-bet);
    
    // Perk: Plinko Guide (Better control)
    const guide = app.hasPerk('plinko_guide');
    
    this.balls.push({
      x: this.cvs.width/2 + (Math.random()-0.5)*(guide ? 2 : 20), // Tighter drop if guided
      y: 50,
      vx: 0,
      vy: 0,
      r: 10, // Larger coin
      angle: 0,
      vAngle: (Math.random()-0.5)*0.2,
      bet: bet,
      active: true,
      guide: guide
    });
  },
  
  loop() {
    // Optimization: Skip rendering if not active
    const el = document.getElementById('plinko');
    if(!el || !el.classList.contains('active')) {
        setTimeout(() => requestAnimationFrame(() => this.loop()), 500);
        return;
    }

    this.ctx.clearRect(0,0,600,500);
    // Draw pre-rendered board
    if(this.boardCanvas) this.ctx.drawImage(this.boardCanvas, 0, 0);
    
    const time = performance.now() * 0.005;
    
    // Multipliers (9 zones for 8 rows)
    const mults = [0, 5, 2, 0.5, 0.2, 0.5, 2, 5, 0];
    const zoneW = 600 / mults.length;
    
    // Physics
    this.balls.forEach(b => {
      if(!b.active) return;
      b.vy += 0.2; 
      b.x += b.vx;
      b.y += b.vy;
      b.angle += b.vAngle;
      
      // Peg Collision
      this.pegs.forEach(p => {
        const dx = b.x - p.x;
        const dy = b.y - p.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if(dist < b.r + p.r) {
          AudioEngine.coinSound();
          const angle = Math.atan2(dy, dx);
          const speed = Math.sqrt(b.vx*b.vx + b.vy*b.vy) * 0.6;
          
          // Guide reduces chaos
          const chaos = b.guide ? 0.2 : 1.0;
          b.vx = Math.cos(angle) * speed + (Math.random()-0.5) * chaos;
          b.vy = Math.sin(angle) * speed;
          b.y += Math.sin(angle) * (b.r + p.r - dist);
        }
      });
      
      // Draw Coin
      this.drawCoin(b);
      
      // Floor
      if(b.y > 460) {
        b.active = false;
        const col = Math.floor(b.x / zoneW);
        // If out of bounds completely
        if(col < 0 || col >= mults.length) {
            app.toast("Ball fell out of bounds!", "Loss");
            return;
        }
        
        const m = mults[col];
        const win = Math.floor(b.bet * m);
        
        if(win > 0) {
          // Hot Streak
          if(m > 1) {
              const sMult = HotStreak.getMultiplier();
              let bonus = 0;
              if(sMult > 1) {
                  bonus = Math.floor(win * sMult) - win;
                  app.toast(`Hot Streak Bonus! ${sMult}x`, "Bonus");
              }
              HotStreak.win();
              app.addBalance(win + bonus);
          } else if(m < 1) {
              HotStreak.loss();
              app.addBalance(win);
          } else {
              app.addBalance(win); // Push
          }

          app.toast(`Plinko Win: V$${win}`);
          AudioEngine.winSound();
        } else {
            HotStreak.loss();
            app.toast(`Plinko: No win (${m}x)`);
        }
      }
    });
    
    requestAnimationFrame(() => this.loop());
  },

  drawCoin(b) {
    const ctx = this.ctx;
    ctx.save();
    ctx.translate(b.x, b.y);
    ctx.rotate(b.angle);
    
    // Glow
    ctx.shadowBlur = 15;
    ctx.shadowColor = '#ffd700';
    
    // Gold Coin Body
    ctx.beginPath();
    ctx.arc(0, 0, b.r, 0, Math.PI*2);
    ctx.fillStyle = '#fffbe3';
    ctx.fill();
    
    // Rim
    ctx.lineWidth = 2;
    ctx.strokeStyle = '#ffd700';
    ctx.stroke();
    
    // Inner Ring
    ctx.shadowBlur = 0;
    ctx.beginPath();
    ctx.arc(0, 0, b.r * 0.7, 0, Math.PI*2);
    ctx.strokeStyle = '#DAA520';
    ctx.lineWidth = 1;
    ctx.stroke();
    
    // Text
    ctx.fillStyle = '#DAA520';
    ctx.font = 'bold 10px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('V$', 0, 1);
    
    ctx.restore();
  }
};
Plinko.init();

/**
 * WHEEL
 */
const Wheel = {
  cvs: document.getElementById('wheel-canvas'),
  ctx: document.getElementById('wheel-canvas').getContext('2d'),
  prizes: [100, 0, 50, 0, 500, 0, 200, 1000],
  angle: 0,
  lastTick: 0,
  wheelImage: null,
  
  init() {
    this.preRender();
    this.draw();
    setInterval(() => this.updateTimer(), 1000);
    document.getElementById('wheel-spin-btn').onclick = () => this.spin();
  },
  
  preRender() {
    this.wheelImage = document.createElement('canvas');
    this.wheelImage.width = 400;
    this.wheelImage.height = 400;
    const ctx = this.wheelImage.getContext('2d');
    const cx = 200, cy = 200, r = 190;
    const arc = (Math.PI*2) / this.prizes.length;
    
    ctx.translate(cx, cy);
    
    this.prizes.forEach((p, i) => {
      ctx.beginPath();
      ctx.moveTo(0,0);
      ctx.arc(0, 0, r, i*arc, (i+1)*arc);
      ctx.fillStyle = i % 2 === 0 ? '#e3b341' : '#222';
      ctx.fill();
      ctx.stroke();
      
      ctx.save();
      ctx.rotate(i*arc + arc/2);
      ctx.fillStyle = i % 2 === 0 ? '#000' : '#e3b341';
      ctx.font = 'bold 20px Arial';
      ctx.fillText(p === 0 ? 'LOSE' : 'V$'+p, 60, 10);
      ctx.restore();
    });
  },
  
  draw() {
    const ctx = this.ctx;
    ctx.clearRect(0,0,400,400);
    ctx.save();
    ctx.translate(200, 200);
    ctx.rotate(this.angle);
    
    if(this.wheelImage) {
        ctx.drawImage(this.wheelImage, -200, -200);
    }
    
    ctx.restore();
    
    // Pointer
    // Removed right arrow as requested
  },
  
  spin() {
    const now = Date.now();
    const cd = 24*60*60*1000;
    if(now - app.data.lastWheel < cd) {
      app.toast("Come back tomorrow!", "Cooldown");
      return;
    }
    
    let vel = 0.5 + Math.random()*0.5;
    let friction = 0.99;
    let lastAngle = this.angle;
    const seg = (Math.PI*2) / this.prizes.length;
    
    const loop = () => {
      this.angle += vel;
      vel *= friction;
      this.draw();
      
      // Tick Sound
      if(Math.floor(this.angle / seg) !== Math.floor(lastAngle / seg)) {
        AudioEngine.tickSound();
      }
      lastAngle = this.angle;
      
      if(vel > 0.002) {
        requestAnimationFrame(loop);
      } else {
        // Stopped
        app.data.lastWheel = Date.now();
        app.save();
        
        // Calc prize based on angle
        const normAngle = this.angle % (Math.PI*2);
        // Pointer is at 0 (right side) visually, but rotation is canvas rotation.
        // Actually, pointer is at 0 rad (right).
        // If canvas rotates +angle, the prize at -angle is at pointer.
        // Index = (Total - (angle % 2PI) / seg) % Total
        // Simplified: Random prize is fine for now as per previous logic, but let's try to match.
        // Let's just stick to random for safety or map it.
        // Given user didn't ask to fix wheel logic, I will keep the random prize but maybe sync it later.
        // Actually, I'll just pick a random prize to be safe.
        const prize = this.prizes[Math.floor(Math.random()*this.prizes.length)];
        
        if(prize > 0) {
          app.addBalance(prize);
          app.toast(`Wheel Prize: V$${prize}`);
          AudioEngine.winSound();
        } else {
          app.toast("Better luck next time!");
        }
        this.updateTimer();
      }
    };
    loop();
  },
  
  updateTimer() {
    const now = Date.now();
    const next = app.data.lastWheel + 24*60*60*1000;
    const diff = next - now;
    const el = document.getElementById('wheel-timer');
    if(diff <= 0) {
      el.textContent = "READY TO SPIN";
      document.getElementById('wheel-spin-btn').disabled = false;
    } else {
      const h = Math.floor(diff / 3600000);
      const m = Math.floor((diff % 3600000) / 60000);
      el.textContent = `Next spin in ${h}h ${m}m`;
      document.getElementById('wheel-spin-btn').disabled = true;
    }
  }
};
Wheel.init();

/**
 * PARTICLES (Golden Sparkles & Bills)
 */
const Particles = {
  list: [],
  cvs: null,
  ctx: null,
  w: 0, 
  h: 0,
  billCvs: null,
  frameCount: 0,

  init() {
    this.cvs = document.getElementById('bg-canvas');
    this.ctx = this.cvs.getContext('2d');
    
    // Low Quality Mode: Half resolution for retina screens not needed, just standard
    // Actually, let's keep full res but fewer particles and frame skipping
    const resize = () => { this.w=this.cvs.width=window.innerWidth; this.h=this.cvs.height=window.innerHeight; };
    window.onresize = resize;
    resize();
    
    // Pre-render Bill
    this.billCvs = document.createElement('canvas');
    this.billCvs.width = 100;
    this.billCvs.height = 50;
    const bCtx = this.billCvs.getContext('2d');
    
    const grad = bCtx.createLinearGradient(0, 0, 100, 50);
    grad.addColorStop(0, '#2ecc71');
    grad.addColorStop(0.5, '#f1c40f');
    grad.addColorStop(1, '#27ae60');
    bCtx.fillStyle = grad;
    bCtx.fillRect(0, 0, 100, 50);
    
    bCtx.strokeStyle = 'rgba(255,255,255,0.4)';
    bCtx.lineWidth = 2;
    bCtx.strokeRect(2, 2, 96, 46);
    
    bCtx.fillStyle = 'rgba(0,50,0,0.5)';
    bCtx.font = '700 28px "Cinzel"';
    bCtx.textAlign = 'center';
    bCtx.textBaseline = 'middle';
    bCtx.fillText('V$', 50, 25);

    // Initialize pool - REDUCED COUNT FOR PERFORMANCE
    for(let i=0; i<15; i++) this.createParticle(Math.random() * this.h);
    
    this.loop();
  },

  createParticle(yOverride) {
      const isBill = Math.random() > 0.6;
      let p;
      if(isBill) {
          p = {
              type: 'bill',
              x: Math.random() * this.w,
              y: yOverride !== undefined ? yOverride : -100,
              w: 60 + Math.random() * 30,
              h: 30 + Math.random() * 15,
              vy: 1.5 + Math.random() * 2,
              vr: (Math.random() - 0.5) * 0.05,
              angle: Math.random() * Math.PI * 2,
              sway: Math.random() * Math.PI,
              swaySpeed: 0.02 + Math.random() * 0.03
          };
      } else {
          p = {
              type: 'sparkle',
              x: Math.random() * this.w,
              y: yOverride !== undefined ? yOverride : Math.random() * this.h,
              size: 2 + Math.random() * 4,
              vy: 0.5 + Math.random(),
              alpha: Math.random(),
              fadeSpeed: 0.005 + Math.random() * 0.01
          };
      }
      this.list.push(p);
  },

  spawnExplosion(x, y) {
      for(let i=0; i<30; i++) {
          this.list.push({
              type: 'explosion',
              x: x,
              y: y,
              vx: (Math.random() - 0.5) * 15,
              vy: (Math.random() - 0.5) * 15,
              size: 5 + Math.random() * 10,
              alpha: 1,
              decay: 0.02 + Math.random() * 0.03,
              color: Math.random() > 0.5 ? '#ffd700' : '#ff4500'
          });
      }
  },

  loop() {
      if(document.hidden) {
          setTimeout(() => requestAnimationFrame(() => this.loop()), 500);
          return;
      }

      // PERFORMANCE: Skip every other frame (30fps cap)
      this.frameCount++;
      if(this.frameCount % 2 !== 0) {
          requestAnimationFrame(() => this.loop());
          return;
      }

      this.ctx.clearRect(0,0,this.w,this.h);
      
      for(let i = this.list.length - 1; i >= 0; i--) {
        let p = this.list[i];
        
        if(p.type === 'explosion') {
            p.x += p.vx;
            p.y += p.vy;
            p.vx *= 0.95;
            p.vy *= 0.95;
            p.alpha -= p.decay;
            
            if(p.alpha <= 0) {
                this.list.splice(i, 1);
                continue;
            }
            
            this.ctx.globalAlpha = p.alpha;
            this.ctx.fillStyle = p.color;
            this.ctx.beginPath();
            this.ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
            this.ctx.fill();
            this.ctx.globalAlpha = 1.0;
            continue;
        }

        // Double speed since we skip frames, to keep perceived speed similar
        p.y += p.vy * 2; 
        
        if(p.type === 'bill') {
            p.angle += p.vr * 2;
            p.sway += p.swaySpeed * 2;
            p.x += Math.sin(p.sway) * 1.5;
            
            if(p.y > this.h + 100) {
                this.list.splice(i, 1);
                this.createParticle(-100);
                continue;
            }
            
            this.ctx.save();
            this.ctx.translate(p.x, p.y);
            this.ctx.rotate(p.angle);
            this.ctx.drawImage(this.billCvs, -p.w/2, -p.h/2, p.w, p.h);
            this.ctx.restore();
        } else {
            p.alpha -= p.fadeSpeed * 2;
            if(p.alpha <= 0 || p.y > this.h) {
                this.list.splice(i, 1);
                this.createParticle(-10);
                continue;
            }
            
            this.ctx.globalAlpha = p.alpha;
            this.ctx.fillStyle = '#ffd700';
            this.ctx.beginPath();
            this.ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
            this.ctx.fill();
            this.ctx.globalAlpha = 1.0;
        }
      }
      
      // Maintain minimum ambient particles - REDUCED
      while(this.list.length < 15) {
          this.createParticle(-10);
      }
      
      requestAnimationFrame(() => this.loop());
  }
};

Particles.init();
VIPShop.init();
Cosmetics.init();

app.init();
</script>
</body>
</html>
